module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/home/epaminond/private/projects/2015.08.08_keenethics/projects/botpress/botpress/packages/core/botpress",r(r.s=129)}([function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(module,exports,__webpack_require__){"use strict";var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_chalk=__webpack_require__(7),_chalk2=_interopRequireDefault(_chalk),_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_module=__webpack_require__(120),_module2=_interopRequireDefault(_module),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_knex=__webpack_require__(22),_knex2=_interopRequireDefault(_knex),_generate=__webpack_require__(119),_generate2=_interopRequireDefault(_generate);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var IS_DEV=eval("process.env.NODE_ENV !== 'production'"),NPM_CMD=/^win/.test(process.platform)?"npm.cmd":"npm",PRINT_LEVELS={info:_chalk2.default.white,warn:_chalk2.default.yellow.bind(_chalk2.default,"WARN"),error:_chalk2.default.red.bind(_chalk2.default,"ERR"),success:_chalk2.default.green.bind(_chalk2.default,"OK")},print=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];var o=PRINT_LEVELS[e];o||(r=[e].concat(r),o=PRINT_LEVELS.info),console.log(_chalk2.default.black.bgWhite("[botpress]"),"\t",o.apply(void 0,_toConsumableArray(r)))};Object.keys(PRINT_LEVELS).forEach(function(e){print[e]=function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return print.apply(void 0,[e].concat(r))}});var resolveFromDir=function(e,t){e=_path2.default.resolve(e);var r=_path2.default.join(e,"noop.js");try{return _module2.default._resolveFilename(t,{id:r,filename:r,paths:_module2.default._nodeModulePaths(e)})}catch(e){return null}},resolveModuleRootPath=function(e){for(var t=_path2.default.dirname(e);"/"!==t;){var r=_path2.default.join(t,"package.json");if(_fs2.default.existsSync(r))return t;t=_path2.default.resolve(_path2.default.join(t,".."))}return null},resolveProjectFile=function(e,t,r){var n=_path2.default.resolve(t||"./",e);if(!_fs2.default.existsSync(n)){if(r)throw new Error("Could not find bot's package.json file");return null}return n},getDataLocation=function(e,t){return e&&_path2.default.isAbsolute(e)?_path2.default.resolve(e):_path2.default.resolve(t,e||"data")},getBotpressVersion=function(){var e=_path2.default.join(__dirname,"../package.json");return JSON.parse(_fs2.default.readFileSync(e)).version},collectArgs=function(e,t){return t.push(e),t},getInMemoryDb=function(){return(0,_knex2.default)({client:"sqlite3",connection:":memory:",pool:{min:1,max:1,disposeTiemout:36e7,idleTimeoutMillis:36e7},useNullAsDefault:!0})},safeId=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;return(0,_generate2.default)("1234567890abcdefghijklmnopqrsuvwxyz",e)},isBotpressPackage=function(e){var t=getPackageName(e),r=_slicedToArray(t,2),n=r[0],o=r[1];return"botpress"===n||o.startsWith("botpress-")},getModuleShortname=function(e){var t=getPackageName(e);return _slicedToArray(t,2)[1].replace(/^botpress-/i,"")},getPackageName=function(e){if(e.startsWith("@")){var t=e.match(/^@(.*)\/(.*)/).slice(1),r=_slicedToArray(t,2);return[r[0],r[1]]}return[null,e]};module.exports={print:print,resolveFromDir:resolveFromDir,isDeveloping:IS_DEV,resolveModuleRootPath:resolveModuleRootPath,resolveProjectFile:resolveProjectFile,getDataLocation:getDataLocation,npmCmd:NPM_CMD,getBotpressVersion:getBotpressVersion,collectArgs:collectArgs,getInMemoryDb:getInMemoryDb,safeId:safeId,isBotpressPackage:isBotpressPackage,getModuleShortname:getModuleShortname}},function(e,t){e.exports=require("bluebird")},function(e,t,r){"use strict";var n,o=r(10),a=(n=o)&&n.__esModule?n:{default:n};var i=function(e){return"sqlite3"===e.client.config.client};e.exports=function(e){var t=function(t){return i(e)?e.raw("strftime('%Y-%m-%dT%H:%M:%fZ', "+t+")"):e.raw(t)},r=function(e){var r=(0,a.default)(e).toDate().toISOString();return t("'"+r+"'")},n=function(n){var o=i(e);return n.sql?n.sql:"string"==typeof n?o?t(n):'"'+n+'"':r(n)};return{isLite:function(){return i(e)},createTableIfNotExists:function(t,r){return e.schema.hasTable(t).then(function(n){if(!n)return e.schema.createTableIfNotExists(t,r)})},date:{format:r,now:function(){return i(e)?e.raw("strftime('%Y-%m-%dT%H:%M:%fZ', 'now')"):e.raw("now()")},isBefore:function(t,r){return t=n(t),r=n(r),e.raw(t+" < "+r)},isAfter:function(t,r){return t=n(t),r=n(r),e.raw(t+" > "+r)},isBetween:function(t,r,o){return t=n(t),r=n(r),o=n(o),e.raw(t+" BETWEEN "+r+" AND "+o)},isSameDay:function(t,r){return t=n(t),r=n(r),e.raw("date("+t+") = date("+r+")")},hourOfDay:function(t){return t=n(t),i(e)?e.raw("strftime('%H', "+t+")"):e.raw("to_char("+t+", 'HH24')")}},bool:{true:function(){return!i(e)||1},false:function(){return!!i(e)&&0},parse:function(t){return i(e)?!!t:t}},json:{set:function(t){return i(e)?t&&JSON.stringify(t):t},get:function(t){return i(e)?t&&JSON.parse(t):t}}}}},function(e,t){e.exports=require("ms")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("glob")},function(e,t){e.exports=require("mkdirp")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("nanoid")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("os")},function(e,t,r){"use strict";var n=u(r(13)),o=u(r(42)),a=u(r(123)),i=r(122);function u(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=null,r=[];(0,i.machineId)().catch(function(){var e=o.default.createHash("sha256");return e.update(n.default.arch()+n.default.hostname()+n.default.platform()+n.default.type()),e.digest("hex")}).then(function(e){t=(0,a.default)("UA-90044826-1",e,{strictCidFormat:!1}),r.forEach(function(e){return e()}),r=[]});return{track:function n(o,a){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;e.optOutStats||(t?t.event(o,a,i,u,function(){}):r.push(function(){return n(o,a,i,u)}))},trackException:function n(o){e.optOutStats||(t?t.event(o,function(){}):r.push(function(){return n(o)}))}}}},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";var n,o=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(0),i=(n=a)&&n.__esModule?n:{default:n};var u=function(e,t){i.default.isPlainObject(e)||(e={text:e});var r=i.default.toPairs(e);return i.default.every(r,function(e){var r=o(e,2),n=r[0],a=r[1],u=i.default.get(t,n,null);if(i.default.isFunction(a))return!0===a(u,t);if(i.default.isRegExp(a)){var s=a.test(u);if(s&&i.default.isString(u))i.default.isNil(t.captured)&&(t.captured=[]),i.default.tail(a.exec(u)).forEach(function(e){return t.captured.push(e)});return s}return i.default.isEqual(a,u)})};e.exports={hear:function(e,t){return function(r,n){var o=!1;if(i.default.isFunction(e))o=e(r);else if(i.default.isArray(e)){var a=!0,s=!1,c=void 0;try{for(var l,f=e[Symbol.iterator]();!(a=(l=f.next()).done);a=!0){var d=l.value;if(u(d,r)){o=!0;break}}}catch(e){s=!0,c=e}finally{try{!a&&f.return&&f.return()}finally{if(s)throw c}}}else o=u(e,r);o&&i.default.isFunction(t)?t.length<=1?(i.default.isFunction(n)&&n(),t(r)):t(r,n):i.default.isFunction(n)&&n()}},matches:u}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();function o(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Object.assign(this,t)}return n(e,[{key:"login",value:function(){throw new Error("Abstract Class: Needs to be implemented")}},{key:"refreshToken",value:function(){throw new Error("Abstract Class: Needs to be implemented")}},{key:"authenticate",value:function(){var e=o(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.authenticateWithError(t);case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),this.logger.debug("[Login]",e.t0.message),e.abrupt("return",!1);case 10:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()},{key:"authenticateWithError",value:function(){var e=o(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Abstract Class: Needs to be implemented");case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getUserIdentity",value:function(){throw new Error("Abstract Class: Needs to be implemented")}},{key:"getAuthenticationInfo",value:function(){throw new Error("Abstract Class: Needs to be implemented")}},{key:"getJWTSecretOrCertificate",value:function(){throw new Error("Abstract Class: Needs to be implemented")}}]),e}();t.default=a},function(e,t){e.exports=require("mware")},function(module,exports,__webpack_require__){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_bluebird=__webpack_require__(4),_bluebird2=_interopRequireDefault(_bluebird),_lodash=__webpack_require__(0),_lodash2=_interopRequireDefault(_lodash),_axios=__webpack_require__(12),_axios2=_interopRequireDefault(_axios),_helpers=__webpack_require__(40),_helpers2=_interopRequireDefault(_helpers),_util=__webpack_require__(3),_util2=_interopRequireDefault(_util);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new _bluebird2.default(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return _bluebird2.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}module.exports=function(logger,projectLocation,dataLocation,configManager){var loadModules=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(moduleDefinitions,botpress){var loadedCount,loadedModules;return regeneratorRuntime.wrap(function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return loadedCount=0,loadedModules={},_context2.next=4,_bluebird2.default.mapSeries(moduleDefinitions,function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(mod){var loader,configuration;return regeneratorRuntime.wrap(function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:loader=null,_context.prev=1,loader=eval("require")(mod.entry),_context.next=8;break;case 5:return _context.prev=5,_context.t0=_context.catch(1),_context.abrupt("return",logger.error('Error loading module "'+mod.name+'": '+_context.t0.message));case 8:if("object"===(void 0===loader?"undefined":_typeof(loader))){_context.next=10;break}return _context.abrupt("return",logger.warn("Ignoring module "+mod.name+". Invalid entry point signature."));case 10:return mod.handlers=loader,_context.prev=11,configuration=configManager.getModuleConfiguration({name:mod.name,options:loader.config,path:mod.root}),_context.next=15,configuration.isConfigMissing();case 15:if(!_context.sent){_context.next=18;break}return _context.next=18,configuration.bootstrap();case 18:mod.configuration=configuration,_context.next=24;break;case 21:_context.prev=21,_context.t1=_context.catch(11),logger.error("Invalid module configuration in module "+mod.name+":",_context.t1);case 24:if(_context.prev=24,_context.t2=loader.init,!_context.t2){_context.next=29;break}return _context.next=29,loader.init(botpress,mod.configuration,_helpers2.default);case 29:_context.next=34;break;case 31:_context.prev=31,_context.t3=_context.catch(24),logger.warn("Error during module initialization: ",_context.t3);case 34:loadedModules[mod.name]=mod,logger.info("Loaded "+mod.name+", version "+mod.version),loadedCount++;case 37:case"end":return _context.stop()}},_callee,void 0,[[1,5],[11,21],[24,31]])}));return function(e){return _ref2.apply(this,arguments)}}());case 4:return loadedCount>0&&logger.info("Loaded "+loadedCount+" modules"),_context2.abrupt("return",loadedModules);case 6:case"end":return _context2.stop()}},_callee2,void 0)}));return function(e,t){return _ref.apply(this,arguments)}}(),scanModules=function scanModules(){var packagePath=_path2.default.join(projectLocation,"package.json");if(!_fs2.default.existsSync(packagePath))return logger.warn("No package.json found at project root, which means botpress can't load any module for the bot.");var botPackage=eval("require")(packagePath),deps=botPackage.dependencies||{};return _util.isDeveloping&&(deps=_lodash2.default.merge(deps,botPackage.devDependencies||{})),_lodash2.default.reduce(deps,function(result,value,key){if(!_util2.default.isBotpressPackage(key))return result;var entry=(0,_util.resolveFromDir)(projectLocation,key);if(!entry)return result;var root=(0,_util.resolveModuleRootPath)(entry);if(!root)return result;var modulePackage=eval("require")(_path2.default.join(root,"package.json"));return modulePackage.botpress?result.push({name:key,root:root,homepage:modulePackage.homepage,settings:modulePackage.botpress,version:modulePackage.version,entry:entry})&&result:result},[])},listInstalledModules=function(){var e=(0,_util.resolveProjectFile)("package.json",projectLocation,!0),t=JSON.parse(_fs2.default.readFileSync(e)).dependencies,r=_lodash2.default.keys(t);return _lodash2.default.filter(r,_util2.default.isBotpressPackage)},getRandomCommunityHero=_bluebird2.default.method(function(){return _axios2.default.get("https://api.github.com/repos/botpress/botpress/contributors").then(function(e){var t=e.data,r=_lodash2.default.sample(t);return{username:r.login,github:r.html_url,avatar:r.avatar_url,contributions:r.contributions,module:"botpress"}}).catch(function(){return _bluebird2.default.resolve({username:"danyfs",github:"https://github.com/danyfs",avatar:"https://avatars1.githubusercontent.com/u/5629987?v=3",contributions:"many",module:"botpress"})})});return{getRandomCommunityHero:getRandomCommunityHero,listInstalled:listInstalledModules,_scan:scanModules,_load:loadModules}}},function(e,t){e.exports=require("prompt-confirm")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("knex")},function(e,t){e.exports=require("prompt")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateFlowSchema=void 0;var n,o=r(0),a=(n=o)&&n.__esModule?n:{default:n};t.validateFlowSchema=function(e){var t='[Flow] Invalid flow "'+(e&&e.location)+'"';if(!e||!a.default.isObjectLike(e))return"Invalid JSON flow schema";if(!e.version||!a.default.isString(e.version))return t+", expected valid version but found none";if(!e.version.startsWith("0."))return t+', unsupported version of the schema "'+e.version+'"';if(!a.default.isString(e.startNode))return t+", expected valid 'startNode'";if(!a.default.isArray(e.nodes))return t+", expected 'nodes' to be an array of nodes";if(!a.default.find(e.nodes,{name:e.startNode}))return t+", expected 'startNode' to point to a valid node name";if(e.catchAll&&e.catchAll.onEnter)return t+', "catchAll" does not support "onEnter"';var r=!0,n=!1,o=void 0;try{for(var i,u=e.nodes[Symbol.iterator]();!(r=(i=u.next()).done);r=!0){var s=i.value;if(!a.default.isString(s.id)||s.id.length<=3)return t+", expected node "+s.id+" ("+s.name+") to have a valid id"}}catch(e){n=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(n)throw o}}}},function(e,t){e.exports=require("yn")},function(e,t){e.exports=require("eventemitter2")},function(e,t){e.exports=require("json5")},function(e,t){e.exports=require("mustache")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("winston")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeFolder=void 0;var n,o=r(1),a=(n=o)&&n.__esModule?n:{default:n};t.normalizeFolder=function(e){return function(t){var r=a.default.resolve(e,t);return{folderPath:r,normalizedFolderName:a.default.relative(e,r)}}}},function(e,t,r){"use strict";var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=m(r(1)),i=m(r(2)),u=m(r(4)),s=m(r(8)),c=m(r(35)),l=m(r(108)),f=m(r(34)),d=m(r(107)),p=m(r(106)),h=r(32),g=r(3);function m(e){return e&&e.__esModule?e:{default:e}}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function v(e){return function(){var t=e.apply(this,arguments);return new u.default(function(e,r){return function n(o,a){try{var i=t[o](a),s=i.value}catch(e){return void r(e)}if(!i.done)return u.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}u.default.promisifyAll(i.default);var b=u.default.promisify(s.default);e.exports=function(e){var t=e.logger,r=e.db,s=e.projectLocation;if(!e.enabled)return(0,p.default)({logger:t,projectLocation:s});var m,w,y,x,k,R,E,j,S,I=(0,h.normalizeFolder)(s),D={},P=[],O={},C=function(e){var t=e.knex,r=e.tableName,a=e.where,i=e.data,u=e.idField,s=void 0===u?"id":u,l=e.trx,f=void 0===l?null:l,d=function(){return f?t(r).transacting(f):t(r)};return d().where(a).select(s).then(function(e){var t=(0,c.default)(e,"0.id");return t?d().where(s,t).update(i).thenReturn(t):d().insert(o({},a,i),"id").then(function(e){return n(e,1)[0]})})},q=(m=v(regeneratorRuntime.mark(function e(t,n,o){var u,s,c,l=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{}).isBinary,f=void 0!==l&&l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return u=e.sent,s=a.default.join(t,o),c=f?"binary_content":"content",e.next=7,i.default.readFileAsync(s,f?null:"utf8").then(function(e){return C({knex:u,tableName:"ghost_content",where:{folder:n,file:o},data:_({},c,e)})});case 7:case"end":return e.stop()}},e,void 0)})),function(e,t,r){return m.apply(this,arguments)}),A=(w=v(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return n=e.sent,e.abrupt("return",n("ghost_revisions").join("ghost_content","ghost_content.id","=","ghost_revisions.content_id").where("ghost_content.folder",t).select("ghost_content.file","ghost_revisions.id","ghost_revisions.revision","ghost_revisions.created_on","ghost_revisions.created_by").orderBy("ghost_revisions.created_on","desc").then());case 4:case"end":return e.stop()}},e,void 0)})),function(e){return w.apply(this,arguments)}),T=(y=v(regeneratorRuntime.mark(function e(o){var s,c,f,d,p,h,g,m,_,v,w,y,x,k,R,E,j,S,C,T=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=I(o),c=s.folderPath,f=s.normalizedFolderName,d=T.isBinary,p=void 0!==d&&d,h=T.filesGlob,g=void 0===h?"**/*":h,t.debug("[Ghost Content Manager] adding folder "+f),P.push(f),O[f]=T,m=a.default.join(c,".ghost-revisions"),_=i.default.readFileAsync(m,"utf8").catch({code:"ENOENT"},function(){return""}).then(function(e){return e.trim().split("\n").map(function(e){return e.trim()}).filter(function(e){return!!e&&!e.startsWith("#")}).reduce(function(e,t){return e[t]=!0,e},{})}),e.next=9,u.default.all([_,A(f)]);case 9:return v=e.sent,w=n(v,2),y=w[0],x=w[1],k=(0,l.default)(x,function(e){var t=e.revision;return y[t]}),R=n(k,2),E=R[0],j=R[1],e.next=16,r.get();case 16:if(S=e.sent,!E.length){e.next=21;break}return t.debug("[Ghost Content Manager] "+f+": deleting "+E.length+" known revision(s)."),e.next=21,S("ghost_revisions").whereIn("id",E.map(function(e){return e.id})).del();case 21:if(!j.length){e.next=25;break}return t.debug("[Ghost Content Manager] "+f+": "+j.length+" pending revision(s)."),D[f]=j,e.abrupt("return");case 25:return t.debug("[Ghost Content Manager] "+f+" has no pending revisions, updating DB from the file system."),e.next=28,b(g,{cwd:c});case 28:return C=e.sent,e.next=31,u.default.map(C,function(e){return q(c,f,e,{isBinary:p})});case 31:return e.next=33,S("ghost_content").whereNotIn("file",C).andWhere("folder",f).del().then();case 33:case"end":return e.stop()}},e,void 0)})),function(e){return y.apply(this,arguments)}),M=(x=v(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A(t);case 2:D[t]=e.sent,D[t].length||delete D[t];case 4:case"end":return e.stop()}},e,void 0)})),function(e){return x.apply(this,arguments)}),F=function(e,t,r){return e("ghost_revisions").transacting(r).insert({content_id:t,revision:(0,g.safeId)(),created_by:"admin"})},N=(k=v(regeneratorRuntime.mark(function e(o,a,i){var s,c,l,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return s=e.sent,c=I(o).normalizedFolderName,l=O[c].isBinary,f=l?"binary_content":"content",e.next=8,s("ghost_content").where(_({folder:c,file:a},f,i)).count("id as count").then(function(e){var t=n(e,1)[0];return Number(t.count)>0});case 8:if(!e.sent){e.next=10;break}return e.abrupt("return",u.default.resolve());case 10:return e.abrupt("return",s.transaction(function(e){C({knex:s,tableName:"ghost_content",where:{folder:c,file:a},data:_({},f,i),trx:e}).then(function(t){return F(s,t,e)}).then(e.commit).then(function(){return M(c)}).catch(function(r){t.error("[Ghost Content Manager]",r),e.rollback()})}));case 11:case"end":return e.stop()}},e,void 0)})),function(e,t,r){return k.apply(this,arguments)}),L=(R=v(regeneratorRuntime.mark(function e(t,n){var o,u,s,c,l,f,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return o=e.sent,u=I(t),s=u.folderPath,c=u.normalizedFolderName,l=a.default.join(s,n),f=O[c].isBinary,d=void 0!==f&&f,e.next=8,o("ghost_revisions").whereIn("id",function(){this.select("ghost_revisions.id").from("ghost_revisions").join("ghost_content","ghost_content.id","=","ghost_revisions.content_id").where("folder",t).andWhere("file",n)}).del();case 8:return e.next=10,M(t);case 10:if(!i.default.existsSync(l)){e.next=14;break}q(s,t,n,{isBinary:d}),e.next=16;break;case 14:return e.next=16,o("ghost_content").where("folder",t).andWhere("file",n).del();case 16:case"end":return e.stop()}},e,void 0)})),function(e,t){return R.apply(this,arguments)}),B=(E=v(regeneratorRuntime.mark(function e(t,n){var o,a,i,u,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return o=e.sent,a=I(t),i=a.normalizedFolderName,u=O[i]||{},s=u.isBinary,c=s?"binary_content":"content",e.abrupt("return",o("ghost_content").select(c).where({folder:i,file:n}).then(function(e){if(!e||!e.length)return null;var t=e[0];return t&&t[c]||null}));case 7:case"end":return e.stop()}},e,void 0)})),function(e,t){return E.apply(this,arguments)}),U=(j=v(regeneratorRuntime.mark(function e(n,o){var a,i,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return a=e.sent,i=I(n),u=i.normalizedFolderName,e.t0=c.default,e.next=7,a("ghost_content").where({folder:u,file:o,deleted:0}).select("id");case 7:if(e.t1=e.sent,s=(0,e.t0)(e.t1,"0.id")){e.next=11;break}throw new Error("Can't delete file: "+o+": couldn't find it in folder: "+u);case 11:return e.abrupt("return",a.transaction(function(e){a("ghost_content").transacting(e).where({id:s}).update({deleted:1,content:null,binary_content:null}).then(function(){return F(a,s,e)}).then(e.commit).then(function(){return M(u)}).catch(function(r){t.error("[Ghost Content Manager]",r),e.rollback()})}));case 12:case"end":return e.stop()}},e,void 0)})),function(e,t){return j.apply(this,arguments)}),W=(S=v(regeneratorRuntime.mark(function e(t){var n,o,a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get();case 2:return n=e.sent,o=I(t),a=o.normalizedFolderName,e.abrupt("return",n("ghost_content").select("file").whereNotIn("file",u).andWhere({folder:a,deleted:0}).andWhere("file","like","%"+i).then(function(e){return e.map(function(e){return e.file})}));case 5:case"end":return e.stop()}},e,void 0)})),function(e){return S.apply(this,arguments)});return t.info("[Ghost Content Manager] Initialized"),{addRootFolder:T,upsertFile:N,readFile:B,deleteFile:U,directoryListing:W,getPending:function(){return D},getPendingWithContent:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).stringifyBinary,t=void 0!==e&&e;return u.default.props((0,f.default)(D,function(e){var t,n=e.stringifyBinary,o=void 0!==n&&n;return t=v(regeneratorRuntime.mark(function e(t,n){var a,i,u,s,c,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.map(function(e){return e.revision}),i=(0,d.default)(t.map(function(e){return e.file})),u=O[n].isBinary,s=u?"binary_content":"content",e.next=6,r.get();case 6:return c=e.sent,e.next=9,c("ghost_content").select("file",s,"deleted").whereIn("file",i).andWhere({folder:n});case 9:return l=e.sent,u&&l.forEach(function(e){e.content=o?e.binary_content.toString("base64"):e.binary_content,delete e.binary_content}),e.abrupt("return",{files:l,revisions:a,binary:u});case 12:case"end":return e.stop()}},e,void 0)})),function(e,r){return t.apply(this,arguments)}}({stringifyBinary:t})))},revertAllPendingChangesForFile:L}},e.exports.REVISIONS_FILE_NAME=".ghost-revisions"},function(e,t){e.exports=require("lodash/mapValues")},function(e,t){e.exports=require("lodash/get")},function(module,exports,__webpack_require__){"use strict";var _fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_bluebird=__webpack_require__(4),_bluebird2=_interopRequireDefault(_bluebird),_prompt=__webpack_require__(23),_prompt2=_interopRequireDefault(_prompt),_chalk=__webpack_require__(7),_chalk2=_interopRequireDefault(_chalk),_validUrl=__webpack_require__(112),_validUrl2=_interopRequireDefault(_validUrl),_axios=__webpack_require__(12),_axios2=_interopRequireDefault(_axios),_promptConfirm=__webpack_require__(20),_promptConfirm2=_interopRequireDefault(_promptConfirm),_mkdirp=__webpack_require__(9),_mkdirp2=_interopRequireDefault(_mkdirp),_os=__webpack_require__(13),_os2=_interopRequireDefault(_os),_get=__webpack_require__(35),_get2=_interopRequireDefault(_get),_util=__webpack_require__(3),_util2=_interopRequireDefault(_util);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new _bluebird2.default(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return _bluebird2.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var AUTH_FILE=".auth.json",getDataDir=function getDataDir(){var projectPath=_path2.default.resolve("."),botfile=_path2.default.join(projectPath,"botfile.js");_fs2.default.existsSync(botfile)||(_util2.default.print.error("(fatal) No "+_chalk2.default.bold("botfile.js")+" file found at: "+botfile),process.exit(1));var bf=eval("require")(botfile);return _util2.default.getDataLocation(bf.dataDir,projectPath)},getCloudAuthFile=function(){return _path2.default.join(_os2.default.homedir(),".botpress",AUTH_FILE)},getAuthFile=function(){return _path2.default.join(getDataDir(),AUTH_FILE)},readJsonFile=function(e){try{var t=_fs2.default.readFileSync(e,"utf-8");return JSON.parse(t)}catch(t){"ENOENT"!==t.code&&_util2.default.print.warn(t.message||"Unknown error","while reading "+e+".")}return{}},writeJsonFile=function(e,t){_mkdirp2.default.sync(_path2.default.dirname(e)),_fs2.default.writeFileSync(e,JSON.stringify(t,null,2))},readBotAuth=function(){return readJsonFile(getAuthFile())},readCloudAuth=function(){return readJsonFile(getCloudAuthFile())},writeBotAuth=function(e){return writeJsonFile(getAuthFile(),e)},writeCloudAuth=function(e){return writeJsonFile(getCloudAuthFile(),e)},AUTH_DISABLED="[AUTH DISABLED]",refreshToken=(_ref=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=readBotAuth(),(n=r[t])&&n!==AUTH_DISABLED){e.next=4;break}return e.abrupt("return");case 4:return e.prev=4,e.next=7,_axios2.default.request({url:t+"/api/auth/refresh_token",method:"POST",headers:{Authorization:"Bearer "+n}});case 7:return o=e.sent,e.abrupt("return",o.data);case 11:return e.prev=11,e.t0=e.catch(4),e.abrupt("return",null);case 14:case"end":return e.stop()}},e,void 0,[[4,11]])})),function(e){return _ref.apply(this,arguments)}),_ref,doRootLogin=(_ref2=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,refreshToken(t);case 2:if(!(r=e.sent)){e.next=5;break}return e.abrupt("return",{token:r,kind:"refresh"});case 5:return n={properties:{user:{description:_chalk2.default.white("User:"),required:!0},password:{description:_chalk2.default.white("Password:"),hidden:!0,required:!0}}},_prompt2.default.message="",_prompt2.default.delimiter="",_prompt2.default.start(),e.next=11,_bluebird2.default.fromCallback(function(e){return _prompt2.default.get(n,e)});case 11:return o=e.sent,a=o.user,i=o.password,e.next=16,_axios2.default.post(t+"/api/login",{user:a,password:i});case 16:if(!(u=e.sent).data.success){e.next=19;break}return e.abrupt("return",{token:u.data.token,kind:"login"});case 19:throw new Error(u.data.reason);case 20:case"end":return e.stop()}},e,void 0)})),function(e){return _ref2.apply(this,arguments)}),_ref2,doCloudLogin=(_ref4=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,a,i,u,s,c,l,f,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.endpoint+"/me/cli",o=r.endpoint+"/api/login/bot/"+r.botId+"/"+r.botEnv,(a=readCloudAuth())[r.endpoint]){e.next=16;break}return i={properties:{token:{description:_chalk2.default.white("API Token:"),required:!0}}},_prompt2.default.message="You need to authenticate using Botpress Cloud for this bot.\r\nPlease visit "+n+" and copy/paste your API token here.\r\n",_prompt2.default.delimiter="",_prompt2.default.start(),e.next=10,_bluebird2.default.fromCallback(function(e){return _prompt2.default.get(i,e)});case 10:if(u=e.sent,(s=u.token).startsWith("cli__")){e.next=14;break}throw new Error('Invalid API Token, expected token starting with "cli__"');case 14:a[r.endpoint]=s,writeCloudAuth(a);case 16:return e.prev=16,c="Bearer "+a[r.endpoint],e.next=20,_axios2.default.get(o,{headers:{authorization:c}});case 20:return l=e.sent,f=l.data,e.abrupt("return",{token:(0,_get2.default)(f,"payload.token"),kind:"refresh"});case 25:throw e.prev=25,e.t0=e.catch(16),delete a[r.endpoint],writeCloudAuth(a),d=(0,_get2.default)(e.t0,"response.data.message")||e.t0.message,new Error("Could not authenticate to bot using Botpress Cloud, please try again. ("+d+")");case 31:case"end":return e.stop()}},e,void 0,[[16,25]])})),function(e,t){return _ref4.apply(this,arguments)}),_ref4,doLogin=(_ref7=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_axios2.default.get(t+"/api/auth/info");case 2:if(r=e.sent,"none"!==!(n=r.data||{}).type){e.next=8;break}return e.abrupt("return",{token:AUTH_DISABLED,kind:"no-auth"});case 8:if("cloud"!==n.type){e.next=12;break}return e.abrupt("return",doCloudLogin(t,n));case 12:if("root"!==n.type){e.next=16;break}return e.abrupt("return",doRootLogin(t));case 16:throw new Error("Unknown login type: "+n.type);case 17:case"end":return e.stop()}},e,void 0)})),function(e){return _ref7.apply(this,arguments)}),_ref7,_ref8;exports.login=(_ref8=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=t.replace(/\/+$/,""),_validUrl2.default.isUri(t)){e.next=4;break}return _util2.default.print.error("Doesn't look like valid URL: "+t),e.abrupt("return");case 4:return e.prev=4,e.next=7,doLogin(t);case 7:return r=e.sent,n=r.token,o=r.kind,(a=readBotAuth())[t]=n,writeBotAuth(a),"login"===o?_util2.default.print.success("Logged in successfully. Auth token saved in "+getAuthFile()+"."):"refresh"===o?_util2.default.print.success("Auth token refreshed and saved in "+getAuthFile()+"."):"no-auth"===o&&_util2.default.print.info("Auth is disabled at "+t+", no need to login."),e.abrupt("return",n);case 17:return e.prev=17,e.t0=e.catch(4),_util2.default.print.error(e.t0.message||"Unknown"),e.abrupt("return");case 21:case"end":return e.stop()}},e,void 0,[[4,17]])})),function(e){return _ref8.apply(this,arguments)}),exports.logout=function(e){if(e){e=e.replace(/\/+$/,"");var t=readBotAuth();t[e]?(delete t[e],writeBotAuth(t),_util2.default.print.success("Logged out successfully.")):_util2.default.print.warn("No saved token for "+e+", nothing to do.")}else new _promptConfirm2.default("You're about to delete all saved auth tokens in the current folder. Are you sure?").run().then(function(e){e&&(writeBotAuth({}),writeCloudAuth({}))})}},function(e,t,r){"use strict";var n=i(r(4)),o=i(r(0)),a=i(r(5));function i(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.betweenGetAndSetCallback||function(){return n.default.resolve()},i=t.tableName||"kvs",u=function(t,r){var n=void 0,o={tableName:i,keyCol:"key",valueCol:"value",modifiedOnCol:"modified_on",key:t,value:JSON.stringify(r),now:(0,a.default)(e).date.now()};return n=(0,a.default)(e).isLite()?"\n        INSERT OR REPLACE INTO :tableName: (:keyCol:, :valueCol:, :modifiedOnCol:)\n        VALUES (:key, :value, :now)\n      ":"\n        INSERT INTO :tableName: (:keyCol:, :valueCol:, :modifiedOnCol:)\n        VALUES (:key, :value, :now)\n        ON CONFLICT (:keyCol:) DO UPDATE\n          SET :valueCol: = :value, :modifiedOnCol: = :now\n      ",e.raw(n,o)},s=function(t,r){return e(i).where({key:t}).limit(1).then().get(0).then(function(e){if(!e)return null;var t=JSON.parse(e.value);return r?o.default.at(t,[r])[0]:t})};return{get:s,set:function(e,t,n){if(!n)return u(e,t);var a=function(e){return n?(o.default.set(e,n,t),e):t};return s(e).then(function(t){return r().then(function(){return o.default.isNil(t)?u(e,a({})):u(e,a(Object.assign({},t)))})})},bootstrap:function(){return(0,a.default)(e).createTableIfNotExists(i,function(e){e.string("key").primary(),e.text("value"),e.timestamp("modified_on")})}}}},function(module,exports,__webpack_require__){"use strict";var _knex=__webpack_require__(22),_knex2=_interopRequireDefault(_knex),_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_kvs=__webpack_require__(37),_kvs2=_interopRequireDefault(_kvs),_util=__webpack_require__(3),_util2=_interopRequireDefault(_util);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function dropTableIfExists(e,t){return e.schema.hasTable(t).then(function(r){if(r)return e.schema.dropTable(t)})}function migrate_database_schema(e){var t=(0,_knex2.default)({client:"sqlite3",connection:{filename:e},useNullAsDefault:!0});return t.schema.table("users",function(e){e.string("picture_url"),e.string("first_name"),e.string("last_name")}).then(function(){return t("users").update({created_on:t.raw("strftime('%Y-%m-%dT%H:%M:%fZ', created_on/1000, 'unixepoch')")})}).then(function(e){_util2.default.print("info","Updated "+e+" users"),_util2.default.print("warn","Users table was migrated to new schema but existing users will miss the following fields: `picture_url`, `first_name`, `last_name`. They have been left to `null`.")}).catch(function(){_util2.default.print("warn","Did not migrate table `users` as schema was already up to date")}).then(function(){return(0,_kvs2.default)(t).bootstrap()}).catch(function(){_util2.default.print("warn","Did not create table `kvs` as schema was already up to date")}).then(function(){return process.env.DELETE_TABLES?dropTableIfExists(t,"analytics_interactions").then(function(){return dropTableIfExists(t,"analytics_runs")}).then(function(){return dropTableIfExists(t,"broadcast_outbox")}).then(function(){return dropTableIfExists(t,"broadcast_schedules")}).then(function(){return dropTableIfExists(t,"hitl_messages")}).then(function(){return dropTableIfExists(t,"hitl_sessions")}).then(function(){return dropTableIfExists(t,"subscription_users")}).then(function(){return dropTableIfExists(t,"subscriptions")}).then(function(){return dropTableIfExists(t,"scheduler_schedules")}).then(function(){return dropTableIfExists(t,"scheduler_tasks")}).then(function(){return _util2.default.print("info","Dropped module tables")}):(_util2.default.print("warn","This migration must delete the tables of the following modules: `botpress-scheduler`, `botpress-analytics`, `botpress-hitl` and `botpress-subscription`."),_util2.default.print("warn","This step has been skipped because you didn't provide the DELETE_TABLES=true environement variable."),_util2.default.print("warn","Please backup your data if necessary then re-run with DELETE_TABLES=true"),!1)})}function migrate_botfile(e){var t=_fs2.default.readFileSync(e).toString();if(t.indexOf("postgres:")>=0)return _util2.default.print("warn","Did not migrate botfile as it seemed like `postgres` was already present. Please migrate manually if this is a mistake."),!1;var r=t.replace(/module\.exports.*?=.*?{/i,"module.exports = {\n\n  /**\n  * Postgres configuration\n  */\n  postgres: {\n    enabled: process.env.DATABASE === 'postgres',\n    host: process.env.PG_HOST || '127.0.0.1',\n    port: process.env.PG_PORT || 5432,\n    user: process.env.PG_USER || '',\n    password: process.env.PG_PASSWORD || '',\n    database: process.env.PG_DB || ''\n  },");_fs2.default.writeFileSync(e,r),_util2.default.print("info","Updated botfile")}module.exports=function(bot_path){var botfilePath=_path2.default.join(bot_path,"botfile.js"),botfile=eval("require")(botfilePath),dbLocation=_path2.default.resolve(_path2.default.join(bot_path,botfile.dataDir,"db.sqlite"));return migrate_database_schema(dbLocation).then(function(){return migrate_botfile(botfilePath)})}},function(e,t,r){var n={"./0.1":38,"./0.1.js":38};function o(e){var t=a(e);return r(t)}function a(e){var t=n[e];if(!(t+1)){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}return t}o.keys=function(){return Object.keys(n)},o.resolve=a,e.exports=o,o.id=39},function(e,t,r){"use strict";var n=r(5);e.exports={database:n}},function(e){e.exports={name:"botpress",description:"The world's first CMS for bots. Easily create, manage and extend chatbots.",version:"10.22.3",author:"Botpress",bin:{bp:"./bin/botpress",botpress:"./bin/botpress"},bugs:{url:"https://github.com/botpress/botpress/issues"},dependencies:{"@botpress/util-roles":"^10.22.3",axios:"^0.15.2","babel-polyfill":"^6.23.0",bluebird:"^3.4.6","body-parser":"^1.15.2",chalk:"^2.4.1",commander:"^2.9.0",compression:"^1.7.1",dotenv:"^4.0.0",eventemitter2:"^2.1.3",express:"^4.14.0",glob:"^7.1.2",history:"^4.7.2",howler:"^2.0.3",joi:"^13.2.0","js-yaml":"^3.8.4",json5:"^1.0.1",jsonwebtoken:"^7.1.9",knex:"^0.12.6","loaders.css":"^0.1.2",lodash:"^4.16.4",mkdirp:"^0.5.1",moment:"^2.15.1",monitorctrlc:"^2.0.1",ms:"^0.7.1",multer:"^1.3.0",mustache:"^2.3.0",mware:"0.0.3",nanoid:"^1.0.1","node-machine-id":"^1.1.3",nodemon:"^1.12.1",pg:"^6.1.2","prepend-file":"^1.3.1",prompt:"^1.0.0","prompt-confirm":"^1.2.0","query-string":"^5.0.1",randomstring:"^1.1.5","react-jsonschema-form":"^1.0.3","react-loaders":"^3.0.1","react-router-dom":"^4.2.2","react-toastify":"^3.3.3","socket.io":"^1.5.0","socket.io-client":"^2.0.3","socketio-jwt":"^4.5.0","source-map-support":"^0.4.6","universal-analytics":"^0.4.8",username:"^3.0.0","valid-url":"^1.0.9",verror:"^1.10.0",vm2:"^3.5.2",winston:"^2.2.0",yn:"^2.0.0"},optionalDependencies:{sqlite3:"^3.1.13"},devDependencies:{autoprefixer:"^6.5.3","babel-cli":"^6.16.0","babel-core":"^6.18.0","babel-eslint":"^8.0.2","babel-loader":"^7.1.2","babel-plugin-root-import":"^5.1.0","babel-plugin-transform-class-properties":"^6.24.1","babel-preset-env":"^1.6.1","babel-preset-react":"^6.24.1","babel-preset-stage-3":"^6.24.1","babel-register":"^6.16.3",bootstrap:"^3.3.7",chai:"^3.5.0",classnames:"^2.2.5",concurrently:"^3.5.1","copy-webpack-plugin":"^4.5.1","css-loader":"^0.28.11","exports-loader":"^0.6.3","expose-loader":"^0.7.1","extract-text-webpack-plugin":"^3.0.2","file-loader":"^1.1.11","html-webpack-plugin":"^3.2.0","json-loader":"^0.5.4",keymirror:"^0.1.1",minami:"^1.2.3",mkdirp:"^0.5.1",mocha:"^3.1.2","node-sass":"^4.8.3","postcss-loader":"^2.0.8","prop-types":"^15.6.0",react:"^16.4.0","react-bootstrap":"^0.32.1","react-bootstrap-button-loader":"^1.0.11","react-dom":"^16.4.0","react-emoji":"^0.4.4","react-fontawesome":"^1.2.0","react-ga":"^2.1.2","react-highlight-words":"^0.11.0","react-markdown":"^2.4.5","react-redux":"^5.0.6","react-router":"^4.2.0","react-select":"^1.0.0-rc.10","react-sidebar":"^2.2.1","react-sortable":"^1.2.0","react-split-pane":"^0.1.66","react-treebeard":"^2.1.0","reduce-reducers":"^0.1.2",redux:"^3.7.2","redux-actions":"^2.2.1","redux-thunk":"^2.2.0","sass-loader":"^6.0.6","script-loader":"^0.7.0","simple-line-icons":"^2.4.1",sinon:"^4.2.2","storm-react-diagrams":"^4.0.0","style-loader":"^0.13.1","thread-loader":"^1.1.5",tmp:"0.0.31","uglifyjs-webpack-plugin":"^1.2.5",webpack:"^4.12.0","webpack-node-externals":"^1.7.2"},engines:{node:">=6.10.0 <9.0.0"},homepage:"https://botpress.io",keywords:["bots","chatbots","bot framework","messenger","facebook","slack","botkit","microsoft bot framework","bot builder","bot","chatbot","conversational"],license:"AGPL-3.0",main:"lib/node.bundle.js",repository:"git+https://github.com/botpress/botpress.git",os:["darwin","linux","win32"],scripts:{prepublishOnly:"npm run compile-prod",compile:"./build.sh","compile-prod":"NODE_ENV=production ./build.sh",test:"BABEL_ENV=tests mocha --compilers js:babel-core/register --require tests/index.js tests/**",watch:'rm -rf ./lib/web && concurrently -k "node ./webpack.server.js --watch" "node ./webpack.web.js --watch"'},watch:{compile:{patterns:["src"],extensions:"js,jsx,scss,json,html"}}}},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("multer")},function(e,t,r){"use strict";var n=s(r(0)),o=s(r(11)),a=s(r(43)),i=s(r(10)),u=s(r(3));function s(e){return e&&e.__esModule?e:{default:e}}function c(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var l=(0,o.default)();e.exports=function(e,t){var r,s,f,d,p,h,g,m,_,v,b,w,y;t.secure("read","bot.modules.list").get("/api/modules",function(t,r){var o=n.default.map(e._loadedModules,function(e){return{name:u.default.getModuleShortname(e.name),fullName:e.name,homepage:e.homepage,isPlugin:e.settings.isPlugin,menuText:e.settings.menuText||e.name,menuIcon:e.settings.menuIcon||"view_module",noInterface:!!e.settings.noInterface,moduleView:e.settings.moduleView||{stretched:!1},plugins:e.settings.plugins||[]}});r.send(o)}),t.secure("read","bot.modules.list.community").get("/api/module/hero",function(t,r){e.modules.getRandomCommunityHero().then(function(e){return r.send(e)})}),t.secure("read","bot.modules.list.community").get("/api/bot/contributor",function(t,r){r.send(e.bot.getContributor())}),t.secure("read","bot.middleware.list").get("/api/middlewares",function(t,r){r.send(e.middlewares.list())}),t.secure("write","bot.middleware.customizations").post("/api/middlewares/customizations",function(t,r){e.stats.track("api","middlewares","customizations");var n=t.body.middlewares;e.middlewares.setCustomizations(n),e.middlewares.load(),r.send(e.middlewares.list())}),t.secure("write","bot.middleware.customizations").delete("/api/middlewares/customizations",function(t,r){e.stats.track("api","middlewares","customizations"),e.middlewares.resetCustomizations(),e.middlewares.load(),r.send(e.middlewares.list())}),t.secure("read","bot.notifications").get("/api/notifications",(r=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.notifications.getInbox();case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return r.apply(this,arguments)})),t.secure("read","bot.notifications").get("/api/notifications/inbox",(s=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.notifications.getInbox();case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return s.apply(this,arguments)})),t.secure("read","bot.information").get("/api/bot/information",function(t,r){r.send(e.about.getBotInformation())}),t.secure("write","bot.information.license").post("/api/license",function(t,r){e.stats.track("api","license","change"),e.licensing.changeLicense(t.body.license).then(function(){r.sendStatus(200)}).catch(function(e){return r.status(500).send({message:e&&e.message})})}),t.secure("read","bot.logs").get("/api/logs",function(t,r){e.logger.queryDb(t.query&&t.query.limit||50).then(function(e){r.send(e)}).catch(function(e){console.log(e)})}),t.secure("read","bot.logs").get("/api/logs/key",function(e,t){t.send({secret:l})}),t.secure("read","bot.logs.archive").get("/api/logs/archive/:key",function(t,r){if(e.stats.track("api","logs","archive"),t.params.key!==l)return r.sendStatus(403);e.logger.queryDb(null,"asc").then(function(e){l=(0,o.default)(),r.setHeader("Content-type","text/plain"),r.setHeader("Content-disposition","attachment; filename=logs.txt"),r.send(e.map(function(e){var t=e.timestamp,r=e.level,n=e.message;return(0,i.default)(new Date(t)).format("MMM DD HH:mm:ss")+" "+r+": "+n}).join("\n"))}).catch(function(e){console.error(e),r.sendStatus(500)})}),t.secure("read","bot.content").get("/api/content/categories",(f=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.contentManager.listAvailableCategories();case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return f.apply(this,arguments)})),t.secure("read","bot.content").get("/api/content/items",(d=c(regeneratorRuntime.mark(function t(r,n){var o,a,i,u,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=r.query.from||0,a=r.query.count||50,i=r.query,u=i.searchTerm,s=i.categoryId,c=i.orderBy,"all"===s&&(s=null),t.t0=n,t.next=7,e.contentManager.listCategoryItems(s,{from:o,count:a,searchTerm:u,orderBy:c});case 7:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 9:case"end":return t.stop()}},t,void 0)})),function(e,t){return d.apply(this,arguments)})),t.secure("read","bot.content").get("/api/content/items/count",(p=c(regeneratorRuntime.mark(function t(r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return"all"===(o=r.query.categoryId)&&(o=null),t.t0=n,t.next=5,e.contentManager.categoryItemsCount(o);case 5:t.t1=t.sent,t.t2={count:t.t1},t.t0.send.call(t.t0,t.t2);case 8:case"end":return t.stop()}},t,void 0)})),function(e,t){return p.apply(this,arguments)})),t.secure("read","bot.content").get("/api/content/items/:id",(h=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.contentManager.getItem(r.params.id);case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return h.apply(this,arguments)})),t.secure("read","bot.content").get("/api/content/items-batched/:ids",(g=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.contentManager.getItems(r.params.ids);case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return g.apply(this,arguments)})),t.secure("write","bot.content").post("/api/content/categories/:id/items",(m=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.contentManager.createOrUpdateCategoryItem({formData:r.body.formData,categoryId:r.params.id});case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return m.apply(this,arguments)})),t.secure("write","bot.content").post("/api/content/categories/:id/items/:itemId",(_=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.contentManager.createOrUpdateCategoryItem({itemId:r.params.itemId,formData:r.body.formData,categoryId:r.params.id});case 2:n.sendStatus(200);case 3:case"end":return t.stop()}},t,void 0)})),function(e,t){return _.apply(this,arguments)})),t.secure("write","bot.content").post("/api/content/categories/all/bulk_delete",(v=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.contentManager.deleteCategoryItems(r.body);case 2:n.sendStatus(200);case 3:case"end":return t.stop()}},t,void 0)})),function(e,t){return v.apply(this,arguments)})),t.secure("read","bot.ghost_content").get("/api/ghost_content/status",(b=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.ghostManager.getPending();case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return b.apply(this,arguments)})),t.secure("read","bot.ghost_content").get("/api/ghost_content/export",(w=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.ghostManager.getPendingWithContent({stringifyBinary:!0});case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return w.apply(this,arguments)})),t.secure("write","bot.ghost_content").delete("/api/ghost_content/:folder",(y=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.ghostManager.revertAllPendingChangesForFile(r.params.folder,r.query.file);case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return y.apply(this,arguments)}));var x,k,R,E,j,S=(0,a.default)({limits:{fileSize:1024e4}});t.secure("write","bot.media").post("/api/media",S.single("file"),(x=c(regeneratorRuntime.mark(function t(r,n){var o,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.mediaManager.saveFile(r.file.originalname,r.file.buffer);case 2:return o=t.sent,a="/media/"+o,t.abrupt("return",n.json({url:a}));case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return x.apply(this,arguments)})),t.secure("read","bot.flows").get("/api/flows/all",(k=c(regeneratorRuntime.mark(function t(r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.dialogEngine.getFlows();case 2:o=t.sent,n.send(o);case 4:case"end":return t.stop()}},t,void 0)})),function(e,t){return k.apply(this,arguments)})),t.secure("read","bot.flows").get("/api/flows/available_actions",(R=c(regeneratorRuntime.mark(function t(r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:o=e.dialogEngine.getAvailableActions(),n.send(o);case 2:case"end":return t.stop()}},t,void 0)})),function(e,t){return R.apply(this,arguments)})),t.secure("write","bot.flows").post("/api/flows/save",(E=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.dialogEngine.flowProvider.saveFlows(r.body);case 2:n.sendStatus(200);case 3:case"end":return t.stop()}},t,void 0)})),function(e,t){return E.apply(this,arguments)})),t.secure("write","bot.skills").post("/api/skills/:skillId/generate",(j=c(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.skills.generateFlow(r.params.skillId,r.body);case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return j.apply(this,arguments)})),t.get("/api/community/hero",function(t,r){r.send({hidden:n.default.get(e,"botfile.heroSection.hidden",!1)})})}},function(e,t,r){"use strict";var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=i(r(2)),a=i(r(1));i(r(3));function i(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e,t){var r,i;t.get("/api/ping",function(e,t){t.send("pong")}),t.get("/api/license",(r=u(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=n,t.next=3,e.licensing.getLicensing();case 3:t.t1=t.sent,t.t0.send.call(t.t0,t.t1);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return r.apply(this,arguments)})),t.delete("/api/guided-tour",function(t,r){o.default.unlink(a.default.join(e.projectLocation,".welcome"),function(){e.isFirstRun=!1,r.sendStatus(200)})}),t.get("/api/my-account",(i=u(regeneratorRuntime.mark(function t(r,o){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.cloud.getUserRoles(r.user.roles);case 2:a=t.sent,o.send(n({},r.user,{roles:a}));case 4:case"end":return t.stop()}},t,void 0)})),function(e,t){return i.apply(this,arguments)}))}},function(e,t,r){"use strict";function n(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e,t){var r,o,a;t.get("/api/auth/info",(r=n(regeneratorRuntime.mark(function t(r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e.stats.track("api","auth","info"),n.json(e.security.getAuthenticationInfo());case 2:case"end":return t.stop()}},t,void 0)})),function(e,t){return r.apply(this,arguments)})),t.post("/api/auth/refresh_token",(o=n(regeneratorRuntime.mark(function t(r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e.stats.track("api","auth","refresh_token"),t.next=3,e.security.refreshToken(r.headers.authorization);case 3:(o=t.sent).success?n.send(o.token):n.status(400).send(o.reason);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return o.apply(this,arguments)})),t.post("/api/login",(a=n(regeneratorRuntime.mark(function t(r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e.stats.track("api","auth","login"),t.next=3,e.security.login(r.body.user,r.body.password,r.ip);case 3:o=t.sent,n.send(o);case 5:case"end":return t.stop()}},t,void 0)})),function(e,t){return a.apply(this,arguments)}))}},function(e,t){e.exports=require("@botpress/util-roles")},function(e,t){e.exports=require("query-string")},function(e,t){e.exports=require("body-parser")},function(e,t,r){"use strict";var n=f(r(0)),o=f(r(49)),a=r(15),i=f(r(48)),u=r(47),s=f(r(46)),c=f(r(45)),l=f(r(44));function f(e){return e&&e.__esModule?e:{default:e}}function d(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var p={},h={},g=function(e,t){return function(r,n,o){var a=r.originalUrl.match(/\/api\/(botpress-[^\/]+).*$/i);if(!a)return t(r,n,o);if(!p[a[1]])return t(r,n,o);var i=p[a[1]][e];if(!1===i)o();else{if("function"!=typeof i||!1!==i(r))return t(r,n,o);o()}}};e.exports=function(e){var t,r,f,m=(t=d(regeneratorRuntime.mark(function t(r,n,o){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n.maybeSendRequireLogin=function(){return!e.botfile.login.enabled&&(n.status(400).send({message:"Login must be turned on for this API method"}),!0)},e.botfile.login.enabled){t.next=3;break}return t.abrupt("return",o());case 3:return t.next=5,e.security.authenticate(r.headers.authorization);case 5:(a=t.sent)?(r.user=a,o()):n.status(401).location("/login").end();case 7:case"end":return t.stop()}},t,void 0)})),function(e,r,n){return t.apply(this,arguments)}),_=(r=d(regeneratorRuntime.mark(function t(r){var n,o,a,i,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.botfile.login,o=n.useCloud,a=n.enabled,t.t0=!!o,!t.t0){t.next=6;break}return t.next=5,e.cloud.isPaired();case 5:t.t0=t.sent;case 6:if(t.t0&&a){t.next=9;break}return t.abrupt("return",!1);case 9:if(i=r.user||{},u=i.roles){t.next=12;break}return t.abrupt("return",null);case 12:return t.abrupt("return",e.cloud.getUserRoles(u));case 13:case"end":return t.stop()}},t,void 0)})),function(e){return r.apply(this,arguments)}),v=function(e){e.secure=function(t,r){var n=function(n){return function(o){for(var a=arguments.length,i=Array(a>1?a-1:0),s=1;s<a;s++)i[s-1]=arguments[s];var c,l=(c=d(regeneratorRuntime.mark(function e(n,o,a){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,_(n);case 3:if(!1!==(i=e.sent)){e.next=6;break}return e.abrupt("return",a());case 6:if((0,u.checkMultipleRoles)(i,t,r)){e.next=8;break}return e.abrupt("return",o.sendStatus(403));case 8:return e.abrupt("return",a());case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",o.status(500).send({message:e.t0.message}));case 14:case"end":return e.stop()}},e,void 0,[[0,11]])})),function(e,t,r){return c.apply(this,arguments)});return e[n].apply(e,[o,l].concat(i))}};return{get:n("get"),post:n("post"),put:n("put"),patch:n("patch"),delete:n("delete")}}},b=function(t){e.getRouter=function(e,r){if(!/^botpress-/.test(e))throw new Error("The name of a router must start with 'botpress-'. Received: "+e);if(!h[e]){var n=(0,a.Router)();h[e]=n,t.use("/api/"+e+"/",n)}return r&&(p[e]=Object.assign(p[e]||{},r)),v(h[e]),h[e]};var r={};e.createShortlink=function(e,t,n){if(e=e.toLowerCase(),r[e])throw new Error("There's already a shortlink named \""+e+'"');var o=n?"?"+i.default.stringify(n):"";r[e]=""+t+o},t.get("/s/:name",function(e,t){var n=e.params.name.toLowerCase();if(!r[n])return t.status(404).send({error:'Shortlink "'+n+'" not registered'});t.redirect(r[n])})},w=function(e){e.maybeUse=function(){3===arguments.length?e.use(arguments[0],g(arguments[1],arguments[2])):2===arguments.length&&e.use(g(arguments[0],arguments[1]))}};return{install:(f=d(regeneratorRuntime.mark(function t(r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:b(r),v(r),w(r),r.maybeUse("bodyParser.json",o.default.json({limit:n.default.get(e.botfile,"api.bodyMaxSize")||"1mb"})),r.maybeUse("bodyParser.urlencoded",o.default.urlencoded({extended:!0})),(0,s.default)(e,r),r.use("/api/*",g("auth",m)),(0,c.default)(e,r),(0,l.default)(e,r);case 9:case"end":return t.stop()}},t,void 0)})),function(e){return f.apply(this,arguments)})}}},function(e,t,r){"use strict";var n=l(r(4)),o=r(15),a=l(r(1)),i=l(r(2)),u=l(r(6)),s=l(r(3)),c=l(r(25));function l(e){return e&&e.__esModule?e:{default:e}}function f(e){return function(){var t=e.apply(this,arguments);return new n.default(function(e,r){return function o(a,i){try{var u=t[a](i),s=u.value}catch(e){return void r(e)}if(!u.done)return n.default.resolve(s).then(function(e){o("next",e)},function(e){o("throw",e)});e(s)}("next")})}}e.exports=function(e){var t,r=function(t,r){var n=r.name,o=s.default.getModuleShortname(r.name);if("custom"===r.settings.menuIcon){var u="/img/modules/"+n+".png",c=a.default.join(r.root,"icon.png");t.get(u,function(t,r){try{var o=i.default.readFileSync(c);r.contentType("image/png"),r.send(o)}catch(t){e.logger.warn("Could not serve module icon ["+n+"] at: "+c)}})}var l=a.default.join(r.root,r.settings.liteDir||"bin/lite");i.default.existsSync(l)&&i.default.readdirSync(l).filter(function(e){return e.endsWith(".js")});t.get(["/js/modules/"+o,"/js/modules/"+n+".js","/js/modules/"+o+"/:subview"],function(t,o){var u=r.settings.webBundle,s=t.params&&t.params.subview?a.default.join(l,t.params.subview+".bundle.js"):a.default.join(r.root,u||"bin/web.bundle.js");try{var c=i.default.readFileSync(s);o.contentType("text/javascript"),o.send(c)}catch(t){e.logger.warn("Could not serve module ["+n+"] at: "+s),o.sendStatus(404)}})},l=function(t){var r="";if(!0===e.licensing.getFeatures().whitelabel){var n=a.default.join(e.projectLocation,"theme.css");i.default.existsSync(n)&&(r=i.default.readFileSync(n))}t.use("/style/custom-theme.css",function(e,t){t.contentType("text/css"),t.send(r)})},d=function(t){var r;t.get("/media/:filename",(r=f(regeneratorRuntime.mark(function t(r,n){var o,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.mediaManager.readFile(r.params.filename);case 2:if(o=t.sent){t.next=5;break}return t.abrupt("return",n.sendStatus(404));case 5:return i=a.default.extname(r.params.filename),t.abrupt("return",n.set({"Cache-Control":"max-age=31556926"}).type(i).send(o));case 7:case"end":return t.stop()}},t,void 0)})),function(e,t){return r.apply(this,arguments)}))};return{install:(t=f(regeneratorRuntime.mark(function t(i){var p,h;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(p in e._loadedModules)h=e._loadedModules[p],r(i,h);return i.use("/js/env.js",function(){var t=f(regeneratorRuntime.mark(function t(r,n){var o,a,i,l,f,d,p,h,g,m,_;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o=e.botfile.login,a=o.tokenExpiry,i=o.enabled,l=o.useCloud,f=e.botfile.ghostContent.enabled,d=!!e.botfile.optOutStats,p=e.botfile.appName||"Botpress",t.t0=!!l,!t.t0){t.next=9;break}return t.next=8,e.cloud.isPaired();case 8:t.t0=t.sent;case 9:if(h=t.t0,g={botId:"",endpoint:"",teamId:"",env:e.botfile.env},!h){t.next=19;break}return t.t1=Object,t.t2=g,t.next=16,e.cloud.getPairingInfo();case 16:t.t3=t.sent,t.t1.assign.call(t.t1,t.t2,t.t3),delete g.token;case 19:m=e.isFirstRun,_=e.version,n.contentType("text/javascript"),n.send('(function(window) {\n        window.NODE_ENV = "production";\n        window.BOTPRESS_ENV = "'+e.botfile.env+'";\n        window.BOTPRESS_CLOUD_ENABLED = '+h+";\n        window.BOTPRESS_CLOUD_SETTINGS = "+JSON.stringify(g)+";\n        window.DEV_MODE = "+s.default.isDeveloping+";\n        window.AUTH_ENABLED = "+!!i+";\n        window.AUTH_TOKEN_DURATION = "+(0,u.default)(a)+";\n        window.OPT_OUT_STATS = "+d+";\n        window.SHOW_GUIDED_TOUR = "+m+';\n        window.BOTPRESS_VERSION = "'+_+'";\n        window.APP_NAME = "'+p+'";\n        window.GHOST_ENABLED = '+!!f+";\n        window.BOTPRESS_FLOW_EDITOR_DISABLED = "+(0,c.default)(process.env.BOTPRESS_FLOW_EDITOR_DISABLED)+";\n      })(typeof window != 'undefined' ? window : {})");case 22:case"end":return t.stop()}},t,void 0)}));return function(e,r){return t.apply(this,arguments)}}()),l(i),d(i),i.use((0,o.static)(a.default.join(e.projectLocation,"static"))),i.use((0,o.static)(a.default.join(e.botpressPath,"./lib/web"))),i.get("*",function(t,r,n){if(/html/i.test(t.headers.accept)&&!/^\/api\//i.test(t.url))return t.url&&/^\/lite\//i.test(t.url)?r.sendFile(a.default.join(e.botpressPath,"./lib/web/lite.html")):r.sendFile(a.default.join(e.botpressPath,"./lib/web/index.html"));n()}),t.abrupt("return",n.default.resolve(!0));case 8:case"end":return t.stop()}},t,void 0)})),function(e){return t.apply(this,arguments)})}}},function(e,t){e.exports=require("socketio-jwt")},function(e,t){e.exports=require("socket.io")},function(e,t,r){"use strict";var n=i(r(0)),o=i(r(53)),a=i(r(52));function i(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,r;return{install:(t=regeneratorRuntime.mark(function t(r){var i,u,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=(0,o.default)(r),u=i.of("/admin"),s=i.of("/guest"),!e.botfile.login.enabled){t.next=12;break}return t.t0=u,t.t1=a.default,t.next=8,e.security.getJWTSecretOrCertificate();case 8:t.t2=t.sent,t.t3={secret:t.t2,handshake:!0},t.t4=t.t1.authorize.call(t.t1,t.t3),t.t0.use.call(t.t0,t.t4);case 12:u.on("connection",function(t){var r=n.default.get(t,"handshake.query.visitorId");e.stats.track("socket","connected"),t.on("event",function(n){e.events.emit(n.name,n.data,"client",{visitorId:r,socketId:t.id,guest:!1,admin:!0})})}),s.on("connection",function(t){var r=n.default.get(t,"handshake.query.visitorId");e.stats.track("socket","connected"),r&&r.length>0&&t.join("visitor:"+r),t.on("event",function(n){e.events.emit(n.name,n.data,"client",{socketId:t.id,visitorId:r,guest:!0,admin:!1})})}),e.events.onAny(function(e,t,r){if("client"!==r){var n=e.startsWith("guest.")?s:u;if(t&&(t.__socketId||t.__room))return n.to(t.__socketId||t.__room).emit("event",{name:e,data:t});n.emit("event",{name:e,data:t})}});case 15:case"end":return t.stop()}},t,void 0)}),r=function(){var e=t.apply(this,arguments);return new Promise(function(t,r){return function n(o,a){try{var i=e[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});t(u)}("next")})},function(e){return r.apply(this,arguments)})}}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("compression")},function(e,t,r){"use strict";var n=c(r(15)),o=c(r(56)),a=c(r(55)),i=c(r(54)),u=c(r(51)),s=c(r(50));function c(e){return e&&e.__esModule?e:{default:e}}function l(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e){var t,r,c,f,d=(t=l(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=(0,s.default)(e),t.abrupt("return",n.install(r));case 2:case"end":return t.stop()}},t,void 0)})),function(e){return t.apply(this,arguments)}),p=(r=l(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=(0,i.default)(e),t.abrupt("return",n.install(r));case 2:case"end":return t.stop()}},t,void 0)})),function(e){return r.apply(this,arguments)}),h=(c=l(regeneratorRuntime.mark(function t(r){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=(0,u.default)(e),t.abrupt("return",n.install(r));case 2:case"end":return t.stop()}},t,void 0)})),function(e){return c.apply(this,arguments)});return{start:(f=l(regeneratorRuntime.mark(function t(){var r,i,u,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return(r=(0,n.default)()).use((0,o.default)()),i=a.default.createServer(r),u=e.botfile,s=u.port,c=u.hostname,t.next=6,d(r);case 6:return t.next=8,p(i);case 8:return t.next=10,h(r);case 10:return t.abrupt("return",new Promise(function(e){i.listen(s,c,function(){return e(i)})}));case 11:case"end":return t.stop()}},t,void 0)})),function(){return f.apply(this,arguments)})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=s(r(11)),i=s(r(4)),u=s(r(0));function s(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(t,r){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.drain=function(){n.queue.length>0&&n.tick()},this.name=t,this.logger=r,this.options=Object.assign({retries:2,drainInterval:2e3},o),this.queue=[],this.subscribers=[],this._lock={},this._drain=setInterval(this.drain,this.options.drainInterval)}return o(e,[{key:"getQueueId",value:function(e){var t=e.event||e;return u.default.get(t,"user.id")||u.default.get(t,"user.userId")||u.default.get(t,"userId")||u.default.get(t,"raw.user.id")||u.default.get(t,"raw.userId")||u.default.get(t,"raw.to")||"default"}},{key:"enqueue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n={job:e,id:(0,a.default)(),timestamp:new Date,retries:t};r?this.queue.unshift(n):this.queue.push(n),this.tick()}},{key:"dequeue",value:function(){return this.queue.shift()}},{key:"cancelAll",value:function(e){var t=this,r=this.getQueueId(e);this.queue=this.queue.filter(function(e){return t.getQueueId(e.job)!==r})}},{key:"peek",value:function(e){var t=this,r=this.getQueueId(e);return this.queue.find(function(e){return t.getQueueId(e.job)===r})}},{key:"tick",value:function(){var e,t=(e=regeneratorRuntime.mark(function e(){var t,r,o,a,s,c,l,f=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==(t=u.default.findIndex(this.queue,function(e){var t=f.getQueueId(e.job);return!f._lock[t]}))){e.next=3;break}return e.abrupt("return");case 3:return r=u.default.pullAt(this.queue,[t]),o=n(r,1),a=o[0],s=a.job,c=a.retries,l=this.getQueueId(s),this._lock[l]=!0,e.prev=6,e.next=9,i.default.mapSeries(this.subscribers,function(e){return e(s)});case 9:e.next=15;break;case 11:e.prev=11,e.t0=e.catch(6),this.logger.warn(this.name+" queue failed to process job: "+e.t0.message),c+1<=this.options.retries?this.enqueue(s,c+1,!0):this.logger.error("Retrying job within "+this.name+" queue failed "+this.options.retries+" times. Abandoning the job.");case 15:return e.prev=15,delete this._lock[l],this.queue.length&&this.tick(),e.finish(15);case 19:case"end":return e.stop()}},e,this,[[6,11,15,19]])}),function(){var t=e.apply(this,arguments);return new i.default(function(e,r){return function n(o,a){try{var u=t[o](a),s=u.value}catch(e){return void r(e)}if(!u.done)return i.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})});return function(){return t.apply(this,arguments)}}()},{key:"subscribe",value:function(e){this.subscribers.push(e)}}]),e}();t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=u(r(0)),a=u(r(3)),i=r(24);function u(e){return e&&e.__esModule?e:{default:e}}var s=new RegExp("^skill-"),c=function(){function e(t){var r=this,n=t.logger;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._log=function(e,t){r.logger&&r.logger[e]&&r.logger[e](t)},this.logger=n,this._log("info","[Skills] Initiated")}return n(e,[{key:"registerSkillsFromModules",value:function(e){var t=this;this._skills=e.filter(function(e){var t=a.default.getModuleShortname(e.name);return s.test(t)}).reduce(function(e,r){var n=a.default.getModuleShortname(r.name);return r.handlers.generate?o.default.isFunction(r.handlers.generate)?(e[n]=r.handlers.generate,e):(t._log("warn",'Skill "'+n+'" generator is not a valid function'),e):(t._log("warn",'Skill "'+n+'" has no flow generator ("generate" method exposed)'),e)},{}),this._log("info","[Skills] Loaded "+o.default.keys(this._skills).length+" skills")}},{key:"generateFlow",value:function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r){var n,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._skills){e.next=2;break}throw new Error("Skills haven't been initialized yet");case 2:if(t=a.default.getModuleShortname(t),s.test(t)||(t="skill-"+t),n=this._skills[t]){e.next=7;break}throw new Error('Skill "'+t+'" not found');case 7:return e.next=9,n(r);case 9:if(u=e.sent,!(c=(0,i.validateFlowSchema)(u.flow))){e.next=13;break}throw new Error('Skill "'+t+'" generated an invalid flow: '+c);case 13:if(u.transitions&&o.default.isArray(u.transitions)){e.next=15;break}throw new Error('Skill "'+t+'" didn\'t generate valid "transitions"');case 15:return e.abrupt("return",u);case 16:case"end":return e.stop()}},e,this)}),function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})});return function(e,r){return t.apply(this,arguments)}}()}]),e}();t.default=c},function(e,t,r){"use strict";var n=s(r(6)),o=s(r(5)),a=s(r(10)),i=s(r(0)),u=s(r(4));function s(e){return e&&e.__esModule?e:{default:e}}function c(e){return function(){var t=e.apply(this,arguments);return new u.default(function(e,r){return function n(o,a){try{var i=t[o](a),s=i.value}catch(e){return void r(e)}if(!i.done)return u.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}e.exports=function(e){var t,r,s=e.db,l=e.botfile,f=e.middlewares,d=null,p=(0,n.default)(i.default.get(l,"dialogs.janitorInterval")||"30s"),h=(0,n.default)(i.default.get(l,"dialogs.timeoutInterval")||"15m"),g=(t=c(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.get();case 2:return t=e.sent,r=(0,o.default)(t).date.isBefore("active_on",(0,a.default)().subtract(h,"milliseconds")),e.next=6,t("dialog_sessions").where(r).andWhereRaw("not \"id\" like '%\\_\\_\\_%' escape '\\'").limit(250).then();case 6:return n=e.sent,e.abrupt("return",u.default.map(n,function(e){var t="botpress",r={};if(e.id.includes(":")){var n=e.id.split(":");t=i.default.head(n);var o=i.default.tail(n).join(":");r.user={id:o}}return f.sendIncoming(i.default.merge({platform:t,type:"bp_dialog_timeout",raw:{sessionId:e.id},text:e.id,sessionId:e.id},r))}));case 8:case"end":return e.stop()}},e,void 0)})),function(){return t.apply(this,arguments)}),m=(r=c(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g();case 2:case"end":return e.stop()}},e,void 0)})),function(){return r.apply(this,arguments)}),_=function(){d&&(clearInterval(d),d=null)};return{install:function(){var e=5e3*Math.random();d&&_(),d=setInterval(m,p+e)},uninstall:_,runOnce:m}}},function(e,t,r){"use strict";var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=i(r(28)),a=i(r(0));function i(e){return e&&e.__esModule?e:{default:e}}e.exports={default:{id:"send-message",send:function(e){var t=e.message,r=e.originalEvent,i=e.state,u=e.flowContext,s=t.value,c={state:i};return/{{/i.test(s)&&(s=o.default.render(s,n({},i,{event:a.default.pick(r,["raw","text","type","platform","user"]),_context:n({},a.default.pick(u,["node","flowStack"]),{currentFlow:a.default.pick(u.currentFlow,["name","version","startNode"])})}))),/^{.+}$/.test(s)?Object.assign(c,JSON.parse(s)):a.default.isEmpty(s)||Object.assign(c,{text:s}),r.reply(t.type,c)}}}},function(e,t){e.exports=require("vm2")},function(e,t,r){"use strict";var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=l(r(0)),u=l(r(4)),s=r(62),c=l(r(18));function l(e){return e&&e.__esModule?e:{default:e}}function f(e){return function(){var t=e.apply(this,arguments);return new u.default(function(e,r){return function n(o,a){try{var i=t[o](a),s=i.value}catch(e){return void r(e)}if(!i.done)return u.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}var d={debug:function(){}},p=/(.+\.flow\.json)\s?@?\s?(.+)?/i,h=function(){function e(t){var r=this,n=t.flowProvider,o=t.stateManager,a=t.options,u=t.logger,s=void 0===u?d:u;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.onError=function(e){return r.errorHandlers.push(e)},Object.assign(this,{logger:s,flowProvider:n,stateManager:o}),this.flowsLoaded=!1,this.flows=[],this.defaultFlow=i.default.get(a,"defaultFlow")||"main.flow.json",this.outputProcessors=[],this.errorHandlers=[],this.actions={},this.actionMetadataProviders=[],this.onBeforeCreated=(0,c.default)(),this.onAfterCreated=(0,c.default)(),this.onBeforeEnd=(0,c.default)(),this.onBeforeNodeEnter=(0,c.default)(),this.onBeforeSessionTimeout=(0,c.default)(),n.on("flowsChanged",function(){return Object.assign(r,{flows:[],flowsLoaded:!1})})}return a(e,[{key:"processMessage",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r){var n,o,a,u,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.flowsLoaded){e.next=4;break}return e.next=4,this.reloadFlows();case 4:return e.next=6,this._getOrCreateContext(t);case 6:return n=e.sent,e.next=9,this.stateManager.getState(t);case 9:if(o=e.sent,"bp_dialog_timeout"!==r.type){e.next=18;break}return e.next=13,this._processTimeout(t,o,n,r);case 13:if(o=e.sent,i.default.isNil(o)){e.next=17;break}return e.next=17,this.stateManager.setState(t,o);case 17:return e.abrupt("return",o);case 18:if(a=(r.text||"").substr(0,20),this._trace("<~","RECV",'"'+a+'"',n,o),n.currentFlow){e.next=22;break}throw new Error("Expected currentFlow to be defined for stateId="+t);case 22:if(!(u=i.default.get(n,"currentFlow.catchAll.onReceive"))){e.next=28;break}return this._trace("!!","KALL","",n,o),e.next=27,this._processInstructions(u,o,r,n);case 27:o=e.sent;case 28:if(!(s=i.default.get(n,"currentFlow.catchAll.next"))){e.next=41;break}this._trace("..","KALL","",n,o),c=0;case 32:if(!(c<s.length)){e.next=40;break}return e.next=35,this._evaluateCondition(s[c].condition,o,r);case 35:if(!e.sent){e.next=37;break}return e.abrupt("return",this._processNode(t,o,n,s[c].node,r));case 37:c++,e.next=32;break;case 40:this._trace("?X","KALL","",n,o);case 41:return e.next=43,this._processNode(t,o,n,n.node,r);case 43:if(o=e.sent,i.default.isNil(o)){e.next=47;break}return e.next=47,this.stateManager.setState(t,o);case 47:return e.abrupt("return",o);case 50:e.prev=50,e.t0=e.catch(0),this.errorHandlers.forEach(function(t){return t(e.t0)});case 53:case"end":return e.stop()}},e,this,[[0,50]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"jumpTo",value:function(){var t=f(regeneratorRuntime.mark(function t(r,n){var o,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments[3];return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=Object.assign({resetState:!1},i),this.flowsLoaded){t.next=4;break}return t.next=4,this.reloadFlows();case 4:return o=this._findFlow(n,!0),a&&e._findNode(o,a,!0),t.next=8,this._setContext(r,{currentFlow:o,node:a||o.startNode,hasJumped:!0,flowStack:[{flow:o.name,node:a||o.startNode}]});case 8:if(!i.resetState){t.next=11;break}return t.next=11,this.stateManager.setState(r,{});case 11:case"end":return t.stop()}},t,this)}));return function(e,r){return t.apply(this,arguments)}}()},{key:"getCurrentPosition",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getContext(t);case 2:if(!(r=e.sent)){e.next=5;break}return e.abrupt("return",{flow:r.currentFlow&&r.currentFlow.name,node:r.node});case 5:return e.abrupt("return",{flow:null,node:null});case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"endFlow",value:function(){var e=f(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._endFlow(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"reloadFlows",value:function(){var e=f(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._trace("**","LOAD",""),e.next=3,this.flowProvider.loadAll();case 3:this.flows=e.sent,this.flowsLoaded=!0;case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getFlows",value:function(){var e=f(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.flowsLoaded){e.next=3;break}return e.next=3,this.reloadFlows();case 3:return e.abrupt("return",this.flows);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"registerOutputProcessor",value:function(e){if(i.default.isNil(e)||!i.default.isFunction(e.send)||!i.default.isString(e.id))throw new Error("Invalid processor. Processor must have a function `send` defined and a valid `id`");this.outputProcessors=[e]}},{key:"registerActionMetadataProvider",value:function(e){if(!i.default.isFunction(e))throw new Error("Expected the function metadata provider to be a function");i.default.includes(this.actionMetadataProviders,e)||this.actionMetadataProviders.push(e)}},{key:"registerActions",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r,n=this,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r={},i.default.keys(t).forEach(function(e){if(n.actions[e]&&!o)throw new Error('There is already a function named "'+e+'" registered');var a=t[e],u=null;if(!i.default.isFunction(t[e])){if(!i.default.isObject(t[e])||!i.default.isFunction(t[e].handler))throw new Error('Expected function "'+e+"\" to be a function or an object with a 'hander' function");a=t[e].handler,u=Object.assign({},t[e],{name:e,handler:null})}var s=!0,c=!1,l=void 0;try{for(var f,d=n.actionMetadataProviders[Symbol.iterator]();!(s=(f=d.next()).done);s=!0){var p=(0,f.value)(e);if(p){u=Object.assign({},p,u||{});break}}}catch(e){c=!0,l=e}finally{try{!s&&d.return&&d.return()}finally{if(c)throw l}}r[e]={name:e,metadata:u,fn:a}}),Object.assign(this.actions,r);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"registerFunctions",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.registerActions(t,r));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAvailableActions",value:function(){return i.default.values(this.actions).filter(function(e){return!String(e.name).startsWith("__")}).map(function(e){return Object.assign({},e,{fn:null})})}},{key:"_processTimeout",value:function(){var t=f(regeneratorRuntime.mark(function t(r,n,o,a){var s,c,l,f,d,p=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s={stateId:r},t.next=3,u.default.fromCallback(function(e){return p.onBeforeSessionTimeout.run(s,e)});case 3:if(c=i.default.get(e._findNode(o.currentFlow,o.node),"timeoutNode"),l=i.default.get(o,"currentFlow.timeoutNode"),f=e._findNode(o.currentFlow,"timeout"),d=this._findFlow("timeout.flow.json"),!c){t.next=14;break}return this._trace("<>","SNDE","",o),t.next=11,this._processNode(r,n,o,c,a);case 11:n=t.sent,t.next=39;break;case 14:if(!l){t.next=21;break}return this._trace("<>","SFLW","",o),t.next=18,this._processNode(r,n,o,l,a);case 18:n=t.sent,t.next=39;break;case 21:if(!f){t.next=28;break}return this._trace("<>","DNDE","",o),t.next=25,this._processNode(r,n,o,f.name,a);case 25:n=t.sent,t.next=39;break;case 28:if(!d){t.next=35;break}return this._trace("<>","DFLW","",o),t.next=32,this._processNode(r,n,o,d.name,a);case 32:n=t.sent,t.next=39;break;case 35:return this._trace("<>","NTHG","",o),t.next=38,this._endFlow(r);case 38:n=t.sent;case 39:return t.abrupt("return",n);case 40:case"end":return t.stop()}},t,this)}));return function(e,r,n,o){return t.apply(this,arguments)}}()},{key:"_processNode",value:function(){var t=f(regeneratorRuntime.mark(function t(r,n,o,a,s){var c,l,f,d,h,g=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(c=!1,l=!1,o.hasJumped&&(o.hasJumped=!1,l=!0),f=o.currentFlow.name,o.node,p.test(a)?(this._trace(">>","FLOW",'"'+a+'"',o,null),o=this._gotoSubflow(a,o),c=!0):/^#/.test(a)?(this._trace("<<","FLOW",'"'+a+'"',o,null),o=this._gotoPreviousFlow(a,o),c=!0):o.node!==a?(this._trace(">>","FLOW",'"'+a+'"'),l=!0,o.node=a):i.default.isNil(o.node)&&(l=!0,o.node=o.currentFlow.startNode),(d=e._findNode(o.currentFlow,o.node))&&d.name){t.next=13;break}return t.next=10,this._endFlow(r);case 10:return n=t.sent,t.abrupt("return",n);case 13:if(!c&&!l){t.next=42;break}if(o.flowStack.push({flow:o.currentFlow.name,node:o.node}),o.flowStack=o.flowStack.filter(function(e,t){return t===o.flowStack.length-1||o.flowStack[t+1].flow!==e.flow}),!(o.flowStack.length>=100)){t.next=19;break}throw new Error("Exceeded maximum flow stack size (100).\n         This might be due to an unexpected infinite loop in your flows.\n         Current flow: "+o.currentFlow.name+"\n         Current node: "+o.node);case 19:return t.next=21,this._setContext(r,o);case 21:return h={stateId:r,node:d},t.next=24,u.default.fromCallback(function(e){return g.onBeforeNodeEnter.run(h,e)});case 24:if(!d.onEnter){t.next=29;break}return this._trace("!!","ENTR","",o,n),t.next=28,this._processInstructions(d.onEnter,n,s,o);case 28:n=t.sent;case 29:if(d.onReceive){t.next=40;break}if(this._trace("..","NOWT","",o,n),"skill-call"!==d.type||f===d.flow){t.next=37;break}return t.next=34,this._processNode(r,n,o,d.flow,s);case 34:n=t.sent,t.next=40;break;case 37:return t.next=39,this._transitionToNextNodes(d,o,n,r,s);case 39:n=t.sent;case 40:t.next=57;break;case 42:if(!d.onReceive){t.next=47;break}return this._trace("!!","RECV","",o,n),t.next=46,this._processInstructions(d.onReceive,n,s,o);case 46:n=t.sent;case 47:if(this._trace("..","RECV","",o,n),"skill-call"!==d.type||f===d.flow){t.next=54;break}return t.next=51,this._processNode(r,n,o,d.flow,s);case 51:n=t.sent,t.next=57;break;case 54:return t.next=56,this._transitionToNextNodes(d,o,n,r,s);case 56:n=t.sent;case 57:return t.abrupt("return",n);case 58:case"end":return t.stop()}},t,this)}));return function(e,r,n,o,a){return t.apply(this,arguments)}}()},{key:"_transitionToNextNodes",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r,n,o,a){var i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=t.next||[],u=0;case 2:if(!(u<i.length)){e.next=15;break}return e.next=5,this._evaluateCondition(i[u].condition,n,a);case 5:if(!e.sent){e.next=12;break}if(this._trace("??","MTCH",'cond = "'+i[u].condition+'"',r),!/^end$/i.test(i[u].node)){e.next=11;break}return e.abrupt("return",this._endFlow(o));case 11:return e.abrupt("return",this._processNode(o,n,r,i[u].node,a));case 12:u++,e.next=2;break;case 15:if(i.length){e.next=17;break}return e.abrupt("return",this._endFlow(o));case 17:return e.abrupt("return",n);case 18:case"end":return e.stop()}},e,this)}));return function(t,r,n,o,a){return e.apply(this,arguments)}}()},{key:"_endFlow",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={stateId:t},e.next=3,u.default.fromCallback(function(e){return n.onBeforeEnd.run(r,e)});case 3:return this._trace("--","ENDF","",null,null),e.next=6,this.stateManager.deleteState(t,["context"]);case 6:return e.abrupt("return",null);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getOrCreateContext",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r,n,a,i,s=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getContext(t);case 2:if((r=e.sent)&&r.currentFlow){e.next=16;break}return n={stateId:t,flowName:this.defaultFlow},e.next=7,u.default.fromCallback(function(e){return s.onBeforeCreated.run(n,e)});case 7:if(a=this._findFlow(n.flowName,!0)){e.next=10;break}throw new Error('Could not find the default flow "'+this.defaultFlow+'"');case 10:return r={currentFlow:a,flowStack:[{flow:a.name,node:a.startNode}]},e.next=13,this._setContext(t,r);case 13:return i=o({},n),e.next=16,u.default.fromCallback(function(e){return s.onAfterCreated.run(i,e)});case 16:return e.abrupt("return",r);case 17:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getContext",value:function(e){return this.stateManager.getState(e+"___context")}},{key:"_setContext",value:function(e,t){return this.stateManager.setState(e+"___context",t)}},{key:"_gotoSubflow",value:function(e,t){var r=e.match(p),o=n(r,3),a=o[1],u=o[2],s=this._findFlow(a,!0);return i.default.isNil(u)&&(u=s.startNode),Object.assign(t,{currentFlow:s,node:u}),t}},{key:"_gotoPreviousFlow",value:function(e,t){for(t.flowStack||(t.flowStack=[]);t.currentFlow.name===i.default.get(i.default.last(t.flowStack),"flow");)t.flowStack.pop();if(t.flowStack.length<1)this._trace("Flow tried to go back to previous flow but there was none. Exiting flow.",t,null);else{var r=i.default.last(t.flowStack),n=r.flow,o=r.node;"#"!==e&&(o=e.substr(1)),Object.assign(t,{currentFlow:this._findFlow(n,!0),node:o})}return t}},{key:"_processInstructions",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r,n,o){var a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.default.isArray(t)||(t=[t]),e.next=3,u.default.mapSeries(t,function(){var e=f(regeneratorRuntime.mark(function e(t){var u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.default.isString(t)||!t.startsWith("say ")){e.next=10;break}if(u=t.split(" "),s=i.default.slice(u,2).join(" "),!(u.length<2)){e.next=6;break}return a.trace('ERROR Invalid text instruction. Expected an instruction along "say #text Something"'),e.abrupt("return",r);case 6:return e.next=8,a._dispatchOutput({type:u[1],value:s},r,n,o);case 8:e.next=13;break;case 10:return e.next=12,a._invokeAction(t,r,n,o);case 12:r=e.sent;case 13:case"end":return e.stop()}},e,a)}));return function(t){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(t,r,n,o){return e.apply(this,arguments)}}()},{key:"_dispatchOutput",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r,n,o){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=String(t.type+(t.value||"")).substr(0,20),this._trace("~>","SEND",'"'+a+'"'),this.outputProcessors.forEach(function(e){e.send({message:t,state:r,originalEvent:n,flowContext:o})});case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n,o){return e.apply(this,arguments)}}()},{key:"_invokeAction",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r,n,o){var a,u,s,c,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=null,u={},!i.default.isString(t)){e.next=20;break}if(!t.includes(" ")){e.next=17;break}s=t.split(" "),c=i.default.tail(s).join(" "),a=i.default.first(s),e.prev=7,u=JSON.parse(c),u=i.default.mapValues(u,function(e){if(i.default.isString(e)&&e.startsWith("{{")&&e.endsWith("}}")){var t=e.substr(2,e.length-4);return i.default.get({state:r,s:r,event:n,e:n},t)}return e}),e.next=15;break;case 12:throw e.prev=12,e.t0=e.catch(7),new Error("ERROR function has invalid arguments (not a valid JSON string): "+c);case 15:e.next=18;break;case 17:a=t;case 18:e.next=21;break;case 20:this._trace("ERROR function is not a valid string");case 21:if(this.actions[a]){e.next=25;break}this._trace('ERROR function "'+a+'" not found',o,r),e.next=42;break;case 25:return e.prev=25,this._trace("!!","EXEC",'func "'+a+'"',o,r),e.next=29,this.actions[a].fn(Object.freeze(r),n,u||{});case 29:if(!(l=e.sent)||!i.default.isObject(l)){e.next=37;break}if(!Object.isFrozen(l)){e.next=35;break}this._trace('ERROR function "'+a+"\" returned the original (frozen) state. You should clone the state (see 'Object.assign()') instead of returning the original state.",o,r),e.next=37;break;case 35:return this._trace("!!","SSET","",o),e.abrupt("return",l);case 37:e.next=42;break;case 39:throw e.prev=39,e.t1=e.catch(25),new Error('ERROR function "'+a+'" thrown an error: '+(e.t1&&e.t1.message));case 42:return e.abrupt("return",r);case 43:case"end":return e.stop()}},e,this,[[7,12],[25,39]])}));return function(t,r,n,o){return e.apply(this,arguments)}}()},{key:"_evaluateCondition",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r,n){var o,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!/^true|always|yes$/i.test(t)&&""!==t){e.next=2;break}return e.abrupt("return",!0);case 2:return o=new s.VM({timeout:5e3}),i.default.keys(this.actions).forEach(function(e){o.freeze(a.actions[e].fn,e)}),o.freeze(r,"s"),o.freeze(r,"state"),o.freeze(n,"event"),o.freeze(n,"e"),e.prev=8,e.next=11,o.run(t);case 11:return e.t0=e.sent,e.abrupt("return",1==e.t0);case 15:throw e.prev=15,e.t1=e.catch(8),new Error('ERROR evaluating condition "'+t+'": '+e.t1.message);case 18:case"end":return e.stop()}},e,this,[[8,15]])}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_findFlow",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=i.default.find(this.flows,{name:e});if(t&&i.default.isNil(r))throw new Error('Could not find flow "'+e+'"');return r}},{key:"log",value:function(e,t,r){var n="Dialog: ["+(i.default.get(t,"currentFlow.name")||"NONE").replace(/\.flow\.json/i,"")+" – "+(t&&t.node||"NONE")+"]\t"+e;this.logger.debug(n)}},{key:"_trace",value:function(e,t,r,n){var o=(i.default.get(n,"currentFlow.name")||" N/A ").replace(/\.flow\.json/i,""),a=n&&n.node||" N/A ",u="Dialog: ["+(o=o.length>13?o.substr(0,13)+"&":o)+"] ("+(a=a.length>13?a.substr(0,13)+"&":a)+") "+i.default.repeat(" ",30-o.length-a.length)+" "+e+"  "+t+" \t "+r;this.logger.debug(u)}}],[{key:"_findNode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(r&&i.default.isNil(e))throw new Error("Could not find node "+t+" because the flow was not defined (null)");var n=i.default.find(e.nodes,{name:t});if(r&&i.default.isNil(t))throw new Error('Could not find node "'+t+'" in flow "'+e.name+'"');return n}}]),e}();e.exports=h},function(e,t,r){"use strict";var n=a(r(5)),o=a(r(0));function a(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e){var t,r,a,s,c=e.db,l=e.internals,f=void 0===l?{}:l,d=Object.assign({_isExpired:function(e){return!1}},f),p=(t=u(regeneratorRuntime.mark(function e(t,r){var o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.get();case 2:return o=e.sent,a={tableName:"dialog_sessions",stateId:t,state:JSON.stringify(r),now:(0,n.default)(o).date.now()},i=(0,n.default)(o).isLite()?"\n        INSERT OR REPLACE INTO :tableName: (id, state, active_on)\n        VALUES (:stateId, :state, :now)\n      ":"\n        INSERT INTO :tableName: (id, state, active_on, created_on)\n        VALUES (:stateId, :state, :now, :now)\n        ON CONFLICT (id) DO UPDATE\n          SET active_on = :now, state = :state\n      ",e.abrupt("return",o.raw(i,a));case 6:case"end":return e.stop()}},e,void 0)})),function(e,r){return t.apply(this,arguments)}),h=function(e){return{_stateId:e}},g=(r=u(regeneratorRuntime.mark(function e(t){var r,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.get();case 2:return r=e.sent,o=h(t),a={tableName:"dialog_sessions",stateId:t,state:JSON.stringify(o),now:(0,n.default)(r).date.now()},i=(0,n.default)(r).isLite()?"\n        INSERT OR REPLACE INTO :tableName: (id, state, active_on, created_on)\n        VALUES (:stateId, :state, :now, :now)\n      ":"\n        INSERT INTO :tableName: (id, state, active_on, created_on)\n        VALUES (:stateId, :state, :now, :now)\n        ON CONFLICT (id) DO UPDATE\n          SET created_on = :now, active_on = :now, state = :state\n      ",e.next=8,r.raw(i,a);case 8:return e.abrupt("return",o);case 9:case"end":return e.stop()}},e,void 0)})),function(e){return r.apply(this,arguments)});return{getState:(a=u(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.get();case 2:return r=e.sent,e.next=5,r("dialog_sessions").where({id:t}).limit(1).then().get(0).then();case 5:if(!(n=e.sent)){e.next=14;break}if(!d._isExpired(n)){e.next=11;break}return e.abrupt("return",g(t));case 11:return e.abrupt("return",JSON.parse(n.state));case 12:e.next=15;break;case 14:return e.abrupt("return",g(t));case 15:case"end":return e.stop()}},e,void 0)})),function(e){return a.apply(this,arguments)}),setState:function(e,t){if(o.default.isNil(t)&&(t=h(e)),!o.default.isPlainObject(t))throw new Error("State must be a plain object");return p(e,t)},deleteState:(s=u(regeneratorRuntime.mark(function e(t){var r,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["context"];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.get();case 2:return r=e.sent,n=[t].concat(i(o.map(function(e){return t+"___"+e}))),e.next=6,r("dialog_sessions").whereIn("id",n).del().then();case 6:case"end":return e.stop()}},e,void 0)})),function(e){return s.apply(this,arguments)})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=f(r(1)),i=(f(r(2)),f(r(8)),f(r(0))),u=f(r(4)),s=f(r(26)),c=f(r(9)),l=r(24);function f(e){return e&&e.__esModule?e:{default:e}}function d(e){return function(){var t=e.apply(this,arguments);return new u.default(function(e,r){return function n(o,a){try{var i=t[o](a),s=i.value}catch(e){return void r(e)}if(!i.done)return u.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}var p=function(e){function t(e){var r=e.logger,n=e.botfile,o=e.projectLocation,i=e.ghostManager;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{wildcard:!0,maxListeners:100}));return u.logger=r,u.botfile=n,u.projectLocation=o,u.ghostManager=i,u.flowsDir=u.botfile.flowsDir||"./flows",c.default.sync(a.default.dirname(u.flowsDir)),u.ghostManager.addRootFolder(u.flowsDir,{filesGlob:"**/*.json"}),u}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),o(t,[{key:"loadAll",value:function(){var e=d(regeneratorRuntime.mark(function e(){var t,r,o=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ghostManager.directoryListing(this.flowsDir,".flow.json");case 2:return t=e.sent,e.next=5,u.default.map(t,function(){var e=d(regeneratorRuntime.mark(function e(t){var r,a,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=JSON,e.next=3,o.ghostManager.readFile(o.flowsDir,t);case 3:if(e.t1=e.sent,r=e.t0.parse.call(e.t0,e.t1),a=(0,l.validateFlowSchema)(r),r&&!a){e.next=8;break}return e.abrupt("return",r?o.logger.warn(a):null);case 8:return e.t2=JSON,e.next=11,o.ghostManager.readFile(o.flowsDir,o._uiPath(t));case 11:return e.t3=e.sent,u=e.t2.parse.call(e.t2,e.t3),Object.assign(r,{links:u.links}),s=-1,r.nodes=r.nodes.map(function(e){var t=i.default.get(i.default.find(u.nodes,{id:e.id}),"position");return s=t?s:s+1,n({},e,{x:t?t.x:50+250*s,y:t?t.y:(i.default.maxBy(r.nodes,"y")||{y:0}).y+250})}),e.abrupt("return",n({name:t,location:t,nodes:i.default.filter(r.nodes,function(e){return!!e})},i.default.pick(r,"version","catchAll","startNode","links","skillData")));case 17:case"end":return e.stop()}},e,o)}));return function(t){return e.apply(this,arguments)}}());case 5:return r=e.sent,e.abrupt("return",r.filter(Boolean));case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"saveFlows",value:function(){var e=d(regeneratorRuntime.mark(function e(t){var r,n,o,a,s,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.find(function(e){return"main.flow.json"===e.flow})){e.next=2;break}throw new Error("[Flow] Expected flows list to contain 'main.flow.json'");case 2:return e.next=4,u.default.mapSeries(t,function(e){return c._prepareSaveFlow(e)});case 4:return r=e.sent,n=i.default.flatten(r.map(function(e){var t=e.flowPath,r=e.uiPath,n=e.flowContent,o=e.uiContent;return[c.ghostManager.upsertFile(c.flowsDir,t,JSON.stringify(n,null,2)),c.ghostManager.upsertFile(c.flowsDir,r,JSON.stringify(o,null,2))]})),o=i.default.flatten(r.map(function(e){return[e.flowPath,e.uiPath]})),e.next=9,this.ghostManager.directoryListing(this.flowsDir,".json",o);case 9:return a=e.sent,s=a.map(function(e){return c.ghostManager.deleteFile(c.flowsDir,e)}),e.next=13,u.default.all(n.concat(s));case 13:this.emit("flowsChanged");case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_prepareSaveFlow",value:function(){var e=d(regeneratorRuntime.mark(function e(t){var r,o,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Object.assign({},t,{version:"0.1"}),!(r=(0,l.validateFlowSchema)(t))){e.next=4;break}throw new Error(r);case 4:return o={nodes:t.nodes.map(function(e){return{id:e.id,position:i.default.pick(e,"x","y")}}),links:t.links},a=n({},i.default.pick(t,"version","catchAll","startNode","skillData"),{nodes:t.nodes.map(function(e){return i.default.omit(e,"x","y","lastModified")})}),u=t.location,e.abrupt("return",{flowPath:u,uiPath:this._uiPath(u),flowContent:a,uiContent:o});case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_uiPath",value:function(e){return e.replace(/\.flow\.json/i,".ui.json")}}]),t}();t.default=p},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=u(r(1)),a=u(r(2)),i=u(r(0));function u(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.manager=t.manager,this.module=t.module,this.logger=t.logger,this.configLocation=t.configLocation}return n(e,[{key:"_getFileName",value:function(){return this.module.name.replace(/^@botpress(-)?\//i,"").replace(/^botpress(-)?/i,"").replace(o.default.delimiter,"_")+".json"}},{key:"_getOptions",value:function(){return this.module.options}},{key:"_hasDefaultConfig",value:function(){var e=o.default.resolve(this.module.path,"config.json");return a.default.existsSync(e)}},{key:"_readDefaultConfig",value:function(){var e=o.default.resolve(this.module.path,"config.json");return a.default.readFileSync(e,"utf8")}},{key:"loadAll",value:function(){var e=s(regeneratorRuntime.mark(function e(){var t,r,n,a=this,u=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.manager.loadAll(this._getFileName(),this._getOptions(),u);case 2:return t=e.sent,r=this._getFileName(),n=o.default.resolve(this.configLocation,r),i.default.mapValues(t,function(e,t){if("<<UPDATE_ME>>"===e){var r="["+a.module.name+'] Missing mandatory configuration for "'+t+'". \nYou can provide this value in "'+n+'"';throw a.logger.error(r),new Error(r)}}),e.abrupt("return",t);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.manager.get(this._getFileName(),t,this._getOptions(),r));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"bootstrap",value:function(){var e=s(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._hasDefaultConfig()){e.next=2;break}return e.abrupt("return");case 2:t=this._getFileName(),r=o.default.resolve(this.configLocation,t),n=this._readDefaultConfig(),a.default.writeFileSync(r,n,"utf8"),this.logger.info('Configuration for module "'+this.module.name+'" has been created at '+r);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"isConfigMissing",value:function(){var e=s(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._getFileName(),r=o.default.resolve(this.configLocation,t),e.abrupt("return",this._hasDefaultConfig()&&!a.default.existsSync(r));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}();t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=d(r(30)),a=d(r(0)),i=d(r(25)),u=d(r(1)),s=d(r(2)),c=d(r(27)),l=d(r(66)),f=r(3);function d(e){return e&&e.__esModule?e:{default:e}}function p(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var h={any:function(e,t){return t(e)},string:function(e,t){return"string"==typeof e&&t(e)},choice:function(e,t){return a.default.includes(t,e)},bool:function(e,t){return(!0===(0,i.default)(e)||!1===(0,i.default)(e))&&t(e)}},g={bool:function(e){return(0,i.default)(e)}},m={any:null,string:"",bool:!1},_=function(e,t){var r=a.default.keys(h);if(!e.type||!a.default.includes(r,e.type))throw new Error("Invalid type ("+(e.type||"")+") for config key ("+t+")");var n=e.validation||function(){return!0};if(void 0!==e.default&&!h[e.type](e.default,n))throw new Error("Invalid default value ("+e.default+") for ("+t+")");if(!e.default&&!a.default.includes(a.default.keys(m),e.type))throw new Error("Default value is mandatory for type "+e.type+" ("+t+")");return{type:e.type,required:e.required||!1,env:e.env||null,default:e.default||m[e.type],validation:n}},v=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f.isDeveloping){var r=o.default.object().keys({configLocation:o.default.string().min(1).required(),botfile:o.default.object().required(),logger:o.default.object().required()});o.default.assert(t,r,"Invalid constructor elements for Configuration Manager")}this.configLocation=t.configLocation,this.botfile=t.botfile,this.logger=t.logger,this._memoizedLoadAll=a.default.memoize(this._loadAll.bind(this))}return n(e,[{key:"_loadFromDefaultValues",value:function(e){return a.default.mapValues(e,function(e){return e.default})}},{key:"_loadFromConfigFile",value:function(e,t){var r=u.default.resolve(this.configLocation,e);if(s.default.existsSync(r)){var n=s.default.readFileSync(r,"utf8");return c.default.parse(n)}return{}}},{key:"_loadFromEnvVariables",value:function(e){var t={};return a.default.mapValues(process.env,function(r,n){if(!a.default.isNil(r)){var o=a.default.findKey(e,{env:n});o&&(t[o]=r)}}),t}},{key:"_loadAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=function(e){return a.default.mapValues(e,_)}(t);var r=this._loadFromDefaultValues(t);return Object.assign(r,this._loadFromConfigFile(e,t)),Object.assign(r,this._loadFromEnvVariables(t)),r=a.default.mapValues(r,function(e,r){var n=t[r].type;return g[n]?g[n](e):e})}},{key:"getModuleConfiguration",value:function(e){return new l.default({manager:this,module:e,configLocation:this.configLocation,logger:this.logger})}},{key:"loadAll",value:function(){var e=p(regeneratorRuntime.mark(function e(t,r){var n,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=o?this._memoizedLoadAll:this._loadAll,e.abrupt("return",n(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=p(regeneratorRuntime.mark(function e(t,r,n){var o,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.loadAll(t,n,a);case 2:return o=e.sent,e.abrupt("return",o[r]);case 4:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()}]),e}();t.default=v},function(e,t,r){"use strict";var n,o=r(26),a=(n=o)&&n.__esModule?n:{default:n};var i=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{wildcard:!0,maxListeners:100}))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),t}();e.exports=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=l(r(4)),a=l(r(11)),i=l(r(10)),u=l(r(6)),s=r(0),c=l(r(5));function l(e){return e&&e.__esModule?e:{default:e}}var f={timestampColumn:"created_on"};t.default=function(e){var t,r,l=e.db,d=e.logger,p=e.intervalMs,h=void 0===p?(0,u.default)("1m"):p,g=[],m=null,_=(t=regeneratorRuntime.mark(function e(t){var r,n,o=t.table,a=t.ttl,u=t.timestampColumn;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d.debug('[DB Janitor] Running for table "'+o+'"'),e.next=3,l.get();case 3:return r=e.sent,n=(0,c.default)(r).date.isBefore(u,(0,i.default)().subtract(a,"ms")),e.abrupt("return",r(o).where(n).del().then());case 6:case"end":return e.stop()}},e,void 0)}),r=function(){var e=t.apply(this,arguments);return new o.default(function(t,r){return function n(a,i){try{var u=e[a](i),s=u.value}catch(e){return void r(e)}if(!u.done)return o.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});t(s)}("next")})},function(e){return r.apply(this,arguments)}),v=function(){d.debug("[DB Janitor] Running tasks"),m?d.debug("[DB Janitor] Skipping the current run, previous operation still running"):m=o.default.each(g,_).catch(function(e){d.error("[DB Janitor] Error:",e.message)}).finally(function(){m=null})},b=null;return{start:function(){b||(b=setInterval(v,h),d.info("[DB Janitor] Started"))},add:function(e){d.debug('[DB Janitor] Added table "'+e.table+'"');var t=(0,a.default)();return g.push(Object.assign({id:t},f,e)),t},remove:function(e){var t=(0,s.findIndex)(g,{id:e});if(t<0)d.error('[DB Janitor] Unknown task ID "'+e+'"');else{var r=g.splice(t,1),o=n(r,1)[0].table;d.debug('[DB Janitor] Removed table "'+o+'"')}},stop:function(){clearInterval(b),b=null,d.info("[DB Janitor] Stopped")}}}},function(e,t,r){"use strict";n(r(0)),n(r(4)),n(r(5));function n(e){return e&&e.__esModule?e:{default:e}}e.exports={random:function(e,t,r){return e("content_items").where({categoryId:t}).orderBy(e.raw("random()")).limit(1).get(0)}}},function(e,t){e.exports=require("verror")},function(module,exports,__webpack_require__){"use strict";var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_verror=__webpack_require__(71),_lodash=__webpack_require__(0),_lodash2=_interopRequireDefault(_lodash),_bluebird=__webpack_require__(4),_bluebird2=_interopRequireDefault(_bluebird),_glob=__webpack_require__(8),_glob2=_interopRequireDefault(_glob),_mkdirp=__webpack_require__(9),_mkdirp2=_interopRequireDefault(_mkdirp),_nanoid=__webpack_require__(11),_nanoid2=_interopRequireDefault(_nanoid),_json=__webpack_require__(27),_json2=_interopRequireDefault(_json),_helpers=__webpack_require__(5),_helpers2=_interopRequireDefault(_helpers),_util=__webpack_require__(3);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new _bluebird2.default(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return _bluebird2.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var getNewItemId=function(e){return(e.renderer||e.id).replace(/^#/,"")+"-"+(0,_nanoid2.default)(6)},prepareDb=(_ref=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,_util.getInMemoryDb)(),e.next=3,t.schema.createTable("content_items",function(e){e.string("id").primary(),e.text("data"),e.text("formData"),e.text("metadata"),e.string("categoryId"),e.text("previewText"),e.string("createdBy"),e.timestamp("createdOn")});case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}},e,void 0)})),function(){return _ref.apply(this,arguments)}),_ref,defaults={contentDir:"./content",contentDataDir:"./content_data"};module.exports=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee23(_ref3){var botfile=_ref3.botfile,projectLocation=_ref3.projectLocation,logger=_ref3.logger,ghostManager=_ref3.ghostManager,categories,categoryById,fileById,getItemProviders,contentDir,contentDataDir,knex,transformItemDbToApi,transformItemApiToDb,listCategoryItems,dumpDataToFile,dumpAllDataToFiles,getCategorySchema,listAvailableCategories,resolveRefs,computeData,computeMetadata,computePreviewText,fillComputedProps,createOrUpdateCategoryItem,categoryItemsCount,deleteCategoryItems,getItemDefault,getItem,getItems,getItemsByMetadata,recomputeCategoriesMetadata,loadData,loadCategoryFromSchema,loadCategoriesFromPath,readDataForFile,init,registerGetItemProvider;return regeneratorRuntime.wrap(function _callee23$(_context24){for(;;)switch(_context24.prev=_context24.next){case 0:return categories=[],categoryById={},fileById={},getItemProviders={},contentDir=_path2.default.resolve(projectLocation,botfile.contentDir||defaults.contentDir),contentDataDir=_path2.default.resolve(projectLocation,botfile.contentDataDir||defaults.contentDataDir),_context24.next=8,prepareDb();case 8:return knex=_context24.sent,transformItemDbToApi=function(e){return e?_extends({},e,{data:JSON.parse(e.data),formData:JSON.parse(e.formData),metadata:(e.metadata||"").split("|").filter(function(e){return e.length>0})}):e},transformItemApiToDb=function(e){if(!e)return e;var t=_extends({},e);return"formData"in e&&(t.formData=JSON.stringify(e.formData)),"data"in e&&(t.data=JSON.stringify(e.data)),"metadata"in e&&(t.metadata="|"+(e.metadata||[]).filter(function(e){return!!e}).join("|")+"|"),t},listCategoryItems=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=a.from,u=void 0===i?0:i,s=a.count,c=void 0===s?50:s,l=a.searchTerm,f=a.orderBy,d=void 0===f?["createdOn"]:f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=knex("content_items"),t&&(n=n.where({categoryId:t})),l&&(n=n.where(function(){this.where("metadata","like","%"+l+"%").orWhere("formData","like","%"+l+"%").orWhere("id","like","%"+l+"%")})),e.next=5,(r=n).orderBy.apply(r,_toConsumableArray(d)).offset(u).limit(c).then();case 5:return o=e.sent,e.abrupt("return",o.map(transformItemDbToApi));case 7:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),dumpDataToFile=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,listCategoryItems(t,{count:1e4});case 2:return e.t0=function(e){return _lodash2.default.pick(e,"id","formData","createdBy","createdOn")},r=e.sent.map(e.t0),e.next=6,ghostManager.upsertFile(contentDataDir,fileById[t],JSON.stringify(r,null,2));case 6:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),dumpAllDataToFiles=function(){return _bluebird2.default.map(categories,function(e){var t=e.id;return dumpDataToFile(t)})},getCategorySchema=function(e){var t=_lodash2.default.find(categories,{id:e});return null==t?null:{json:t.jsonSchema,ui:t.uiSchema,title:t.title,description:t.description,renderer:t.renderer}},listAvailableCategories=function(){return _bluebird2.default.map(categories,(e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,knex("content_items").where({categoryId:t.id}).count("* as count").get(0).then(function(e){return e&&Number(e.count)||0});case 2:return r=e.sent,e.abrupt("return",{id:t.id,title:t.title,description:t.description,count:r,schema:getCategorySchema(t.id)});case 4:case"end":return e.stop()}},e,void 0)})),function(t){return e.apply(this,arguments)}));var e},resolveRefs=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",t);case 2:if(!Array.isArray(t)){e.next=4;break}return e.abrupt("return",_bluebird2.default.map(t,resolveRefs));case 4:if(!_lodash2.default.isObject(t)){e.next=6;break}return e.abrupt("return",_bluebird2.default.props(_lodash2.default.mapValues(t,resolveRefs)));case 6:if(!_lodash2.default.isString(t)){e.next=11;break}if(r=t.match(/^##ref\((.*)\)$/)){e.next=10;break}return e.abrupt("return",t);case 10:return e.abrupt("return",knex("content_items").select("formData").where("id",r[1]).then(function(e){if(!e||!e.length)throw new Error("Error resolving reference: ID "+r[1]+" not found.");return JSON.parse(e[0].formData)}).then(resolveRefs));case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),computeData=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=categoryById[t]){e.next=3;break}throw new Error("Unknown category "+t);case 3:return e.abrupt("return",n.computeData?n.computeData(r,computeData):r);case 4:case"end":return e.stop()}},e,void 0)}));return function(t,r){return e.apply(this,arguments)}}(),computeMetadata=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=categoryById[t]){e.next=3;break}throw new Error("Unknown category "+t);case 3:return e.abrupt("return",n.computeMetadata?n.computeMetadata(r,computeMetadata):[]);case 4:case"end":return e.stop()}},e,void 0)}));return function(t,r){return e.apply(this,arguments)}}(),computePreviewText=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=categoryById[t]){e.next=3;break}throw new Error("Unknown category "+t);case 3:return e.abrupt("return",n.computePreviewText?n.computePreviewText(r,computePreviewText):"No preview");case 4:case"end":return e.stop()}},e,void 0)}));return function(t,r){return e.apply(this,arguments)}}(),fillComputedProps=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r){e.next=2;break}throw new Error('"formData" must be a valid object');case 2:return e.next=4,resolveRefs(r);case 4:return n=e.sent,e.next=7,computeData(t.id,n);case 7:return o=e.sent,e.next=10,computeMetadata(t.id,n);case 10:return a=e.sent,e.next=13,computePreviewText(t.id,n);case 13:if(i=e.sent,_lodash2.default.isArray(a)){e.next=16;break}throw new Error("computeMetadata must return an array of strings");case 16:if(_lodash2.default.isString(i)){e.next=18;break}throw new Error("computePreviewText must return a string");case 18:if(null!=o){e.next=20;break}throw new Error("computeData must return a valid object");case 20:return e.abrupt("return",{data:o,metadata:a,previewText:i});case 21:case"end":return e.stop()}},e,void 0)}));return function(t,r){return e.apply(this,arguments)}}(),createOrUpdateCategoryItem=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a,i=t.itemId,u=t.categoryId,s=t.formData;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(u=u&&u.toLowerCase(),null!=(r=_lodash2.default.find(categories,{id:u}))){e.next=4;break}throw new Error('Category "'+u+'" is not a valid registered categoryId');case 4:return e.t0=_extends,e.t1={formData:s},e.next=8,fillComputedProps(r,s);case 8:if(e.t2=e.sent,n=(0,e.t0)(e.t1,e.t2),o=transformItemApiToDb(n),(a=!i)&&(i=getNewItemId(r)),a){e.next=18;break}return e.next=16,knex("content_items").update(o).where({id:i}).then();case 16:e.next=20;break;case 18:return e.next=20,knex("content_items").insert(_extends({},o,{createdBy:"admin",createdOn:(0,_helpers2.default)(knex).date.now(),id:i,categoryId:u}));case 20:return e.next=22,dumpDataToFile(u);case 22:return e.abrupt("return",i);case 23:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),categoryItemsCount=function(e){var t=knex("content_items");return e&&"all"!==e&&(t=t.where({categoryId:e})),t.count("id as count").then(function(e){var t=_slicedToArray(e,1)[0];return Number(t.count)})},deleteCategoryItems=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_lodash2.default.isArray(t)&&!_lodash2.default.some(t,function(e){return!_lodash2.default.isString(e)})){e.next=2;break}throw new Error("Expected an array of Ids to delete");case 2:return e.next=4,knex("content_items").whereIn("id",t).del().then();case 4:return e.abrupt("return",dumpAllDataToFiles());case 5:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),getItemDefault=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",knex("content_items").where({id:t}).get(0));case 1:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),getItem=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a,i,u,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=/-(.+)\((.*)\)$/i,n=t.match(r),o=void 0,!n){e.next=17;break}if(a=n[1].toLowerCase(),i=n[2],u=t.substr(0,t.length-n[0].length),s=getItemProviders[a]){e.next=10;break}throw new Error('Invalid content expression "'+t+'", did you forget to register the "'+a+'" provider?');case 10:return e.next=12,s(knex,u,i);case 12:if(o=e.sent,!_lodash2.default.isArray(o)){e.next=15;break}throw new Error('Provider "'+a+'" returned an array instead of an object');case 15:e.next=20;break;case 17:return e.next=19,getItemDefault(t);case 19:o=e.sent;case 20:if(o){e.next=22;break}return e.abrupt("return",null);case 22:return c=_lodash2.default.find(categories,{id:o.categoryId}),e.abrupt("return",_extends({},transformItemDbToApi(o),{categoryTitle:c.title,categorySchema:getCategorySchema(o.categoryId)}));case 24:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),getItems=function(e){return _bluebird2.default.map(e.split(","),getItem)},getItemsByMetadata=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,knex("content_items").where("metadata","like","%|"+t+"|%").then();case 2:return r=e.sent,e.abrupt("return",transformItemDbToApi(r));case 4:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),recomputeCategoriesMetadata=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.id,e.next=3,knex("content_items").select("id","formData").where("categoryId",r).then().each(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o=t.id,a=t.formData;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fillComputedProps(categoryById[r],JSON.parse(a));case 2:return n=e.sent,e.abrupt("return",knex("content_items").where("id",o).update(transformItemApiToDb(n)));case 4:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}},e,void 0)}),r=!0,n=!1,o=void 0,e.prev=4,a=categories[Symbol.iterator]();case 6:if(r=(i=a.next()).done){e.next=12;break}return u=i.value,e.delegateYield(t(u),"t0",9);case 9:r=!0,e.next=6;break;case 12:e.next=18;break;case 14:e.prev=14,e.t1=e.catch(4),n=!0,o=e.t1;case 18:e.prev=18,e.prev=19,!r&&a.return&&a.return();case 21:if(e.prev=21,!n){e.next=24;break}throw o;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}},e,void 0,[[4,14,18,26],[19,,21,25]])}));return function(){return e.apply(this,arguments)}}(),loadData=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.id+".json",fileById[t.id]=r,logger.debug("Loading data for "+t.id+" from "+r),n=[],e.prev=4,e.next=7,readDataForFile(r);case 7:n=e.sent,e.next=13;break;case 10:e.prev=10,e.t0=e.catch(4),logger.warn("Error reading data from "+r,e.t0);case 13:return e.next=15,_bluebird2.default.map(n,function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",_extends({},r,{categoryId:t.id,id:r.id||getNewItemId(t)}));case 1:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}());case 15:return n=e.sent,e.abrupt("return",_bluebird2.default.mapSeries(n,function(e){return knex("content_items").insert(transformItemApiToDb(e)).then()}));case 17:case"end":return e.stop()}},e,void 0,[[4,10]])}));return function(t){return e.apply(this,arguments)}}(),loadCategoryFromSchema=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(["id","title","jsonSchema"].forEach(function(e){if(_lodash2.default.isNil(t[e]))throw new Error('"'+e+'" is required but missing in schema')}),t.id=t.id.toLowerCase(),!categoryById[t.id]){e.next=5;break}throw new Error('There is already a form with id "'+t.id+'"');case 5:return t.jsonSchema.title||(t.jsonSchema.title=t.title),categoryById[t.id]=t,categories.push(t),e.next=10,loadData(t);case 10:return e.abrupt("return",t);case 11:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}(),loadCategoriesFromPath=function(){var _ref29=_asyncToGenerator(regeneratorRuntime.mark(function _callee20(file){var filePath,schemas,_iteratorNormalCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,schema;return regeneratorRuntime.wrap(function _callee20$(_context21){for(;;)switch(_context21.prev=_context21.next){case 0:if(filePath=_path2.default.resolve(contentDir,"./"+file),schemas=null,schemas=/\.json$/i.test(filePath)?_json2.default.parse(_fs2.default.readFileSync(filePath,"utf8")):eval("require")(filePath),_context21.prev=3,!_lodash2.default.isArray(schemas)){_context21.next=33;break}_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0,_context21.prev=8,_iterator2=schemas[Symbol.iterator]();case 10:if(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done){_context21.next=17;break}return schema=_step2.value,_context21.next=14,loadCategoryFromSchema(schema);case 14:_iteratorNormalCompletion2=!0,_context21.next=10;break;case 17:_context21.next=23;break;case 19:_context21.prev=19,_context21.t0=_context21.catch(8),_didIteratorError2=!0,_iteratorError2=_context21.t0;case 23:_context21.prev=23,_context21.prev=24,!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return();case 26:if(_context21.prev=26,!_didIteratorError2){_context21.next=29;break}throw _iteratorError2;case 29:return _context21.finish(26);case 30:return _context21.finish(23);case 31:_context21.next=35;break;case 33:return _context21.next=35,loadCategoryFromSchema(schemas);case 35:_context21.next=40;break;case 37:throw _context21.prev=37,_context21.t1=_context21.catch(3),new _verror.VError(_context21.t1,'Error registering Content Element "'+file+'"');case 40:case"end":return _context21.stop()}},_callee20,void 0,[[3,37],[8,19,23,31],[24,,26,30]])}));return function(e){return _ref29.apply(this,arguments)}}(),readDataForFile=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ghostManager.readFile(contentDataDir,t);case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return",[]);case 5:if(e.prev=5,n=JSON.parse(r),Array.isArray(n)){e.next=9;break}throw new Error(t+" expected to contain array, contents ignored");case 9:return logger.info("Read "+n.length+" item(s) from "+t),e.abrupt("return",n);case 13:return e.prev=13,e.t0=e.catch(5),logger.warn("Error reading data from "+t,e.t0),e.abrupt("return",[]);case 17:case"end":return e.stop()}},e,void 0,[[5,13]])}));return function(t){return e.apply(this,arguments)}}(),init=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _mkdirp2.default.sync(contentDataDir),e.next=3,ghostManager.addRootFolder(contentDataDir,{filesGlob:"**/*.json"});case 3:return e.next=5,_bluebird2.default.fromCallback(function(e){return(0,_glob2.default)("**/*.@(form.json|form.js|json|js)",{cwd:contentDir},e)});case 5:t=e.sent,r=!0,n=!1,o=void 0,e.prev=9,a=t[Symbol.iterator]();case 11:if(r=(i=a.next()).done){e.next=24;break}return u=i.value,e.prev=13,e.next=16,loadCategoriesFromPath(u);case 16:e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(13),new _verror.VError(e.t0,'[Content Manager] Could not register Content Element "'+u+'"');case 21:r=!0,e.next=11;break;case 24:e.next=30;break;case 26:e.prev=26,e.t1=e.catch(9),n=!0,o=e.t1;case 30:e.prev=30,e.prev=31,!r&&a.return&&a.return();case 33:if(e.prev=33,!n){e.next=36;break}throw o;case 36:return e.finish(33);case 37:return e.finish(30);case 38:return e.next=40,recomputeCategoriesMetadata();case 40:case"end":return e.stop()}},e,void 0,[[9,26,30,38],[13,18],[31,,33,37]])}));return function(){return e.apply(this,arguments)}}(),registerGetItemProvider=function(e,t){e=e.toLowerCase(),getItemProviders[e]=t},_context24.abrupt("return",{init:init,listAvailableCategories:listAvailableCategories,getCategorySchema:getCategorySchema,loadCategoryFromSchema:loadCategoryFromSchema,recomputeCategoriesMetadata:recomputeCategoriesMetadata,createOrUpdateCategoryItem:createOrUpdateCategoryItem,listCategoryItems:listCategoryItems,categoryItemsCount:categoryItemsCount,deleteCategoryItems:deleteCategoryItems,getItem:getItem,getItems:getItems,getItemsByMetadata:getItemsByMetadata,registerGetItemProvider:registerGetItemProvider});case 36:case"end":return _context24.stop()}},_callee23,void 0)}));return function(e){return _ref2.apply(this,arguments)}}()},function(e,t,r){"use strict";var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=i(r(0)),a=i(r(5));function i(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e){var t,r,i,s,c,l,f,d,p=e.db,h=(t=u(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return n=e.sent,e.abrupt("return",n("users_tags").select("userId").where({userId:t,tag:o.default.toUpper(r)}).limit(1).then(function(e){return e.length>0}));case 4:case"end":return e.stop()}},e,void 0)})),function(e,r){return t.apply(this,arguments)}),g=(r=u(regeneratorRuntime.mark(function e(t,r){var n,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return n=e.sent,r=o.default.toUpper(r),e.next=6,h(t,r);case 6:if(!e.sent){e.next=11;break}return e.next=9,n("users_tags").where({userId:t,tag:r}).update({userId:t,tag:r,value:i,tagged_on:(0,a.default)(n).date.now()}).then();case 9:e.next=13;break;case 11:return e.next=13,n("users_tags").insert({userId:t,tag:r,value:i,tagged_on:(0,a.default)(n).date.now()}).then();case 13:case"end":return e.stop()}},e,void 0)})),function(e,t){return r.apply(this,arguments)}),m=(i=u(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return n=e.sent,e.next=5,n("users_tags").where({userId:t,tag:o.default.toUpper(r)}).del().then();case 5:case"end":return e.stop()}},e,void 0)})),function(e,t){return i.apply(this,arguments)}),_=(s=u(regeneratorRuntime.mark(function e(t,r){var a,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return a=e.sent,e.abrupt("return",a("users_tags").select("value","tagged_on","tag").where({userId:t,tag:o.default.toUpper(r)}).limit(1).then().get(0).then(function(e){return e&&i?n({},e,{tagged_on:new Date(e.tagged_on)}):e&&e.value}));case 4:case"end":return e.stop()}},e,void 0)})),function(e,t){return s.apply(this,arguments)}),v=(c=u(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return r=e.sent,e.abrupt("return",r("users_tags").where({userId:t}).select("tag","value").then(function(e){return o.default.map(e,function(e){return{tag:e.tag,value:e.value}})}));case 4:case"end":return e.stop()}},e,void 0)})),function(e){return c.apply(this,arguments)}),b=(l=u(regeneratorRuntime.mark(function e(){var t,r,n,o,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return t=e.sent,r=(0,a.default)(t).isLite(),n=r?"group_concat(tag) as tags":"string_agg(tag, ',') as tags",o=t("users_tags").select("userId",t.raw(n)).groupBy("userId"),e.abrupt("return",t("users").leftJoin(t.raw("("+o.toString()+") AS t2"),"users.id","=","t2.userId").select("users.id","users.userId","users.platform","users.gender","users.timezone","users.locale","users.picture_url","users.first_name","users.last_name","users.created_on","t2.tags").orderBy("users.created_on","asc").offset(u).limit(i).then(function(e){return e.map(function(e){return Object.assign(e,{tags:e.tags&&e.tags.split(",")||[]})})}));case 7:case"end":return e.stop()}},e,void 0)})),function(){return l.apply(this,arguments)}),w=(f=u(regeneratorRuntime.mark(function e(t){var r,n,i,u,s,c,l,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return r=e.sent,t=o.default.filter(t,function(e){return o.default.isString(e)}).map(function(e){return e.toUpperCase()}),n=function(e){return r("users_tags").select("userId").where("tag",e)},i=(0,a.default)(r).isLite(),u=i?"group_concat(tag) as tags":"string_agg(tag, ',') as tags",s=r("users"),c=0,l=r("users_tags").select("userId",r.raw(u)).groupBy("userId"),t.forEach(function(e){var t="t"+ ++c;s=s.join(r.raw("("+n(e).toString()+") AS "+t),"users.id","=",t+".userId")}),e.abrupt("return",s.leftJoin(r.raw("("+l.toString()+") AS tt"),"users.id","=","tt.userId").select("users.userId as userId","users.platform as platform","users.gender as gender","users.timezone as timezone","users.locale as locale","users.picture_url as picture_url","users.first_name as first_name","users.last_name as last_name","users.created_on as created_on","tt.tags as tags").orderBy("users.created_on","asc").offset(d).limit(f).then(function(e){return e.map(function(e){return Object.assign(e,{tags:e.tags&&e.tags.split(",")||[]})})}));case 12:case"end":return e.stop()}},e,void 0)})),function(e){return f.apply(this,arguments)}),y=(d=u(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.get();case 2:return t=e.sent,e.abrupt("return",t("users").count("* as count").then().get(0).then(function(e){return parseInt(e&&e.count)}));case 4:case"end":return e.stop()}},e,void 0)})),function(){return d.apply(this,arguments)});return{tag:g,untag:m,hasTag:h,getTag:_,getTags:v,list:b,count:y,listWithTags:w}}},function(e,t){e.exports=require("util")},function(e,t,r){"use strict";var n=i(r(74)),o=i(r(0)),a=i(r(4));function i(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new a.default(function(e,r){return function n(o,i){try{var u=t[o](i),s=u.value}catch(e){return void r(e)}if(!u.done)return a.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}e.exports=function(e){var t,r,a=e.sendContent,i=e.db,s=(t=u(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.get();case 2:return r=e.sent,e.next=5,r("users").where({id:t}).orWhere("userId",t).limit(1).select("*");case 5:if((n=e.sent)&&!(n.length<=0)){e.next=8;break}throw new Error('User "'+t+'" not found in the database');case 8:return e.abrupt("return",n[0]);case 9:case"end":return e.stop()}},e,void 0)})),function(e){return t.apply(this,arguments)});return{sendToUser:(r=u(regeneratorRuntime.mark(function e(t,r,i){var u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o.default.isString(r)){e.next=2;break}throw new Error("Invalid renderer: "+r);case 2:if(!o.default.isString(t)){e.next=6;break}return e.next=5,s(t);case 5:t=e.sent;case 6:if(t&&t.id){e.next=8;break}throw new Error("Invalid user object: "+n.default.inspect(t));case 8:return u="This is not a real event, it has been forged by proactive.",c={platform:t.platform,user:t,type:"proactive",text:u,raw:{forged:!0,message:u,to:t&&t.id}},e.abrupt("return",a(c,r,i));case 11:case"end":return e.stop()}},e,void 0)})),function(e,t,n){return r.apply(this,arguments)})}}},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=u(r(28)),a=u(r(6)),i=u(r(0));function u(e){return e&&e.__esModule?e:{default:e}}var s,c,l=function(e){function t(e,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Error parsing bloc '"+e+"' at instruction "+(r+1)+": "+n));return o.bloc=e,o.instructionIndex=r,o.internalMessage=n,Error.captureStackTrace(o,t),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Error),t}(),f=function(e,t,r,o,u){var s=r.currentPlatform,c=r.throwIfNoPlatform;if(!s&&(void 0!==c&&c))throw new Error("You need to supply `currentplatform`");var f=function(e){var t=e.currentPlatform;return function(e){var r=e.instruction,o=e.index,a=(e.instructions,e.detectedPlatforms,e.blocName);if("string"==typeof r||i.default.isArray(r))return[{text:r}];var u=function(e,t){return"boolean"==typeof t?e===t:i.default.isArrayLike(t)?e?!i.default.isEmpty(t):i.default.isEmpty(t):e?!!t:!t};if(!i.default.isNil(r.if)&&!i.default.isNil(r.unless))throw new l(a,o,"Message can't be both 'if' and 'else'.");if(!i.default.isNil(r.unless)&&!u(!1,r.unless))return[];if(!i.default.isNil(r.if)&&!u(!0,r.if))return[];var s=Object.assign({},r);if(r.on)if("string"==typeof r.on){var c=r.on.toLowerCase().split("+").map(i.default.trim);if(!i.default.includes(c,t.toLowerCase()))return[];s.__platformSpecific=!0}else{if(!i.default.isPlainObject(r.on))throw new l(a,o,'"on" must be a string or a plain object but was a '+n(r.on));var f=i.default.mapKeys(r.on,function(e,t){return t.toLowerCase()});i.default.keys(f).forEach(function(e){e.indexOf("+")>=0&&i.default.split(e,"+").forEach(function(t){var r=i.default.trim(t);f[r]=i.default.merge({},f[r]||{},f[e])})}),s=Object.assign(s,f[t.toLowerCase()],{on:t})}return[s]}}({currentPlatform:s}),d=function(e){var t=e.currentPlatform,r=e.processors,n=e.incomingEvent;return function(e){var o=e.instruction,u=e.messages,s=e.blocName,c=[];i.default.isNil(o.wait)||c.push({__internal:!0,type:"wait",wait:i.default.isString(o.wait)?(0,a.default)(o.wait||1e3):parseInt(o.wait)||1e3}),i.default.isNil(o.typing)||(o.typing=i.default.isString(o.typing)?(0,a.default)(o.typing||1e3):parseInt(o.typing)||1e3);var l=i.default.omit(o,["unless","if","on","wait"]);if(!i.default.keys(l).length)return c;i.default.isArray(o.text)&&(o.text=i.default.sample(o.text));var f=t&&r[t];if(f){var d=f({instruction:o,messages:u,blocName:s,event:n});return d&&c.push(d),c}throw new Error("Unsupported platform: "+t)}}({currentPlatform:s,processors:o,incomingEvent:u});Array.isArray(e)||(e=[e]);var p=[],h=[],g=[];return i.default.forEach(e,function(r,n){var o=f({instruction:r,index:n,instructions:e,detectedPlatforms:h,blocName:t});o&&i.default.forEach(o,function(e){return g.push(e)})}),i.default.forEach(g,function(e){var r=d({instruction:e,messages:p,blocName:t});null!=r&&r.forEach(function(e){return p.push(e)})}),p},d=function e(t,r){return i.default.isString(t)?function(e,t){return o.default.parse(e),o.default.render(e,t)}(t,r):Array.isArray(t)?t.map(function(t){return e(t,r)}):i.default.isObject(t)?i.default.mapValues(t,function(t){return e(t,r)}):t};e.exports=(s=regeneratorRuntime.mark(function e(t){var r,n=t.rendererName,o=t.rendererFn,a=t.context,i=t.options,u=t.processors,s=t.incomingEvent;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=d,e.t1=d,e.next=4,o(a);case 4:return e.t2=e.sent,e.t3=a,e.t4=(0,e.t1)(e.t2,e.t3),e.t5=a,r=(0,e.t0)(e.t4,e.t5),e.abrupt("return",f(r,n,i,u,s));case 10:case"end":return e.stop()}},e,void 0)}),c=function(){var e=s.apply(this,arguments);return new Promise(function(t,r){return function n(o,a){try{var i=e[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});t(u)}("next")})},function(e){return c.apply(this,arguments)})},function(e,t,r){"use strict";var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=s(r(0)),a=s(r(4)),i=s(r(76)),u=s(r(75));function s(e){return e&&e.__esModule?e:{default:e}}function c(e){return function(){var t=e.apply(this,arguments);return new a.default(function(e,r){return function n(o,i){try{var u=t[o](i),s=u.value}catch(e){return void r(e)}if(!u.done)return a.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}e.exports=function(e){var t,r,s=e.logger,l=e.middlewares,f=e.db,d=e.contentManager,p=e.botfile,h={},g={},m=function(e){var t=e.platform,r=e.processOutgoing;if(!o.default.isString(t))throw new Error("[Renderers] Platform must be a string, got: "+t+".");if(h[t])throw new Error("[Renderers] Platform should only be registered once, platform: "+t+".");if(!o.default.isFunction(r))throw new Error("[Renderers] processOutgoing must be a function, platform: "+t+".");s.verbose("[Renderers] Enabled for "+t+"."),h[t]=r},_=function(e){var t=e.rendererFn,r=e.rendererName,n=e.context,o=e.outputPlatform,a=e.incomingEvent,u=void 0===a?null:a,s={throwIfNoPlatform:!0,currentPlatform:o};return(0,i.default)({rendererFn:t,rendererName:r,context:n,options:s,processors:h,incomingEvent:u})},v=(t=c(regeneratorRuntime.mark(function e(t,r){var n,o=r.rendererName,i=r.context,u=r.outputPlatform,s=r.incomingEvent;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_({rendererFn:t,rendererName:o,context:i,outputPlatform:u,incomingEvent:s});case 2:return n=e.sent,e.abrupt("return",a.default.mapSeries(n,function(e){return e.__internal?"wait"===e.type?a.default.delay(e.wait):void 0:l.sendOutgoing(e)}));case 4:case"end":return e.stop()}},e,void 0)})),function(e,r){return t.apply(this,arguments)}),b=(r=c(regeneratorRuntime.mark(function e(t,r){var n,a,i,u,c,l,f,h,m,_=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=r.startsWith("#")?r.substr(1):r,n={BOT_URL:p.botUrl},!r.startsWith("!")){e.next=18;break}return a=r.substr(1),e.next=6,d.getItem(a);case 6:if(i=e.sent){e.next=9;break}throw new Error('Could not find content item with ID "'+a+'" in the Content Manager');case 9:if(u=i.categoryId,c=d.getCategorySchema(u)){e.next=13;break}throw new Error('Could not find category "'+u+'" in the Content Manager for item with ID "'+a+'"');case 13:if(l=c.renderer,o.default.isString(l)&&l.startsWith("#")&&!(l.length<=1)){e.next=16;break}throw new Error("Invalid renderer '"+l+"' in category '"+u+"' of Content Manager.\n         A renderer must start with '#'");case 16:r=l.substr(1),Object.assign(n,o.default.isArray(i.data)?{items:i.data}:i.data);case 18:if(f=Object.assign(n,{user:t.user,event:o.default.pick(t,["raw","text","type","platform","user"])},_),h=g[r]){e.next=24;break}throw m="[Renderer] Renderer not defined (#"+r+")",s.error(m),new Error(m);case 24:return e.next=26,v(h,{rendererName:r,context:f,outputPlatform:t.platform,incomingEvent:t});case 26:return e.abrupt("return",{renderer:r,context:f,outputPlatform:t.platform});case 27:case"end":return e.stop()}},e,void 0)})),function(e,t){return r.apply(this,arguments)}),w={name:"rendering.instrumentation",type:"incoming",order:2,module:"botpress",description:"Built-in Botpress middleware that adds a `.reply` to events. Works with renderers.",handler:function(e,t){e.reply=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return b(e,t,r)},t()}},y=(0,u.default)({sendContent:b,db:f});return n({registerChannel:m,registerConnector:m,register:function(e,t){if(!o.default.isString(e))throw new Error("Renderer name must be a string, received "+e);e.startsWith("#")&&(e=e.substr(1)),g[e]=t},unregister:function(e){if(!o.default.isString(e))throw new Error("Renderer name must be a string, received "+e);e.startsWith("#")&&(e=e.substr(1)),delete g[e]},isRegistered:function(e){if(!o.default.isString(e))throw new Error("Renderer name must be a string, received "+e);return e.startsWith("#")&&(e=e.substr(1)),!!g[e]},incomingMiddleware:w},y)}},function(e,t,r){"use strict";var n=s(r(2)),o=s(r(1)),a=s(r(12)),i=s(r(6)),u=s(r(0));function s(e){return e&&e.__esModule?e:{default:e}}function c(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}e.exports=function(e){var t,r,s,l,f=(t=c(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=2;break}return e.abrupt("return",v);case 2:return t=y(),e.next=5,a.default.get(t+"/api/.well-known/public.key");case 5:return r=e.sent,(n=r.data)&&n.length&&(v=n),_.debug("[Cloud] Updated certificates"),e.abrupt("return",n);case 10:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)}),d=(r=c(regeneratorRuntime.mark(function e(){var t,r,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(k()){e.next=2;break}return e.abrupt("return");case 2:return t=x(),r=t.token,n=t.endpoint,o=m.env,i=m.botUrl,e.next=6,a.default.put(n+"/api/pairing/env",{botUrl:i,token:r,env:o}).then(function(){_.debug("[Cloud] Updated environment: "+o)}).catch(function(e){var t=u.default.get(e,"response.data.message")||e.message||"Unknown error";_.error("[Cloud] Could not update environment: "+t)});case 6:case"end":return e.stop()}},e,this)})),function(){return r.apply(this,arguments)}),p=(s=c(regeneratorRuntime.mark(function e(){var t,r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(k()){e.next=2;break}return e.abrupt("return");case 2:if(!b){e.next=4;break}return e.abrupt("return",b);case 4:return t=x(),r=t.endpoint,n=t.token,o=t.botId,b=a.default.get(r+"/api/bots/"+o+"/roles",{headers:{Authorization:"Bearer bot__"+n}}).then(function(e){var t=e.data.payload;return _.debug("[Cloud] Received roles: ",t),t}).catch(function(e){var t=u.default.get(e,"response.data.message")||e.message||"Unknown error";return _.error("[Cloud] Error receiving roles: "+t),null}),e.abrupt("return",b);case 7:case"end":return e.stop()}},e,this)})),function(){return s.apply(this,arguments)}),h=(l=c(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(k()){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,p();case 4:return r=e.sent,e.abrupt("return",t.reduce(function(e,t){var n=u.default.find(r,{name:t});return e[t]=n&&n.rules,e},{}));case 6:case"end":return e.stop()}},e,this)})),function(e){return l.apply(this,arguments)}),g=e.projectLocation,m=e.botfile,_=e.logger,v=null,b=null;function w(){var e=o.default.resolve(g,"bp-cloud.json");if(!n.default.existsSync(e))throw new Error('Could not find `bp-cloud.json` file at project root. Have you run "botpress cloud-pair" command?');return JSON.parse(n.default.readFileSync(e,"utf8"))}function y(){return w().endpoint}function x(){return u.default.pick(w(),["botId","endpoint","token","teamId"])}function k(){var e=o.default.resolve(g,"bp-cloud.json");return n.default.existsSync(e)}return setInterval(function(){return v=null},(0,i.default)("5 minutes")),setInterval(function(){return b=null},(0,i.default)("5 minutes")),{getCloudEndpoint:y,getBotEnv:function(){return m.env},getUserRoles:h,getCertificate:f,isPaired:k,getPairingInfo:x,updateRemoteEnv:d}}},function(e,t,r){"use strict";var n,o=r(2),a=(n=o)&&n.__esModule?n:{default:n},i=r(3);e.exports=function(e){return{getBotInformation:function(){var t=(0,i.resolveProjectFile)("package.json",e,!0),r=JSON.parse(a.default.readFileSync(t));return{name:r.name,version:r.version,description:r.description||"<no description>",author:r.author||"<no author>",license:r.license||"AGPL-v3.0"}}}}},function(e,t,r){"use strict";var n=c(r(1)),o=c(r(2)),a=c(r(4)),i=c(r(0)),u=c(r(16)),s=r(3);function c(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,r,c=e.projectLocation,l=e.bp,f=n.default.join(l.botpressPath,"./licenses"),d=a.default.method(function(e){var t=(0,s.resolveProjectFile)("package.json",c,!0),r=(0,s.resolveProjectFile)("LICENSE",c,!0),a="AGPL-3.0"===e?"LICENSE_AGPL3":"LICENSE_BOTPRESS",i=o.default.readFileSync(n.default.join(f,a)),u=JSON.parse(o.default.readFileSync(t));u.license=e,o.default.writeFileSync(r,i),o.default.writeFileSync(t,JSON.stringify(u,null,2))}),p=u.default.hear(/^BOT_LICENSE$/,function(e,t){var r=(0,s.resolveProjectFile)("package.json",c,!0),n=JSON.parse(o.default.readFileSync(r)),a=n.license,i="Bot:  "+n.name+"\nCreated by: "+n.author+"\nLicense: "+a+"\nBotpress: "+l.version,u=e.user&&e.user.id;l[e.platform]&&l[e.platform].sendText?l[e.platform].sendText(u,i):l.middlewares.sendOutgoing({platform:e.platform,type:"text",text:i,raw:{to:u,message:i,responseTo:e}})});return{getLicensing:(t=regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0,u=void 0,void 0,void 0,a=(0,s.resolveProjectFile)("package.json",c,!0),u=JSON.parse(o.default.readFileSync(a)).license,l=o.default.readFileSync(n.default.join(f,"LICENSE_AGPL3")).toString(),d=o.default.readFileSync(n.default.join(f,"LICENSE_BOTPRESS")).toString(),t={agpl:{name:"AGPL-3.0",licensedUnder:"AGPL-3.0"===u,text:l},botpress:{name:"Botpress",licensedUnder:u.toLowerCase().indexOf("botpress")>=0,text:d}},r=i.default.find(t,{licensedUnder:!0})||t.botpress,e.abrupt("return",{licensed:!0,name:r.name,status:"Active",text:r.text});case 3:case"end":return e.stop()}var a,u,l,d},e,void 0)}),r=function(){var e=t.apply(this,arguments);return new a.default(function(t,r){return function n(o,i){try{var u=e[o](i),s=u.value}catch(e){return void r(e)}if(!u.done)return a.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});t(s)}("next")})},function(){return r.apply(this,arguments)}),changeLicense:d,middleware:p,getFeatures:function(){return{}}}}},function(e,t,r){"use strict";var n,o=r(1),a=(n=o)&&n.__esModule?n:{default:n},i=r(3);e.exports=function(e){var t=e.botfile,r=(e.logger,e.ghostManager),n=e.projectLocation,o=a.default.resolve(n,t.mediaDir||"./media");r.addRootFolder(o,{isBinary:!0});var u,s;return{saveFile:(u=regeneratorRuntime.mark(function e(t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,i.safeId)(20)+"-"+a.default.basename(t),e.next=3,r.upsertFile(o,t,n);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}},e,void 0)}),s=function(){var e=u.apply(this,arguments);return new Promise(function(t,r){return function n(o,a){try{var i=e[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});t(u)}("next")})},function(e,t){return s.apply(this,arguments)}),readFile:function(e){return r.readFile(o,e)}}}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){return(0,a.default)(e).createTableIfNotExists("logs",function(e){e.increments("id"),e.string("level"),e.text("message"),e.timestamp("created_on")})}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){var t=(0,a.default)(e);return t.createTableIfNotExists("ghost_content",function(t){t.increments("id"),t.string("folder"),t.string("file"),t.text("content"),t.timestamp("modified_on").defaultTo(e.fn.now())}).then(function(){return t.createTableIfNotExists("ghost_revisions",function(t){t.increments("id"),t.integer("content_id").references("ghost_content.id"),t.string("revision"),t.timestamp("created_on").defaultTo(e.fn.now()),t.string("created_by")})})}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){return(0,a.default)(e).createTableIfNotExists("dialog_sessions",function(t){t.string("id").primary(),t.string("namespace"),t.text("state"),t.timestamp("created_on").defaultTo(e.fn.now()),t.timestamp("active_on")})}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){return(0,a.default)(e).createTableIfNotExists("notifications",function(e){e.string("id").unique(),e.string("message"),e.string("level"),e.string("module_id"),e.string("module_icon"),e.string("module_name"),e.string("redirect_url"),e.timestamp("created_on"),e.boolean("read"),e.boolean("archived")})}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){return(0,a.default)(e).createTableIfNotExists("users_tags",function(e){e.string("userId"),e.string("tag"),e.string("value"),e.timestamp("tagged_on"),e.unique(["userId","tag"])})}},function(e,t,r){"use strict";var n,o=r(5),a=(n=o)&&n.__esModule?n:{default:n};e.exports=function(e){return(0,a.default)(e).createTableIfNotExists("users",function(e){e.string("id").primary(),e.string("userId"),e.string("platform"),e.enu("gender",["unknown","male","female"]),e.integer("timezone"),e.string("picture_url"),e.string("first_name"),e.string("last_name"),e.string("locale"),e.timestamp("created_on")})}},function(e,t,r){"use strict";e.exports=[r(87),r(86),r(85),r(84),r(83),r(82)]},function(e,t){e.exports=require("lodash/pick")},function(e,t,r){"use strict";var n=l(r(4)),o=l(r(10)),a=l(r(22)),i=l(r(89)),u=l(r(88)),s=l(r(37)),c=l(r(1));function l(e){return e&&e.__esModule?e:{default:e}}function f(e){return function(){var t=e.apply(this,arguments);return new n.default(function(e,r){return function o(a,i){try{var u=t[a](i),s=u.value}catch(e){return void r(e)}if(!u.done)return n.default.resolve(s).then(function(e){o("next",e)},function(e){o("throw",e)});e(s)}("next")})}}var d,p=function(e,t){if(!e)throw new Error("You must initialize the database before");var r=c.default.join(t,"./migrations/");return n.default.mapSeries(u.default,function(t){return t(e)}).then(function(){return e.migrate.latest({directory:r})})},h=(d=f(regeneratorRuntime.mark(function e(t){var r,n,o,u=t.sqlite,s=t.postgres,c=t.botpressPath,l=t.logger;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={useNullAsDefault:!0},!s.enabled&&process.version.startsWith("v10.")&&l&&l.warn("[Compatibility Notice] You are trying to use node@10.x but it has compatibility issues with sqlite3 package. Please try either downgrading node to 8.x version or enabling postgres (read more at https://botpress.io/docs/latest/recipes/dbs/)."),n=s.enabled?{client:"pg",connection:s.connection||(0,i.default)(s,["host","port","user","password","database","ssl"])}:{client:"sqlite3",connection:{filename:u.location},pool:{afterCreate:function(e,t){e.run("PRAGMA foreign_keys = ON",t)}}},o=(0,a.default)(Object.assign(r,n)),e.next=6,p(o,c);case 6:return e.abrupt("return",o);case 7:case"end":return e.stop()}},e,void 0)})),function(e){return d.apply(this,arguments)});e.exports=function(e){var t,r,n,a=e.sqlite,i=e.postgres,u=e.logger,c=e.botpressPath,l=null,d=(t=f(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(l){e.next=4;break}return e.next=3,h({sqlite:a,postgres:i,botpressPath:c,logger:u});case 3:l=e.sent;case 4:return e.abrupt("return",l);case 5:case"end":return e.stop()}},e,void 0)})),function(){return t.apply(this,arguments)}),p=null,g=(r=f(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d();case 2:return t=e.sent,r=new s.default(t),e.next=6,r.bootstrap();case 6:return e.abrupt("return",r);case 7:case"end":return e.stop()}},e,void 0)})),function(){return r.apply(this,arguments)}),m=(n=f(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p||(p=g()),e.abrupt("return",p);case 2:case"end":return e.stop()}},e,void 0)})),function(){return n.apply(this,arguments)}),_={get:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return m().then(function(e){return e.get.apply(e,t)})},set:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return m().then(function(e){return e.set.apply(e,t)})}};return{get:d,saveUser:function(e){var t=e.id,r=e.platform,n=e.gender,a=void 0===n?"unknown":n,u=e.timezone,s=void 0===u?null:u,c=e.locale,l=void 0===c?null:c,f=e.picture_url,p=e.first_name,h=e.last_name,g=r+":"+t,m={id:g,userId:t,platform:r,gender:a,timezone:s,locale:l,created_on:(0,o.default)(new Date).toISOString(),picture_url:f,last_name:h,first_name:p};return d().then(function(e){var t=e("users").insert(m).where(function(){return this.select(e.raw(1)).from("users").where("id","=",g)});return i.enabled?t+=" on conflict (id) do nothing":t=t.toString().replace(/^insert/i,"insert or ignore"),e.raw(t)})},location:i.enabled?"postgres":a.location,get kvs(){return u&&u.warn("[Deprecation Notice] `bp.db.kvs` is deprecated and will be removed in Botpress 11. Please use `bp.kvs` directly instead."),_},_kvs:_}}},function(e,t,r){"use strict";var n=o(r(0));o(r(16));function o(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){return{middleware:{name:"fallback",type:"incoming",order:200,module:"botpress",description:"The built-in fallback handler. You may override this by implementing bp.fallbackHandler",handler:function(t,r){n.default.isFunction(e.fallbackHandler)&&e.fallbackHandler(t,r)}}}}},function(e,t,r){"use strict";var n=a(r(18)),o=a(r(16));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(){var e=(0,n.default)();return{hear:function(t,r){e(o.default.hear(t,r))},middleware:{name:"hear",type:"incoming",order:20,module:"botpress",description:"The built-in hear convenience middleware",handler:function(t,r){e.run(t,function(){r.apply(this,arguments)})}}}}},function(e,t,r){"use strict";var n=u(r(0)),o=u(r(11)),a=u(r(5)),i=r(3);function u(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var c=function(){var e=Error.prepareStackTrace;Error.prepareStackTrace=function(e,t){return t};var t=(new Error).stack;return Error.prepareStackTrace=e,t.shift(),t[1].getFileName()};e.exports=function(e){var t,r,u,l,f,d,p,h=e.knex,g=e.modules,m=e.logger,_=e.events,v=function(e,t){return{id:t.id,message:t.message,level:t.level,module_id:t.moduleId,module_icon:t.icon,module_name:t.name,redirect_url:t.url,created_on:(0,a.default)(e).date.now(),read:(0,a.default)(e).bool.false(),archived:(0,a.default)(e).bool.false()}},b=function(e,t){return{id:t.id,message:t.message,level:t.level,moduleId:t.module_id,icon:t.module_icon,name:t.module_name,url:t.redirect_url,date:new Date(t.created_on),sound:!1,read:(0,a.default)(e).bool.parse(t.read)}},w=(t=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").where({id:t}).update({read:(0,a.default)(h).bool.true()}).then());case 1:case"end":return e.stop()}},e,void 0)})),function(e){return t.apply(this,arguments)}),y=(r=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").update({read:(0,a.default)(h).bool.true()}).then());case 1:case"end":return e.stop()}},e,void 0)})),function(){return r.apply(this,arguments)}),x=(u=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").where({archived:(0,a.default)(h).bool.false()}).orderBy("created_on","DESC").limit(100).then(function(e){return e.map(function(e){return b(h,e)})}));case 1:case"end":return e.stop()}},e,void 0)})),function(){return u.apply(this,arguments)}),k=(l=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").where({archived:(0,a.default)(h).bool.true()}).orderBy("created_on","DESC").limit(100).then(function(e){return e.map(function(e){return b(h,e)})}));case 1:case"end":return e.stop()}},e,void 0)})),function(){return l.apply(this,arguments)}),R=(f=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").where({id:t}).update({archived:(0,a.default)(h).bool.true()}).then());case 1:case"end":return e.stop()}},e,void 0)})),function(e){return f.apply(this,arguments)}),E=(d=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",h("notifications").update({archived:(0,a.default)(h).bool.true()}).then());case 1:case"end":return e.stop()}},e,void 0)})),function(){return d.apply(this,arguments)}),j=(p=s(regeneratorRuntime.mark(function e(t){var r,a,u,s,l,f,d=t.message,p=t.redirectUrl,b=t.level,w=t.enableSound;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(d&&"string"==typeof d){e.next=2;break}throw new Error("'message' is mandatory and should be a string");case 2:return b=b&&"string"==typeof b&&n.default.includes(["info","error","success"],b.toLowerCase())?b.toLowerCase():"info",r=c(),a=r&&(0,i.resolveModuleRootPath)(r),u=n.default.find(g,function(e){return e.root===a}),s={moduleId:"botpress",icon:"view_module",name:"botpress",url:n.default.isString(p)?p:"/"},u&&(s={moduleId:u.name,icon:u.settings.menuIcon,name:u.settings.menuText,url:p},p&&"string"==typeof url||(s.url="/modules/"+u.name)),l={id:(0,o.default)(),message:d,level:b,moduleId:s.moduleId,icon:s.icon,name:s.name,url:s.url,date:new Date,sound:w||!1,read:!1},e.next=11,h("notifications").insert(v(h,l)).then();case 11:m&&(f="[notification::"+l.moduleId+"] "+l.message,(m[b]||m.info)(f)),_&&_.emit("notifications.new",l);case 13:case"end":return e.stop()}},e,void 0)})),function(e){return p.apply(this,arguments)});return{load:x,send:function(e){var t=e.message,r=e.url,n=e.level,o=e.sound;return j({message:t,redirectUrl:r,level:n,enableSound:o})},markAsRead:w,markAllAsRead:y,archiveAll:E,archive:R,getInbox:x,getArchived:k,create:j,_bindEvents:function(){var e;_.on("notifications.getAll",s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=_,e.next=3,x();case 3:e.t1=e.sent,e.t0.emit.call(e.t0,"notifications.all",e.t1);case 5:case"end":return e.stop()}},e,void 0)}))),_.on("notifications.read",(e=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w(t);case 2:return e.t0=_,e.next=5,x();case 5:e.t1=e.sent,e.t0.emit.call(e.t0,"notifications.all",e.t1);case 7:case"end":return e.stop()}},e,void 0)})),function(t){return e.apply(this,arguments)})),_.on("notifications.allRead",s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y();case 2:return e.t0=_,e.next=5,x();case 5:e.t1=e.sent,e.t0.emit.call(e.t0,"notifications.all",e.t1);case 7:case"end":return e.stop()}},e,void 0)}))),_.on("notifications.trashAll",s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,E();case 2:return e.t0=_,e.next=5,x();case 5:e.t1=e.sent,e.t0.emit.call(e.t0,"notifications.all",e.t1);case 7:case"end":return e.stop()}},e,void 0)})))}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,o=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=r(17),u=(n=i)&&n.__esModule?n:{default:n};function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,u.default),a(t,[{key:"login",value:function(){var e=s(regeneratorRuntime.mark(function e(t,r){arguments.length>2&&void 0!==arguments[2]&&arguments[2];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{success:!0,token:"none"});case 1:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"authenticateWithError",value:function(){var e=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{id:0,username:"admin",email:"admin@botpress.io",first_name:"Admin",last_name:"Admin",avatar_url:null,roles:["admin"]});case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAuthenticationInfo",value:function(){return{type:"none"}}},{key:"refreshToken",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,n,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.split(" "),n=o(r,2),a=n[0],i=n[1],"bearer"===a.toLowerCase()){e.next=3;break}return e.abrupt("return",{success:!1,reason:"Wrong scheme "+a+", expected Bearer"});case 3:return e.abrupt("return",{success:!0,token:i});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUserIdentity",value:function(){var e=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.authenticateWithError("bearer "+t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getJWTSecretOrCertificate",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}();t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=u(r(29)),i=u(r(17));function u(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var c=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),n=(r.cloud.getPairingInfo()||{}).botId;return r.botId=n,r.botEnv=r.cloud.getBotEnv(),r.endpoint=r.cloud.getCloudEndpoint(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),o(t,[{key:"login",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{success:!1,reason:"Root authentication is disabled when using Botpress Cloud [BPCLOUDERR]"});case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getAuthenticationInfo",value:function(){return{type:"cloud",botId:this.botId,botEnv:this.botEnv,endpoint:this.endpoint}}},{key:"authenticateWithError",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,o,i,u,s,c,l,f=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw new Error("Missing auth header");case 2:if(r=t.split(" "),o=n(r,2),i=o[0],u=o[1],"bearer"===i.toLowerCase()){e.next=5;break}throw new Error("Wrong scheme '"+i+"', expected Bearer");case 5:return e.next=7,this.cloud.getCertificate();case 7:if(s=e.sent,c="RS256",l=a.default.verify(u,s,{algorithms:[c]}),f||!l.identity_proof_only){e.next=12;break}return e.abrupt("return",!1);case 12:if(l.aud==="urn:bot/"+this.botId){e.next=14;break}return e.abrupt("return",!1);case 14:return e.abrupt("return",l.user);case 15:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"refreshToken",value:function(){var e=s(regeneratorRuntime.mark(function e(t){var r,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.split(" "),o=n(r,2),a=o[0],i=o[1],"bearer"===a.toLowerCase()){e.next=3;break}return e.abrupt("return",{success:!1,reason:"Wrong scheme '"+a+"', expected Bearer"});case 3:return e.abrupt("return",{success:!0,token:i});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUserIdentity",value:function(){var e=s(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.authenticateWithError("bearer "+t,!0));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getJWTSecretOrCertificate",value:function(){var e=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.cloud.getCertificate());case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}();t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=l(r(2)),i=l(r(1)),u=l(r(42)),s=l(r(29)),c=l(r(17));function l(e){return e&&e.__esModule?e:{default:e}}function f(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var d=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._bootstrapToken(),r.attempts={},r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,c.default),o(t,[{key:"_bootstrapToken",value:function(){var e="",t=i.default.join(this.dataLocation,"secret.key");a.default.existsSync(t)&&(e=a.default.readFileSync(t)),(!e||e.length<15)&&(e=u.default.randomBytes(256).toString(),a.default.writeFileSync(t,e),e=e),this.secret=e}},{key:"_buildToken",value:function(){var e=f(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",s.default.sign({user:t},this.secret,{issuer:"bot.root",expiresIn:this.securityConfig.tokenExpiry,algorithm:"HS256"}));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_attempt",value:function(e){var t=this.securityConfig,r=t.maxAttempts,n=t.resetAfter;return new Date-this.lastCleanTimestamp>=n&&(this.attempts={},this.lastCleanTimestamp=new Date),(this.attempts[e]||0)<r}},{key:"_login",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r){var n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=process.env.BOTPRESS_ADMIN_PASSWORD||this.securityConfig.password,"string"!=typeof t||"admin"!==t.toLowerCase()||"string"!=typeof r||r!==n){e.next=6;break}return this.attempts[o]=0,e.abrupt("return",{id:0,username:"admin",email:"admin@botpress.io",first_name:"Admin",last_name:"Admin",avatar_url:null,roles:["admin"]});case 6:return this.attempts[o]=(this.attempts[o]||0)+1,e.abrupt("return",null);case 8:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"login",value:function(){var e=f(regeneratorRuntime.mark(function e(t,r){var n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._attempt(o)){e.next=3;break}return e.abrupt("return",{success:!1,reason:"Too many login attempts. Try again later."});case 3:return e.next=5,this._login(t,r,o);case 5:if(!(n=e.sent)){e.next=13;break}return e.next=9,this._buildToken(n);case 9:return e.t0=e.sent,e.abrupt("return",{success:!0,token:e.t0});case 13:return e.abrupt("return",{success:!1,reason:"Bad username / password"});case 14:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"authenticateWithError",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r,o,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t||"invalid header").split(" "),o=n(r,2),a=o[0],i=o[1],"bearer"===a.toLowerCase()){e.next=3;break}throw new Error("Wrong scheme "+a+", expected Bearer");case 3:if(!(u=s.default.verify(i,this.secret,{algorithms:["HS256"]})).identity_proof_only){e.next=6;break}return e.abrupt("return",!1);case 6:return e.abrupt("return",u.user);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAuthenticationInfo",value:function(){return{type:"root"}}},{key:"refreshToken",value:function(){var e=f(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.authenticateWithError(t);case 3:return r=e.sent,e.next=6,this.buildToken(r);case 6:return e.t0=e.sent,e.abrupt("return",{success:!0,token:e.t0});case 10:return e.prev=10,e.t1=e.catch(0),e.abrupt("return",{success:!1,reason:e.t1.message||"The token is invalid or expired"});case 13:case"end":return e.stop()}},e,this,[[0,10]])}));return function(t){return e.apply(this,arguments)}}()},{key:"getUserIdentity",value:function(){var e=f(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.authenticateWithError("bearer "+t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getJWTSecretOrCertificate",value:function(){var e=f(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.secret);case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}();t.default=d},function(e,t,r){"use strict";var n,o,a=l(r(30)),i=l(r(96)),u=l(r(95)),s=l(r(94)),c=r(3);function l(e){return e&&e.__esModule?e:{default:e}}e.exports=(n=regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c.isDeveloping&&(r=a.default.object().keys({dataLocation:a.default.string().min(1).required(),projectLocation:a.default.string().min(1).required(),securityConfig:a.default.object().required(),db:a.default.object().required(),cloud:a.default.object().required(),logger:a.default.object().required()}),a.default.assert(t,r,"Invalid constructor elements for Authentication Provider")),e.t0=t.securityConfig.useCloud,!e.t0){e.next=6;break}return e.next=5,t.cloud.isPaired();case 5:e.t0=e.sent;case 6:if(n=e.t0,t.securityConfig.enabled){e.next=9;break}return e.abrupt("return",new s.default(t));case 9:if(!n){e.next=13;break}return e.abrupt("return",new u.default(t));case 13:return e.abrupt("return",new i.default(t));case 14:case"end":return e.stop()}},e,void 0)}),o=function(){var e=n.apply(this,arguments);return new Promise(function(t,r){return function n(o,a){try{var i=e[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});t(u)}("next")})},function(e){return o.apply(this,arguments)})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=c(r(31)),a=c(r(6)),i=c(r(4)),u=r(0),s=c(r(5));function c(e){return e&&e.__esModule?e:{default:e}}function l(e){return function(){var t=e.apply(this,arguments);return new i.default(function(e,r){return function n(o,a){try{var u=t[o](a),s=u.value}catch(e){return void r(e)}if(!u.done)return i.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}var f=(0,a.default)("2s"),d=1e3,p=function(e){function t(e){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.flushPromise=null,n.batches=[],n.doFlush=l(regeneratorRuntime.mark(function e(){var t,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.batches.shift(),e.prev=1,t&&t.length){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,n.db.get();case 6:return o=e.sent,e.next=9,o.batchInsert("logs",t,d).then();case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.batches.unshift(t);case 14:case"end":return e.stop()}},e,r,[[1,11]])})),n.flush=l(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.flushPromise){e.next=2;break}return e.abrupt("return");case 2:return n.flushPromise=n.doFlush(),e.next=5,n.flushPromise;case 5:n.flushPromise=null;case 6:case"end":return e.stop()}},e,r)})),n.name="DBLogger",n.db=e.db,e.janitor.add({table:"logs",ttl:e.ttl}),n.flushInterval=setInterval(n.flush,f),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default.Transport),n(t,[{key:"log",value:function(e,t,r,n){var o=this;(0,u.isEmpty)(r)||(t+=" (meta="+JSON.stringify(r)+")"),this.db.get().then(function(r){var a={level:e,message:t,created_on:(0,s.default)(r).date.format(new Date)};o.batches.length?o.batches[o.batches.length-1].push(a):o.batches.push([a]),o.emit("logged"),n(null,!0)}).catch(function(e){n(e,null)})}}],[{key:"_query",value:function(){var e=l(regeneratorRuntime.mark(function e(t){var r,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"desc";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get();case 2:return r=e.sent,n=r("logs").select("created_on as timestamp","level","message").orderBy("created_on",a),o&&(n=n.limit(o)),e.abrupt("return",n.then());case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),t}();t.default=p},function(e,t,r){"use strict";var n=c(r(10)),o=c(r(6)),a=c(r(31)),i=c(r(4)),u=r(3),s=c(r(98));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t=null,r=new a.default.Logger({level:u.isDeveloping?"debug":"info",transports:[new a.default.transports.Console({prettyPrint:!0,colorize:!0,timestamp:function(){return(0,n.default)().format("HH:mm:ss")}})]});return r.enableDbStorageIfNeeded=function(n){var a=n.db,i=n.janitor;if(e.enabled){t=a;var u=(0,o.default)((e.keepDays||30)+"days");r.add(s.default,{ttl:u,db:a,janitor:i})}},r.queryDb=function(r,n){return e.enabled?s.default._query(t,r,n):i.default.resolve([])},r}},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=c(r(0)),a=c(r(18)),i=c(r(1)),u=c(r(2)),s=c(r(4));function c(e){return e&&e.__esModule?e:{default:e}}var l=function(e,t){var r=(0,a.default)(),n=(0,a.default)();return{use:function(e){if("function"!=typeof e)throw new TypeError("Expected all middleware arguments to be functions");2===e.length?r(e):3===e.length&&n(e)},dispatch:function(a){if(!o.default.isPlainObject(a))throw new TypeError("Expected all dispatch arguments to be plain event objects");if(!o.default.conformsTo(a,{type:function(e){return"string"==typeof e},platform:function(e){return"string"==typeof e},text:function(e){return"string"==typeof e},raw:function(){return!0}}))throw new TypeError("Expected event to contain (type: string), (platform: string), (text: string), (raw: any)");return a.bp=e,r.run(a,function(r){r&&n.run(r,a,function(){e.logger.error("[BOTPRESS] Unhandled error in middleware ("+t+"). Error: "+r.message)})}),a._promise||s.default.resolve()}}};e.exports=function(e,t,r,a){var s=i.default.join(t,"middlewares.json"),c=function(e){var t="Middleware called before middlewares have been loaded. This is a no-op. Have you forgotten to call `bp.loadMiddlewares()` in your bot?";e&&"object"===(void 0===e?"undefined":n(e))&&(t+="\nCalled with: "+JSON.stringify(e,null,2)),a.warn(t)},f=c,d=c,p=(u.default.existsSync(s)||u.default.writeFileSync(s,"{}"),JSON.parse(u.default.readFileSync(s))),h=[],g=function(){u.default.writeFileSync(s,JSON.stringify(p))},m=function(){return o.default.orderBy(h.map(function(e){var t=p[e.name];return t?Object.assign({},e,t):e}),"order")},_=function(e){return function(t){var r="incoming"===e?f:d;return r.dispatch?r.dispatch(t):r(t)}};return{load:function(){f=l(e,"incoming"),d=l(e,"outgoing");var t=e.licensing.middleware;f.use(t),o.default.each(m(),function(e){if(!e.enabled)return a.debug("SKIPPING middleware:",e.name," [Reason=disabled]");a.debug("Loading middleware:",e.name),"incoming"===e.type?f.use(e.handler):d.use(e.handler)})},list:m,register:function(e){return e&&e.name?e.handler?!e.type||"incoming"!==e.type&&"outgoing"!==e.type?(a.error("A middleware type (incoming or outgoing) is required"),!1):(e.order=e.order||0,e.enabled=void 0===e.enabled||!!e.enabled,o.default.some(h,function(t){return t.name===e.name})?(a.error("Another middleware with the same name has already been registered"),!1):void h.push(e)):(a.error("A middleware handler is mandatory"),!1):(a.error("A unique middleware name is mandatory"),!1)},sendIncoming:function(t){return e.messages.in.enqueue(t)},sendOutgoing:function(t){return e.messages.out.enqueue(t)},sendIncomingImmediately:_("incoming"),sendOutgoingImmediately:_("outgoing"),getCustomizations:function(){return p},setCustomizations:function(e){o.default.each(e,function(e){var t=e.name,r=e.order,n=e.enabled;p[t]={order:r,enabled:n}}),g()},resetCustomizations:function(){p={},g()}}}},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("source-map-support/register")},function(module,exports,__webpack_require__){"use strict";var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();__webpack_require__(103);var _chalk=__webpack_require__(7),_chalk2=_interopRequireDefault(_chalk),_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_lodash=__webpack_require__(0),_lodash2=_interopRequireDefault(_lodash),_cluster=__webpack_require__(102),_cluster2=_interopRequireDefault(_cluster),_dotenv=__webpack_require__(101),_dotenv2=_interopRequireDefault(_dotenv),_ms=__webpack_require__(6),_ms2=_interopRequireDefault(_ms),_middlewares=__webpack_require__(100),_middlewares2=_interopRequireDefault(_middlewares),_logger=__webpack_require__(99),_logger2=_interopRequireDefault(_logger),_security=__webpack_require__(97),_security2=_interopRequireDefault(_security),_notifications=__webpack_require__(93),_notifications2=_interopRequireDefault(_notifications),_hear=__webpack_require__(92),_hear2=_interopRequireDefault(_hear),_fallback=__webpack_require__(91),_fallback2=_interopRequireDefault(_fallback),_database=__webpack_require__(90),_database2=_interopRequireDefault(_database),_ghostContent=__webpack_require__(33),_ghostContent2=_interopRequireDefault(_ghostContent),_mediaManager=__webpack_require__(81),_mediaManager2=_interopRequireDefault(_mediaManager),_licensing=__webpack_require__(80),_licensing2=_interopRequireDefault(_licensing),_about=__webpack_require__(79),_about2=_interopRequireDefault(_about),_modules=__webpack_require__(19),_modules2=_interopRequireDefault(_modules),_cloud=__webpack_require__(78),_cloud2=_interopRequireDefault(_cloud),_renderers=__webpack_require__(77),_renderers2=_interopRequireDefault(_renderers),_users=__webpack_require__(73),_users2=_interopRequireDefault(_users),_service=__webpack_require__(72),_service2=_interopRequireDefault(_service),_getItemProviders=__webpack_require__(70),_getItemProviders2=_interopRequireDefault(_getItemProviders),_helpers=__webpack_require__(40),_helpers2=_interopRequireDefault(_helpers),_janitor=__webpack_require__(69),_janitor2=_interopRequireDefault(_janitor),_stats=__webpack_require__(14),_stats2=_interopRequireDefault(_stats),_bus=__webpack_require__(68),_bus2=_interopRequireDefault(_bus),_configManager=__webpack_require__(67),_configManager2=_interopRequireDefault(_configManager),_provider=__webpack_require__(65),_provider2=_interopRequireDefault(_provider),_state=__webpack_require__(64),_state2=_interopRequireDefault(_state),_engine=__webpack_require__(63),_engine2=_interopRequireDefault(_engine),_processors=__webpack_require__(61),_processors2=_interopRequireDefault(_processors),_janitor3=__webpack_require__(60),_janitor4=_interopRequireDefault(_janitor3),_skills=__webpack_require__(59),_skills2=_interopRequireDefault(_skills),_memory=__webpack_require__(58),_memory2=_interopRequireDefault(_memory),_package=__webpack_require__(41),_package2=_interopRequireDefault(_package),_server=__webpack_require__(57),_server2=_interopRequireDefault(_server),_util=__webpack_require__(3);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var RESTART_EXIT_CODE=107,mkdirIfNeeded=function(e,t){if(!_fs2.default.existsSync(e)){t.info("Creating data directory: "+e);try{_fs2.default.mkdirSync(e)}catch(e){t.error("[FATAL] Error creating directory: "+e.message),process.exit(1)}}},REQUIRED_PROPS=["botUrl"],validateBotfile=function(e){if("disableFileLogs"in e||_lodash2.default.get(e,"log.file"))throw console.log("\n      You're using the old logs configuration format.\n      Since v11 botpress has stopped storing logs in files and\n      has moved them to the database.\n\n      Please update your botfile.\n\n      Old configuration format:\n        /*\n          By default logs are enabled and available in dataDir\n        */\n        disableFileLogs: false,\n        log: {\n          file: 'bot.log',\n          maxSize: 1e6 // 1mb\n        }\n\n      New format:\n        /*\n          By default logs are enabled and stored in the DB for 30 days\n        */\n        logs: {\n          enabled: true,\n          keepDays: 30\n        }\n      "),new Error("Outdated botfile format");var t=!0,r=!1,n=void 0;try{for(var o,a=REQUIRED_PROPS[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var i=o.value;if(!(i in e))throw new Error("Missing required botpress setting: "+i)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}},botpress=function(){function botpress(_ref){var _this=this,botfile=_ref.botfile,_ref$options=_ref.options,options=void 0===_ref$options?{}:_ref$options;_classCallCheck(this,botpress),this.start=function(){if(_cluster2.default.isMaster){var e=!1,t=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;_this.stopServer&&_this.stopServer(),process.exit(e)},r=function(r){r&&"starting"===r.workerStatus?e?((0,_util.print)("info","*** restarted worker process ***"),_this.stats.track("bot","restarted")):e=!0:"exit"===r.type&&t()};_cluster2.default.on("exit",function(e,n){n===RESTART_EXIT_CODE?_cluster2.default.fork().on("message",r):t(n)}),_cluster2.default.fork().on("message",r)}_cluster2.default.isWorker&&(process.send({workerStatus:"starting"}),_this._start().catch(function(e){(0,_util.print)("error","Error starting botpress: ",e.message,e.stack)}))},this.version=(0,_util.getBotpressVersion)(),this.projectLocation=_path2.default.dirname(botfile),this._setupEnv(),this.botfile=eval("require")(botfile),validateBotfile(this.botfile),this.stats=(0,_stats2.default)(this.botfile),this.interval=null;var opts=_lodash2.default.result(options,"opts")||{};this.hasInspectMode=opts.inspect||opts.i}return _createClass(botpress,[{key:"_start",value:function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(){var _this2=this,projectLocation,botfile,isFirstRun,dataLocation,configLocation,dbLocation,version,logger,db,janitor,kvs,cloud,configManager,security,modules,moduleDefinitions,events,notifications,about,licensing,middlewares,_createHearMiddleware,hear,hearMiddleware,_createFallbackMiddle,fallbackMiddleware,users,ghostManager,contentManager,mediaManager,renderers,stateManager,flowProvider,dialogJanitor,dialogEngine,skillsManager,incomingQueue,outgoingQueue,messages,loadedModules,server,middlewareAutoLoading,projectEntry;return regeneratorRuntime.wrap(function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return this.stats.track("bot","started"),this.interval||(this.interval=setInterval(function(){_this2.stats.track("bot","running")},3e4)),this.botpressPath=_path2.default.join(__dirname,"../"),projectLocation=this.projectLocation,botfile=this.botfile,isFirstRun=_fs2.default.existsSync(_path2.default.join(projectLocation,".welcome")),dataLocation=(0,_util.getDataLocation)(botfile.dataDir,projectLocation),configLocation=(0,_util.getDataLocation)(botfile.modulesConfigDir,projectLocation),dbLocation=_path2.default.join(dataLocation,"db.sqlite"),version=_package2.default.version,logger=(0,_logger2.default)(botfile.logs),mkdirIfNeeded(dataLocation,logger),mkdirIfNeeded(configLocation,logger),db=(0,_database2.default)({sqlite:{location:dbLocation},postgres:botfile.postgres,logger:logger,botpressPath:this.botpressPath}),_context.next=15,db.get();case 15:return janitor=(0,_janitor2.default)({db:db,logger:logger}),logger.enableDbStorageIfNeeded({db:db,janitor:janitor}),logger.info("Starting botpress version "+version),janitor.start(),kvs=db._kvs,_context.next=22,(0,_cloud2.default)({projectLocation:projectLocation,botfile:botfile,logger:logger});case 22:if(cloud=_context.sent,_context.t0=!!botfile.login.useCloud,!_context.t0){_context.next=28;break}return _context.next=27,cloud.isPaired();case 27:_context.t0=_context.sent;case 28:if(!_context.t0){_context.next=31;break}setInterval(function(){return cloud.updateRemoteEnv()},(0,_ms2.default)("10m")),cloud.updateRemoteEnv();case 31:return configManager=new _configManager2.default({configLocation:configLocation,botfile:botfile,logger:logger}),_context.next=34,(0,_security2.default)({dataLocation:dataLocation,securityConfig:botfile.login,projectLocation:projectLocation,db:db,cloud:cloud,logger:logger});case 34:return security=_context.sent,modules=(0,_modules2.default)(logger,projectLocation,dataLocation,configManager),moduleDefinitions=modules._scan(),events=new _bus2.default,_context.t1=_notifications2.default,_context.next=41,db.get();case 41:return _context.t2=_context.sent,_context.t3=moduleDefinitions,_context.t4=logger,_context.t5=events,_context.t6={knex:_context.t2,modules:_context.t3,logger:_context.t4,events:_context.t5},notifications=(0,_context.t1)(_context.t6),about=(0,_about2.default)(projectLocation),licensing=(0,_licensing2.default)({logger:logger,projectLocation:projectLocation,version:version,db:db,botfile:botfile,bp:this}),middlewares=(0,_middlewares2.default)(this,dataLocation,projectLocation,logger),_createHearMiddleware=(0,_hear2.default)(),hear=_createHearMiddleware.hear,hearMiddleware=_createHearMiddleware.middleware,_createFallbackMiddle=(0,_fallback2.default)(this),fallbackMiddleware=_createFallbackMiddle.middleware,users=(0,_users2.default)({db:db}),ghostManager=(0,_ghostContent2.default)({projectLocation:projectLocation,logger:logger,db:db,enabled:!!_lodash2.default.get(botfile,"ghostContent.enabled")}),_context.next=56,(0,_service2.default)({logger:logger,projectLocation:projectLocation,botfile:botfile,ghostManager:ghostManager});case 56:return contentManager=_context.sent,_context.next=59,(0,_mediaManager2.default)({botfile:botfile,logger:logger,ghostManager:ghostManager,projectLocation:projectLocation});case 59:return mediaManager=_context.sent,Object.keys(_getItemProviders2.default).forEach(function(e){contentManager.registerGetItemProvider(e,_getItemProviders2.default[e])}),renderers=(0,_renderers2.default)({logger:logger,middlewares:middlewares,db:db,contentManager:contentManager,botfile:botfile}),stateManager=(0,_state2.default)({db:db}),flowProvider=new _provider2.default({logger:logger,projectLocation:projectLocation,botfile:botfile,ghostManager:ghostManager}),dialogJanitor=new _janitor4.default({db:db,middlewares:middlewares,botfile:botfile}),dialogEngine=new _engine2.default({flowProvider:flowProvider,stateManager:stateManager,logger:logger}),skillsManager=new _skills2.default({logger:logger}),dialogEngine.onError(function(e){var t=e.message;return notifications.create({message:"DialogEngine: "+t,level:"error",redirectUrl:"/logs"})}),dialogEngine.registerOutputProcessor(_processors2.default.default),dialogJanitor.install(),incomingQueue=new _memory2.default("Incoming",logger,{redis:botfile.redis}),incomingQueue.subscribe(function(e){return middlewares.sendIncomingImmediately(e.event)}),outgoingQueue=new _memory2.default("Outgoing",logger,{redis:botfile.redis}),outgoingQueue.subscribe(function(e){return middlewares.sendOutgoingImmediately(e.event)}),messages={in:{enqueue:function(e){return incomingQueue.enqueue({event:e})},cancelAll:function(e){return incomingQueue.cancelAll({event:e})},peek:function(e){return incomingQueue.peek({event:e})}},out:{enqueue:function(e){return outgoingQueue.enqueue({event:e})},cancelAll:function(e){return outgoingQueue.cancelAll({event:e})},peek:function(e){return outgoingQueue.peek({event:e})}}},middlewares.register(renderers.incomingMiddleware),middlewares.register(hearMiddleware),middlewares.register(fallbackMiddleware),_lodash2.default.assign(this,{dataLocation:dataLocation,isFirstRun:isFirstRun,version:version,logger:logger,security:security,events:events,notifications:notifications,about:about,middlewares:middlewares,hear:hear,licensing:licensing,modules:modules,db:db,janitor:janitor,kvs:kvs,configManager:configManager,cloud:cloud,renderers:renderers,users:users,ghostManager:ghostManager,contentManager:contentManager,mediaManager:mediaManager,dialogEngine:dialogEngine,dialogJanitor:dialogJanitor,messages:messages,skills:skillsManager}),Object.defineProperty(this,"umm",{get:function(){return logger.warn("DEPRECATION NOTICE – bp.umm is deprecated and will be removed – Please see bp.renderers instead."),renderers}}),_context.next=82,modules._load(moduleDefinitions,this);case 82:return loadedModules=_context.sent,this.stats.track("bot","modules","loaded",loadedModules.length),_lodash2.default.assign(this,{_loadedModules:loadedModules}),skillsManager.registerSkillsFromModules(_lodash2.default.values(loadedModules)),_context.next=88,contentManager.init();case 88:notifications._bindEvents(),server=(0,_server2.default)(this),server.start().then(function(e){if(_this2.stopServer=e&&e.stop,_this2.hasInspectMode){var t=process.pid;"win32"===process.platform?process._debugProcess(t):process.kill(t,"SIGUSR1")}events.emit("ready");var r=!0,n=!1,o=void 0;try{for(var a,i=_lodash2.default.values(loadedModules)[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var u=a.value;u.handlers.ready&&u.handlers.ready(_this2,u.configuration,_helpers2.default)}}catch(e){n=!0,o=e}finally{try{!r&&i.return&&i.return()}finally{if(n)throw o}}var s=botfile.botUrl;logger.info(_chalk2.default.green.bold("Bot launched. Visit: "+s))}),middlewareAutoLoading=_lodash2.default.get(botfile,"middleware.autoLoading"),_lodash2.default.isNil(middlewareAutoLoading)||!1!==middlewareAutoLoading?middlewares.load():logger.debug("Middleware Auto Loading was disabled. Call bp.middlewares.load() manually."),projectEntry=eval("require")(projectLocation),"function"==typeof projectEntry?projectEntry.call(projectEntry,this):(logger.error("[FATAL] The bot entry point must be a function that takes an instance of bp"),process.exit(1)),process.on("uncaughtException",function(e){logger.error("[FATAL] An unhandled exception occurred in your bot",e),_util.isDeveloping&&logger.error(e.stack),_this2.stats.trackException(e.message),process.exit(1)}),process.on("unhandledRejection",function(e,t){logger.error("Unhandled Rejection in Promise: ",t,"Reason:",e),_this2.stats.trackException(e),_util.isDeveloping&&e&&e.stack&&logger.error(e.stack)});case 97:case"end":return _context.stop()}},_callee,this)}));function _start(){return _ref2.apply(this,arguments)}return _start}()},{key:"restart",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;setTimeout(function(){process.exit(RESTART_EXIT_CODE)},e)}},{key:"_setupEnv",value:function(){var e=_path2.default.resolve(this.projectLocation,".env");if(_fs2.default.existsSync(e)){var t=_dotenv2.default.parse(_fs2.default.readFileSync(e));for(var r in t)(_lodash2.default.isNil(process.env[r])||process.env.ENV_OVERLOAD)&&(process.env[r]=t[r])}}}]),botpress}();module.exports=botpress},function(module,exports,__webpack_require__){"use strict";var _path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_axios=__webpack_require__(12),_axios2=_interopRequireDefault(_axios),_util=__webpack_require__(3),_lodash=__webpack_require__(0),_lodash2=_interopRequireDefault(_lodash);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}var hostnameRegex=/^(http|https):\/\/(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9-]*[a-zA-Z0-9]).)*([A-Za-z]|[A-Za-z][A-Za-z0-9-]*[A-Za-z0-9])(:\d+)?$/gi;module.exports=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(token,options){var opts,projectPath,endpoint,filePath,packagePath,_eval,name,description,pairUrl,_ref2,data,_data$payload,botId,teamId,content,message;return regeneratorRuntime.wrap(function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(opts=options.opts(),projectPath=_path2.default.resolve("."),endpoint=opts.endpoint,token&&token.length){_context.next=5;break}return _context.abrupt("return",_util.print.error('Please provide a valid token. e.g. "botpress cloud-pair your-secret-token"'));case 5:if(hostnameRegex.test(endpoint)){_context.next=7;break}return _context.abrupt("return",_util.print.error('Invalid endpoint: "'+endpoint+"\". Endpoint must start with 'http' or 'https' and must not contain a trailing slash."));case 7:if(filePath=_path2.default.resolve(projectPath,"bp-cloud.json"),!_fs2.default.existsSync(filePath)){_context.next=10;break}return _context.abrupt("return",_util.print.error('This bot is already paired with Botpress Cloud. If you believe this is an error, delete this file and try again: "'+filePath+'"'));case 10:if(packagePath=_path2.default.resolve(projectPath,"package.json"),_fs2.default.existsSync(packagePath)){_context.next=13;break}return _context.abrupt("return",_util.print.error("This does not look like a valid project root. Please run this command at the root of your bot."));case 13:return _eval=eval("require")(packagePath),name=_eval.name,description=_eval.description,pairUrl=endpoint+"/api/pairing",_context.prev=15,_context.next=18,_axios2.default.post(pairUrl,{token:token,name:name,description:description});case 18:_ref2=_context.sent,data=_ref2.data,_data$payload=data.payload,botId=_data$payload.botId,teamId=_data$payload.teamId,content={botId:botId,teamId:teamId,token:token,endpoint:endpoint},_fs2.default.writeFileSync(filePath,JSON.stringify(content,null,2),"utf8"),_context.next=29;break;case 25:return _context.prev=25,_context.t0=_context.catch(15),message=_lodash2.default.get(_context.t0,"response.data.message")||_context.t0.message||"Unknown error",_context.abrupt("return",_util.print.error('Failed to pair the bot: "'+message+'"'));case 29:_util.print.success("Bot paired successfully");case 30:case"end":return _context.stop()}},_callee,void 0,[[15,25]])}));return function(e,t){return _ref.apply(this,arguments)}}()},function(e,t,r){"use strict";var n=c(r(1)),o=c(r(2)),a=c(r(9)),i=c(r(4)),u=c(r(8)),s=r(32);function c(e){return e&&e.__esModule?e:{default:e}}i.default.promisifyAll(o.default);var l=i.default.promisify(a.default);e.exports=function(e){var t=e.logger,r=e.projectLocation,a=(0,s.normalizeFolder)(r),c={};return t.info("[Ghost Content Manager] (transparent) Initialized"),{addRootFolder:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=a(e).normalizedFolderName;t.debug("[Ghost Content Manager] (transparent) Added root folder "+n+", doing nothing."),c[n]=r},upsertFile:function(e,r,i){var u=a(e).folderPath,s=n.default.join(u,r),c=n.default.dirname(s);return l(c).then(function(){return o.default.writeFileAsync(s,i)}).catch(function(e){throw t.error("[Ghost Content Manager] (transparent) upsertFile error",e),e})},readFile:function(e,r){var i=a(e),u=i.folderPath,s=i.normalizedFolderName,l=n.default.join(u,r),f=(c[s]||{}).isBinary||!1;return o.default.readFileAsync(l,f?null:"utf8").catch({code:"ENOENT"},function(){return null}).catch(function(e){throw t.error("[Ghost Content Manager] (transparent) readFile error",e),e})},deleteFile:function(e,r){var i=a(e).folderPath,u=n.default.join(i,r);return o.default.unlinkAsync(u).catch(function(e){throw t.error("[Ghost Content Manager] (transparent) deleteFile error",e),e})},directoryListing:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=a(e).folderPath;return o.default.accessAsync(s).then(function(){return i.default.fromCallback(function(e){return(0,u.default)("**/*"+r,{cwd:s},e)}).then(function(e){return e.filter(function(e){return!n.includes(e)})})},function(){return[]}).catch(function(e){throw t.error("[Ghost Content Manager] (transparent) directoryListing error",e),e})},getPending:function(){return{}},getPendingWithContent:function(){return{}}}}},function(e,t){e.exports=require("lodash/uniq")},function(e,t){e.exports=require("lodash/partition")},function(e,t){e.exports=require("prepend-file")},function(e,t){e.exports=require("username")},function(e,t,r){"use strict";var n=g(r(2)),o=g(r(1)),a=g(r(13)),i=g(r(4)),u=g(r(12)),s=g(r(20)),c=g(r(110)),l=g(r(109)),f=g(r(34)),d=r(3),p=r(33),h=r(36);function g(e){return e&&e.__esModule?e:{default:e}}function m(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _(e){return function(){var t=e.apply(this,arguments);return new i.default(function(e,r){return function n(o,a){try{var u=t[o](a),s=u.value}catch(e){return void r(e)}if(!u.done)return i.default.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}("next")})}}i.default.promisifyAll(n.default);var v,b,w=(v=_(regeneratorRuntime.mark(function e(t,r){var n,o,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,c.default)();case 2:return n=e.sent,o=a.default.hostname(),(u=[n,o].filter(Boolean).join("@"))&&(u=" by "+u),s="# Synced "+(new Date).toISOString()+u,e.abrupt("return",i.default.fromCallback(function(e){(0,l.default)(t,[s].concat(m(r),[""]).join("\n"),e)}));case 8:case"end":return e.stop()}},e,void 0)})),function(e,t){return v.apply(this,arguments)}),y=function(e){return t=_(regeneratorRuntime.mark(function t(r){var a,i=r.file,u=r.content,s=r.deleted;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.default.join(e,i),t.abrupt("return",s?n.default.unlinkAsync(a):n.default.writeFileAsync(a,u));case 2:case"end":return t.stop()}},t,void 0)})),function(e){return t.apply(this,arguments)};var t},x=function(e){return t=_(regeneratorRuntime.mark(function t(r,n){var a,u,s=r.files,c=r.revisions,l=r.binary;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.default.join(e,n),u=o.default.join(a,p.REVISIONS_FILE_NAME),t.next=4,w(u,c);case 4:return l&&s.forEach(function(e){e.content=Buffer.from(e.content,"base64")}),t.abrupt("return",i.default.each(s,y(a)));case 6:case"end":return t.stop()}},t,void 0)})),function(e,r){return t.apply(this,arguments)};var t};e.exports=(b=_(regeneratorRuntime.mark(function e(t){var r,n,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t.replace(/\/+$/,""),d.print.info("Checking your login status with "+t+"..."),e.next=4,(0,h.login)(t);case 4:if(r=e.sent){e.next=8;break}return d.print.warn("Login is required for this operation, exiting now."),e.abrupt("return");case 8:return n=void 0,e.prev=9,e.next=12,u.default.get(t+"/api/ghost_content/export",{headers:{authorization:"Bearer "+r}});case 12:a=e.sent,c=a.data,n=c,e.next=21;break;case 17:return e.prev=17,e.t0=e.catch(9),d.print.error(e.t0.message||"Unknown error","while fetching ghost content."),e.abrupt("return");case 21:if(n&&Object.keys(n).length){e.next=24;break}return d.print.info("No pending ghost revisions, nothing to be done here."),e.abrupt("return");case 24:return e.next=26,new s.default("\n  Running this command will override any untracked / uncommitted changes to the corresponding content files.\n  It is recommended that you use version control system (like git) and commit any changes before proceeding.\n  Are you sure you want to continue?\n  ").run();case 26:if(e.sent){e.next=29;break}return e.abrupt("return");case 29:return e.prev=29,e.next=32,i.default.props((0,f.default)(n,x(o.default.resolve("."))));case 32:d.print.success("\n    All content synced successfully. You now need to redeploy your bot with the updated content to finish the sync procedure.\n    If you're using version control system (like git) you should review the changes before committing.\n    Please don't forget to include (commit, deploy) "+p.REVISIONS_FILE_NAME+" file(s).\n    "),e.next=40;break;case 35:e.prev=35,e.t1=e.catch(29),d.print.error(e.t1.message||"Unknown error","while applying ghost content."),d.print.error("Your content files may be in inconsistent state."),d.print.error("It is recommended to reset the changes (like git reset) and try again.");case 40:case"end":return e.stop()}},e,void 0,[[9,17],[29,35]])})),function(e){return b.apply(this,arguments)})},function(e,t){e.exports=require("valid-url")},function(e,t,r){"use strict";var n,o=r(3),a=r(19),i=(n=a)&&n.__esModule?n:{default:n};e.exports=function(){var e=(0,i.default)(null,"./",null).listInstalled();e&&0!==e.length?((0,o.print)("info","There are "+e.length+" modules installed:"),e.forEach(function(e){return(0,o.print)(">> "+e)})):((0,o.print)("info","There are no module installed."),(0,o.print)("------------------"),(0,o.print)("info","To install modules, use `npm install --save <module-name>`"),(0,o.print)("info","You can discover modules in the Modules section of your bot UI. You can also search npm with the botpress keyword."))}},function(e,t,r){"use strict";var n=c(r(3)),o=c(r(14)),a=c(r(2)),i=c(r(1)),u=c(r(0)),s=c(r(4));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){if((0,o.default)({}).track("cli","migration",e),!a.default.existsSync("./botfile.js"))throw new Error("You must be inside a bot directory to run a migration");var t=u.default.sortBy(r(39).keys(),function(e){return e}),c=u.default.filter(t,function(t){return!!/.js$/i.test(t)&&parseFloat(e)<parseFloat(t.replace(/\.js/i,""))});return s.default.mapSeries(c,function(e){return r(39)("./"+e)(i.default.resolve(".")).then(function(){n.default.print("success","Migration "+e.replace(".js","")+" applied successfully")})}).finally(function(){n.default.print("success","Migration completed."),process.exit(0)})}},function(e,t,r){"use strict";var n,o,a=g(["===> {underline Installing dependencies, please wait...}"],["===> {underline Installing dependencies, please wait...}"]),i=g(["{green.bold Done!}"],["{green.bold Done!}"]),u=g(['\nDo you want to update {yellow "','"} to version {underline ',"}?"],['\nDo you want to update {yellow "','"} to version {underline ',"}?"]),s=h(r(20)),c=h(r(7)),l=h(r(1)),f=h(r(2)),d=r(21),p=(r(3),h(r(19)));function h(e){return e&&e.__esModule?e:{default:e}}function g(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function m(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}e.exports=(n=regeneratorRuntime.mark(function e(t){var r,n,o,h,g,_,v,b,w;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=t||"latest",r=(0,p.default)(null,"./",null),n=["botpress"].concat(m(r.listInstalled())),o="",h=!0,g=!1,_=void 0,e.prev=7,v=n[Symbol.iterator]();case 9:if(h=(b=v.next()).done){e.next=18;break}return w=b.value,e.next=13,new s.default((0,c.default)(u,w,t)).run();case 13:e.sent&&(o+=w+"@"+t+" ");case 15:h=!0,e.next=9;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(7),g=!0,_=e.t0;case 24:e.prev=24,e.prev=25,!h&&v.return&&v.return();case 27:if(e.prev=27,!g){e.next=30;break}throw _;case 30:return e.finish(27);case 31:return e.finish(24);case 32:o.length&&(console.log((0,c.default)(a)),f.default.existsSync(l.default.resolve("./yarn.lock"))?(0,d.execSync)("yarn add "+o):(0,d.execSync)("npm install --save "+o),console.log((0,c.default)(i)));case 33:case"end":return e.stop()}},e,void 0,[[7,20,24,32],[25,,27,31]])}),o=function(){var e=n.apply(this,arguments);return new Promise(function(t,r){return function n(o,a){try{var i=e[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});t(u)}("next")})},function(e){return o.apply(this,arguments)})},function(e,t,r){"use strict";var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=w(["\n{dim ---------------}\nThis tool will bootstrap a new {bold Botpress} module for you.\nFor more information or help, please visit {underline https://botpress.io/docs}\n{dim ---------------}"],["\n{dim ---------------}\nThis tool will bootstrap a new {bold Botpress} module for you.\nFor more information or help, please visit {underline https://botpress.io/docs}\n{dim ---------------}"]),a=w(["\n{green 🎉  Your module was successfully bootstraped!}\n\n{yellow Next steps:}\n  {yellow 1)} Install the dependencies by running {bold npm install} (or {bold yarn install})\n  {yellow 2)} Compile the module using {bold npm run compile} (or {bold yarn run compile})\n  {yellow 3)} Link the module to ease development and testing using {bold npm link}\n  {yellow 4)} Install the module in your testing bot using {bold npm install --save path/to/the/module}\n  {yellow 5)} Link the module using {bold npm link MODULE-NAME}\n\n{bold Enjoy Botpress!}\n"],["\n{green 🎉  Your module was successfully bootstraped!}\n\n{yellow Next steps:}\n  {yellow 1)} Install the dependencies by running {bold npm install} (or {bold yarn install})\n  {yellow 2)} Compile the module using {bold npm run compile} (or {bold yarn run compile})\n  {yellow 3)} Link the module to ease development and testing using {bold npm link}\n  {yellow 4)} Install the module in your testing bot using {bold npm install --save path/to/the/module}\n  {yellow 5)} Link the module using {bold npm link MODULE-NAME}\n\n{bold Enjoy Botpress!}\n"]),i=w(["\n{red Fatal Error} You need to run this command in an empty directory.\n"],["\n{red Fatal Error} You need to run this command in an empty directory.\n"]),u=w(["\n{red Fatal Error} Template {bold ","} not found.\n"],["\n{red Fatal Error} Template {bold ","} not found.\n"]),s=w(["{dim -> Copying ","}"],["{dim -> Copying ","}"]),c=(r(21),v(r(23))),l=v(r(7)),f=v(r(1)),d=v(r(9)),p=v(r(0)),h=v(r(2)),g=v(r(8)),m=v(r(4)),_=v(r(14));function v(e){return e&&e.__esModule?e:{default:e}}function b(e){return function(){var t=e.apply(this,arguments);return new m.default(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return m.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}function w(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var y,x,k=(0,l.default)(o),R=(0,l.default)(a),E=(0,l.default)(i),j=function(e){return(0,l.default)(s,e)},S=function(e){h.default.existsSync(e)&&(console.log(E),process.exit(1))},I=(y=b(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=f.default.join(__dirname,"cli/templates/"+t),h.default.existsSync||(console.log((o=t,(0,l.default)(u,o))),process.exit(1)),e.next=4,m.default.fromCallback(function(e){return(0,g.default)("**/*.*",{cwd:r,dot:!0},e)});case 4:return n=e.sent,e.abrupt("return",p.default.reduce(n,function(e,t){var n=f.default.join(r,t);return e[t]=h.default.readFileSync(n).toString(),e},{}));case 6:case"end":return e.stop()}var o},e,void 0)})),function(e){return y.apply(this,arguments)}),D=(x=b(regeneratorRuntime.mark(function e(t){var r,o,a,i,u,s,c,l,g,m,_,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,I("create-default");case 2:for(r=e.sent,o=!0,a=!1,i=void 0,e.prev=6,u=Object.entries(r)[Symbol.iterator]();!(o=(s=u.next()).done);o=!0)c=s.value,l=n(c,2),g=l[0],m=l[1],console.log(j(g)),_=p.default.template(m,{interpolate:/<%=([\s\S]+?)%>/g}),(v=f.default.dirname(g)).length&&d.default.sync(v),h.default.writeFileSync(g,_(t));e.next=14;break;case 10:e.prev=10,e.t0=e.catch(6),a=!0,i=e.t0;case 14:e.prev=14,e.prev=15,!o&&u.return&&u.return();case 17:if(e.prev=17,!a){e.next=20;break}throw i;case 20:return e.finish(17);case 21:return e.finish(14);case 22:console.log(R);case 23:case"end":return e.stop()}},e,void 0,[[6,10,14,22],[15,,17,21]])})),function(e){return x.apply(this,arguments)});e.exports=function(){console.log(k);var e=f.default.resolve("."),t=f.default.basename(e);(0,_.default)({}).track("cli","modules","create"),p.default.each(["package.json","botfile.js","index.js"],S);var r={properties:{name:{description:l.default.white("module name:"),pattern:/^(\@botpress\/|botpress-)[a-z0-9][a-z0-9-_\.]+$/,message:'Name must be only lowercase letters, digits, dashes, underscores and dots.\nIt must also start with "@botpress/" or "botpress-"',required:!0,default:t},description:{required:!1,description:l.default.white("description:")},author:{required:!1,description:l.default.white("author:")}}};c.default.message="",c.default.delimiter="",c.default.start(),c.default.get(r,function(e,t){D(t)})}},function(e,t){e.exports=require("monitorctrlc")},function(e,t){e.exports=require("nodemon")},function(e,t){e.exports=require("nanoid/generate")},function(e,t){e.exports=require("module")},function(module,exports,__webpack_require__){"use strict";var _os=__webpack_require__(13),_os2=_interopRequireDefault(_os),_path=__webpack_require__(1),_path2=_interopRequireDefault(_path),_fs=__webpack_require__(2),_fs2=_interopRequireDefault(_fs),_util=__webpack_require__(3),_util2=_interopRequireDefault(_util),_chalk=__webpack_require__(7),_chalk2=_interopRequireDefault(_chalk),_nodemon=__webpack_require__(118),_nodemon2=_interopRequireDefault(_nodemon),_monitorctrlc=__webpack_require__(117),_child_process=__webpack_require__(21);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var getPath=function(e){return"win32"===_os2.default.platform()?(0,_child_process.execSync)('@echo off && for %I in ("'+e+'") do echo %~sI').toString("utf8").replace(/(\n|\r)+$/,""):e};module.exports=function(projectPath,options){var Botpress=null;projectPath&&"string"==typeof projectPath||(projectPath="."),projectPath=_path2.default.resolve(projectPath);try{Botpress=eval("require")(_path2.default.join(projectPath,"node_modules","botpress")).Botpress()}catch(e){_util2.default.print("error",e.message),_util2.default.print("error",e.stack),_util2.default.print("error","(fatal) Could not load the local version of botpress"),_util2.default.print("Hint: 1) have you used `botpress init` to create a new bot the proper way?"),_util2.default.print("Hint: 2) Do you have read and write permissions on the current directory?"),_util2.default.print("-------------"),_util2.default.print("If none of the above works, this might be a bug in botpress. Please contact the Botpress Team on gitter and provide the printed error above."),process.exit(1)}var botfile=_path2.default.join(projectPath,"botfile.js");_fs2.default.existsSync(botfile)||(_util2.default.print("error","(fatal) No "+_chalk2.default.bold("botfile.js")+" file found at: "+botfile),process.exit(1));var getDefaultWatchIgnore=function getDefaultWatchIgnore(){var bf=eval("require")(botfile),dataDir=_util2.default.getDataLocation(bf.dataDir,projectPath);return[dataDir,"node_modules"]},opts=options.opts();if(opts.watch||opts.w){_util2.default.print("info","*** watching files for changes ***");var argvWithoutWatch=process.argv.filter(function(e){return!/^(--watch|-w)$/.test(e)});argvWithoutWatch[0]=getPath(argvWithoutWatch[0]);var nodemonOptions={cwd:process.cwd(),exec:argvWithoutWatch.join(" "),ext:opts.watchExt,watch:opts.watchDir&&opts.watchDir.length?opts.watchDir:void 0,ignore:opts.watchIgnore&&opts.watchIgnore.length?opts.watchIgnore:getDefaultWatchIgnore(),stdin:!1,restartable:!1},mon=(0,_nodemon2.default)(nodemonOptions);mon.on("restart",function(e,t){return _util2.default.print("info","*** restarting botpress because of file change: ",e)}),(0,_monitorctrlc.monitorCtrlC)(function(){mon.emit("quit"),setTimeout(function(){return process.exit()},100)})}else{var bot=new Botpress({botfile:botfile,options:options});bot.start()}}},function(e,t){e.exports=require("node-machine-id")},function(e,t){e.exports=require("universal-analytics")},function(e,t,r){"use strict";var n=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=x(["\n{dim ---------------}\nHey there 👋, thanks for using {bold Botpress}!\nWe'll walk you through the creation of your new bot.\nFor more information or help, please visit {underline https://botpress.io/docs}\n{dim ---------------}"],["\n{dim ---------------}\nHey there 👋, thanks for using {bold Botpress}!\nWe'll walk you through the creation of your new bot.\nFor more information or help, please visit {underline https://botpress.io/docs}\n{dim ---------------}"]),a=x(["\n{green 🎉  Your bot was initialized succesfully!}\n\n{yellow Next steps:}\n  {yellow 1)} Install bot dependencies by running {bold npm install} (or {bold yarn install})\n  {yellow 2)} Start the bot by running {bold npm start} (or {bold yarn start})\n\n{bold Enjoy Botpress!}\n"],["\n{green 🎉  Your bot was initialized succesfully!}\n\n{yellow Next steps:}\n  {yellow 1)} Install bot dependencies by running {bold npm install} (or {bold yarn install})\n  {yellow 2)} Start the bot by running {bold npm start} (or {bold yarn start})\n\n{bold Enjoy Botpress!}\n"]),i=x(["\n{red Fatal Error} You need to run this command in an empty directory.\n"],["\n{red Fatal Error} You need to run this command in an empty directory.\n"]),u=x(["\n{red Fatal Error} Directory {bold ","} already exists.\n"],["\n{red Fatal Error} Directory {bold ","} already exists.\n"]),s=x(["\n{red Fatal Error} Template {bold ","} not found.\n"],["\n{red Fatal Error} Template {bold ","} not found.\n"]),c=x(["\n{dim =============================}\nTemplate: {bold ","}\nAuthor: {dim ","}\nDescription: {dim ","}\nChannels: {yellow ","}\n{dim =============================}\n"],["\n{dim =============================}\nTemplate: {bold ","}\nAuthor: {dim ","}\nDescription: {dim ","}\nChannels: {yellow ","}\n{dim =============================}\n"]),l=x(["{dim -> Copying ","}"],["{dim -> Copying ","}"]),f=w(r(23)),d=w(r(7)),p=w(r(1)),h=w(r(9)),g=w(r(0)),m=w(r(2)),_=w(r(8)),v=w(r(4)),b=w(r(14));function w(e){return e&&e.__esModule?e:{default:e}}function y(e){return function(){var t=e.apply(this,arguments);return new v.default(function(e,r){return function n(o,a){try{var i=t[o](a),u=i.value}catch(e){return void r(e)}if(!i.done)return v.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}function x(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var k,R,E,j=(0,d.default)(o),S=(0,d.default)(a),I=(0,d.default)(i),D=function(e){return(0,d.default)(c,e.name,e.author,e.description,e.channels.join(", "))},P=function(e){return(0,d.default)(l,e)},O=function(e){m.default.existsSync(e)&&(console.log(I),process.exit(1))},C=(k=y(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=p.default.join(__dirname,"cli/templates/"+t),m.default.existsSync||(console.log((o=t,(0,d.default)(s,o))),process.exit(1)),e.next=4,v.default.fromCallback(function(e){return(0,_.default)("**/*.*",{cwd:r,dot:!0},e)});case 4:return n=e.sent,e.abrupt("return",g.default.reduce(n,function(e,t){var n=p.default.join(r,t);return e[t]=m.default.readFileSync(n).toString(),e},{}));case 6:case"end":return e.stop()}var o},e,void 0)})),function(e){return k.apply(this,arguments)}),q=(R=y(regeneratorRuntime.mark(function e(t){var r,o,a,i,u,s,c,l,f,d,_,v,b;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C("init-default");case 2:for(r=e.sent,o=JSON.parse(r["info.json"]),delete r["info.json"],console.log(D(o)),a=!0,i=!1,u=void 0,e.prev=9,s=Object.entries(r)[Symbol.iterator]();!(a=(c=s.next()).done);a=!0)l=c.value,f=n(l,2),d=f[0],_=f[1],console.log(P(d)),v=g.default.template(_,{interpolate:/<%=([\s\S]+?)%>/g}),(b=p.default.dirname(d)).length&&h.default.sync(b),m.default.writeFileSync(d,v(t));e.next=17;break;case 13:e.prev=13,e.t0=e.catch(9),i=!0,u=e.t0;case 17:e.prev=17,e.prev=18,!a&&s.return&&s.return();case 20:if(e.prev=20,!i){e.next=23;break}throw u;case 23:return e.finish(20);case 24:return e.finish(17);case 25:console.log(S);case 26:case"end":return e.stop()}},e,void 0,[[9,13,17,25],[18,,20,24]])})),function(e){return R.apply(this,arguments)});e.exports=(E=y(regeneratorRuntime.mark(function e(t,n){var o,a,i,s=n.yes;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log(j),!t){e.next=9;break}if(m.default.existsSync(t)){e.next=7;break}m.default.mkdirSync(t),process.chdir(t),e.next=9;break;case 7:return console.log((n=t,(0,d.default)(u,n))),e.abrupt("return",process.exit(1));case 9:o=r(41).version,(0,b.default)({}).track("cli","bot","init"),g.default.each(["package.json","botfile.js","index.js"],O),a=p.default.basename(p.default.resolve("./")),i={properties:{name:{description:d.default.white("name:"),pattern:/^[a-z0-9][a-z0-9-_\.]+$/,message:"name must be only lowercase letters, digits, dashes, underscores and dots.",required:!0,default:a},version:{required:!0,description:d.default.white("botpress version:"),default:o},description:{required:!1,description:d.default.white("description:")},author:{required:!1,description:d.default.white("author:")}}},s?q({name:a,version:o,description:"",author:""}):(f.default.message="",f.default.delimiter="",f.default.start(),f.default.get(i,function(e,t){e&&("canceled"!==e.message&&console.error(e),process.exit(1)),q(t)}));case 15:case"end":return e.stop()}var n},e,void 0)})),function(e,t){return E.apply(this,arguments)})},function(e,t){e.exports=require("commander")},function(e,t,r){"use strict";var n=h(r(125)),o=h(r(124)),a=h(r(121)),i=h(r(116)),u=h(r(115)),s=h(r(114)),c=h(r(113)),l=r(36),f=h(r(111)),d=h(r(105)),p=r(3);function h(e){return e&&e.__esModule?e:{default:e}}n.default.command("init [dirName]").description("Create a new bot in new directory (or in current directory if not provided)").option("-y, --yes","Say yes to every prompt and use default values").action(o.default);n.default.command("start [path]").alias("s").description("Starts running a bot").option("-w, --watch","Watch bot for changes, and restart automatically").option("--watchExt <extensions>",'When watching, which file extensions to watch. Default: ".js,.jsx,.json,.yml"',".js,.jsx,.json,.yml").option("--watchDir <dir>","When watching, what to watch. Can be repeated. Default: Directory of botfile.js",p.collectArgs,[]).option("--watchIgnore <file|dir>","When watching, what to ignore. Can be repeated. Default: dataDir, watchExt from botfile.js, and node_modules",p.collectArgs,[]).option("-i, --inspect",'Inspect bot with "debugger"').action(a.default),n.default.command("list").alias("ls").description("List installed modules").action(c.default),n.default.command("create").alias("c").description("Create a new module for development or distribution").action(i.default),n.default.command("update [version]").alias("up").description("Updates your bot and all the modules to a specific version").action(u.default),n.default.command("migrate <fromVersion>").description("Migrates the current bot from version X").action(s.default),n.default.command("login <bot-server-url>").description("Login to the given bot instance. Provide the full base URL for the bot, like https://mybot.herokuapp.com.").action(l.login),n.default.command("logout [bot-server-url]").description("Forget saved auth for the given bot instance, or all recorded auth tokens (if bot URL is not specified)").action(l.logout),n.default.command("ghost-sync <bot-server-url>").description("Pull the ghost content from the remote bot instance and apply it locally.").action(f.default),n.default.command("cloud-pair <api-token>").description("Pairs your local bot with the Botpress Cloud (supercharges your bot)").option("--endpoint <endpoint-url>",'Change the Botpress Cloud server endpoint. Default: "https://botpress.cloud"',"https://botpress.cloud").action(d.default),n.default.version((0,p.getBotpressVersion)()).description("Easily create, manage and extend chatbots.").parse(process.argv),n.default.args.length||n.default.help()},function(e,t){e.exports=require("babel-polyfill")},function(e,t,r){"use strict";global._babelPolyfill||r(127);var n=r(5);e.exports={Botpress:function(){return r(104)},DatabaseHelpers:n,CLI:function(){return r(126)}}},function(e,t,r){e.exports=r(128)}]);
//# sourceMappingURL=node.bundle.js.map