{"version":3,"sources":["webpack:///webpack/bootstrap 38d3445a0d01d2d9b7e6","webpack:///external \"lodash\"","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///./src/db.js","webpack:///external \"bluebird\"","webpack:///external \"moment\"","webpack:///external \"botpress\"","webpack:///external \"path\"","webpack:///external \"fs\""],"names":["db","config","incomingMiddleware","event","next","includes","type","getUserSession","then","session","is_new_session","bp","events","emit","appendMessageToSession","id","message","paused","logger","debug","text","outgoingMiddleware","module","exports","sessionExpiry","default","env","init","configurator","botpressPath","middlewares","register","name","order","handler","description","loadAll","get","knex","initialize","ready","hitl","pause","platform","userId","setSessionPaused","sessionId","unpause","isPaused","isSessionPaused","router","getRouter","req","res","getAllSessions","query","onlyPaused","send","sessions","getSessionData","params","messages","post","body","getSession","raw","to","user","sendOutgoing","sendStatus","where","select","limit","users","length","createUserSession","Error","createTableIfNotExists","table","increments","primary","string","timestamp","boolean","integer","references","onDelete","jsonb","enu","profileUrl","full_name","Math","random","toString","substr","first_name","last_name","profile_pic","picture_url","user_image_url","last_event_on","date","now","last_heard_on","paused_trigger","insert","returning","results","Object","assign","db_session","toPlainObject","object","mapValues","v","sql","direction","session_id","raw_message","ts","update","trigger","parseInt","toBool","bool","parse","s","condition","true","from","groupBy","as","join","whereRaw","orderBy","total","k"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/home/epaminond/private/projects/2015.08.08_keenethics/projects/botpress/botpress/packages/functionals/botpress-hitl\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 38d3445a0d01d2d9b7e6","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","import checkVersion from 'botpress-version-manager'\nimport DB from './db'\nimport _ from 'lodash'\nimport path from 'path'\nimport fs from 'fs'\n\n// TODO: Cleanup old sessions\n// TODO: If messages count > X, delete some\n\nlet db = null\nlet config = null\n\nconst incomingMiddleware = (event, next) => {\n  if (!db) {\n    return next()\n  }\n\n  if (_.includes(['delivery', 'read'], event.type)) {\n    return next()\n  }\n\n  return db.getUserSession(event).then(session => {\n    if (!session) {\n      return next()\n    }\n\n    if (session.is_new_session) {\n      event.bp.events.emit('hitl.session', session)\n    }\n\n    return db.appendMessageToSession(event, session.id, 'in').then(message => {\n      event.bp.events.emit('hitl.message', message)\n      if ((!!session.paused || config.paused) && _.includes(['text', 'message'], event.type)) {\n        event.bp.logger.debug('[hitl] Session paused, message swallowed:', event.text)\n        // the session or bot is paused, swallow the message\n        return\n      } else {\n        next()\n      }\n    })\n  })\n}\n\nconst outgoingMiddleware = (event, next) => {\n  if (!db) {\n    return next()\n  }\n\n  return db.getUserSession(event).then(session => {\n    if (!session) {\n      return next()\n    }\n\n    if (session.is_new_session) {\n      event.bp.events.emit('hitl.session', session)\n    }\n\n    return db.appendMessageToSession(event, session.id, 'out').then(message => {\n      event.bp.events.emit('hitl.message', message)\n      next()\n    })\n  })\n}\n\nmodule.exports = {\n  config: {\n    sessionExpiry: { type: 'string', default: '3 days' },\n    paused: { type: 'bool', default: false, env: 'BOTPRESS_HITL_PAUSED' }\n  },\n\n  init: async (bp, configurator) => {\n    checkVersion(bp, bp.botpressPath)\n\n    bp.middlewares.register({\n      name: 'hitl.captureInMessages',\n      type: 'incoming',\n      order: 2,\n      handler: incomingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures incoming messages and if the session if paused, swallow the event.'\n    })\n\n    bp.middlewares.register({\n      name: 'hitl.captureOutMessages',\n      type: 'outgoing',\n      order: 50,\n      handler: outgoingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures outgoing messages to show inside HITL.'\n    })\n\n    config = await configurator.loadAll()\n\n    bp.db\n      .get()\n      .then(knex => (db = DB(knex)))\n      .then(() => db.initialize())\n  },\n\n  ready: function(bp) {\n    bp.hitl = {\n      pause: (platform, userId) => {\n        return db.setSessionPaused(true, platform, userId, 'code').then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n        })\n      },\n      unpause: (platform, userId) => {\n        return db.setSessionPaused(false, platform, userId, 'code').then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n        })\n      },\n      isPaused: (platform, userId) => {\n        return db.isSessionPaused(platform, userId)\n      }\n    }\n\n    const router = bp.getRouter('botpress-hitl')\n\n    router.get('/sessions', (req, res) => {\n      db.getAllSessions(req.query.onlyPaused === 'true').then(sessions => res.send(sessions))\n    })\n\n    router.get('/sessions/:sessionId', (req, res) => {\n      db.getSessionData(req.params.sessionId).then(messages => res.send(messages))\n    })\n\n    router.post('/sessions/:sessionId/message', (req, res) => {\n      const { message } = req.body\n\n      db.getSession(req.params.sessionId).then(async session => {\n        const event = {\n          type: 'text',\n          platform: session.platform,\n          raw: { to: session.userId, message: message },\n          user: { id: session.userId },\n          text: message\n        }\n\n        await bp.middlewares.sendOutgoing(event)\n\n        res.sendStatus(200)\n      })\n    })\n\n    // TODO post /sessions/:id/typing\n\n    router.post('/sessions/:sessionId/pause', (req, res) => {\n      db\n        .setSessionPaused(true, null, null, 'operator', req.params.sessionId)\n        .then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n        })\n        .then(res.sendStatus(200))\n    })\n\n    router.post('/sessions/:sessionId/unpause', (req, res) => {\n      db\n        .setSessionPaused(false, null, null, 'operator', req.params.sessionId)\n        .then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n        })\n        .then(res.sendStatus(200))\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 3\n// module chunks = 0","import Promise from 'bluebird'\nimport moment from 'moment'\nimport _ from 'lodash'\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nlet knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n\n  return helpers(knex)\n    .createTableIfNotExists('hitl_sessions', function(table) {\n      table.increments('id').primary()\n      table.string('platform')\n      table.string('userId')\n      table.string('full_name')\n      table.string('user_image_url')\n      table.timestamp('last_event_on')\n      table.timestamp('last_heard_on')\n      table.boolean('paused')\n      table.string('paused_trigger')\n    })\n    .then(function() {\n      return helpers(knex).createTableIfNotExists('hitl_messages', function(table) {\n        table.increments('id').primary()\n        table\n          .integer('session_id')\n          .references('hitl_sessions.id')\n          .onDelete('CASCADE')\n        table.string('type')\n        table.string('text')\n        table.jsonb('raw_message')\n        table.enu('direction', ['in', 'out'])\n        table.timestamp('ts')\n      })\n    })\n}\n\nfunction createUserSession(event) {\n  let profileUrl = null\n  let full_name =\n    '#' +\n    Math.random()\n      .toString()\n      .substr(2)\n\n  if (event.user && event.user.first_name && event.user.last_name) {\n    profileUrl = event.user.profile_pic || event.user.picture_url\n    full_name = event.user.first_name + ' ' + event.user.last_name\n  }\n\n  const session = {\n    platform: event.platform,\n    userId: event.user.id,\n    user_image_url: profileUrl,\n    last_event_on: helpers(knex).date.now(),\n    last_heard_on: helpers(knex).date.now(),\n    paused: 0,\n    full_name: full_name,\n    paused_trigger: null\n  }\n\n  return knex('hitl_sessions')\n    .insert(session)\n    .returning('id')\n    .then(results => {\n      session.id = results[0]\n      session.is_new_session = true\n    })\n    .then(() =>\n      knex('hitl_sessions')\n        .where({ id: session.id })\n        .then()\n        .get(0)\n    )\n    .then(db_session => Object.assign({}, session, db_session))\n}\n\nasync function getUserSession(event) {\n  const userId = (event.user && event.user.id) || event.raw.to\n\n  if (!userId) {\n    return null\n  }\n\n  return knex('hitl_sessions')\n    .where({ platform: event.platform, userId: userId })\n    .select('*')\n    .limit(1)\n    .then(users => {\n      if (!users || users.length === 0) {\n        return createUserSession(event)\n      } else {\n        return users[0]\n      }\n    })\n}\n\nfunction getSession(sessionId) {\n  return knex('hitl_sessions')\n    .where({ id: sessionId })\n    .select('*')\n    .limit(1)\n    .then(users => {\n      if (!users || users.length === 0) {\n        return null\n      } else {\n        return users[0]\n      }\n    })\n}\n\nfunction toPlainObject(object) {\n  // trims SQL queries from objects\n  return _.mapValues(object, v => {\n    return v.sql ? v.sql : v\n  })\n}\n\nfunction appendMessageToSession(event, sessionId, direction) {\n  const message = {\n    session_id: sessionId,\n    type: event.type,\n    text: event.text,\n    raw_message: event.raw,\n    direction: direction,\n    ts: helpers(knex).date.now()\n  }\n\n  const update = { last_event_on: helpers(knex).date.now() }\n\n  if (direction === 'in') {\n    update.last_heard_on = helpers(knex).date.now()\n  }\n\n  return knex('hitl_messages')\n    .insert(message)\n    .then(() => {\n      return knex('hitl_sessions')\n        .where({ id: sessionId })\n        .update(update)\n        .then(() => toPlainObject(message))\n    })\n}\n\nfunction setSessionPaused(paused, platform, userId, trigger, sessionId = null) {\n  if (sessionId) {\n    return knex('hitl_sessions')\n      .where({ id: sessionId })\n      .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n      .then(() => parseInt(sessionId))\n  } else {\n    return knex('hitl_sessions')\n      .where({ userId, platform })\n      .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n      .then(() => {\n        return knex('hitl_sessions')\n          .where({ userId, platform })\n          .select('id')\n      })\n      .then(sessions => parseInt(sessions[0].id))\n  }\n}\n\nfunction isSessionPaused(platform, userId, sessionId = null) {\n  const toBool = s => helpers(knex).bool.parse(s)\n\n  if (sessionId) {\n    return knex('hitl_sessions')\n      .where({ id: sessionId })\n      .select('paused')\n      .then()\n      .get(0)\n      .then(s => s && toBool(s.paused))\n  } else {\n    return knex('hitl_sessions')\n      .where({ userId, platform })\n      .select('paused')\n      .then()\n      .get(0)\n      .then(s => s && toBool(s.paused))\n  }\n}\n\nfunction getAllSessions(onlyPaused) {\n  let condition = ''\n\n  if (onlyPaused === true) {\n    condition = 'hitl_sessions.paused = ' + helpers(knex).bool.true()\n  }\n\n  return knex\n    .select('*')\n    .from(function() {\n      this.select([knex.raw('max(id) as mId'), 'session_id', knex.raw('count(*) as count')])\n        .from('hitl_messages')\n        .groupBy('session_id')\n        .as('q1')\n    })\n    .join('hitl_messages', knex.raw('q1.mId'), 'hitl_messages.id')\n    .join('hitl_sessions', knex.raw('q1.session_id'), 'hitl_sessions.id')\n    .whereRaw(condition)\n    .orderBy('hitl_sessions.last_event_on', 'desc')\n    .limit(100)\n    .then(results => ({\n      total: 0,\n      sessions: results\n    }))\n}\n\nfunction getSessionData(sessionId) {\n  return knex('hitl_sessions')\n    .where({ session_id: sessionId })\n    .join('hitl_messages', 'hitl_messages.session_id', 'hitl_sessions.id')\n    .orderBy('hitl_messages.id', 'desc')\n    .limit(100)\n    .select('*')\n    .then(messages => _.orderBy(messages, ['id'], ['asc']))\n}\n\nmodule.exports = k => {\n  knex = k\n\n  return {\n    initialize,\n    getUserSession,\n    setSessionPaused,\n    appendMessageToSession,\n    getAllSessions,\n    getSessionData,\n    getSession,\n    isSessionPaused\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}