{"version":3,"sources":["webpack:///webpack/bootstrap c911b424ebed5cf863c0","webpack:///external \"lodash\"","webpack:///external \"moment\"","webpack:///external \"bluebird\"","webpack:///./src/db.js","webpack:///./src/util.js","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"botpress\"","webpack:///external \"later\"","webpack:///external \"cronstrue\"","webpack:///external \"validate-arguments\"","webpack:///./src/daemon.js"],"names":["Validate","require","module","exports","bootstrap","bp","db","get","then","initialize","create","id","options","knex","update","updateTask","taskId","status","logs","returned","delete","remove","deleteDone","listUpcoming","listPrevious","listExpired","scheduleNext","time","reviveAllExecuting","createTableIfNotExists","table","string","primary","boolean","timestamp","increments","references","onDelete","unique","String","Math","random","validateCreateOptions","schedule_human","getHumanExpression","schedule_type","schedule","firstOccurence","getNextOccurence","toDate","insert","created_on","date","now","enabled","Promise","resolve","where","includes","finishedOn","del","deleteScheduled","join","dt","whereRaw","isBefore","andWhere","select","scheduleId","coeff","rounded","Date","round","getTime","ts","format","scheduledOn","whereNotNull","args","named","action","isValid","errorString","validateExpression","pick","validateModifyOptions","cronstrue","type","exp","toLowerCase","toString","localTime","sched1","parse","cron","next1","next","sched2","text","next2","Error","fromNow","config","init","botpressPath","d","revive","start","ready","router","getRouter","catchError","message","err","res","send","req","sortBy","schedules","map","s","scheduleOn","catch","put","body","events","emit","post","sendStatus","query","scheduler","add","scheduleType","timerInterval","lock","daemon","createDaemon","reschedule","task","nextOccurence","runSingleTask","expired","result","logger","debug","AsyncFunction","eval","fn","fromDate","untilDate","logsQuery","from","until","limit","order","fields","fromCallback","callback","flattenLogs","file","x","_run","rescheduled","list","mapSeries","error","stack","notifications","level","finally","run","clearInterval","setInterval","stop"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/home/epaminond/private/projects/2015.08.08_keenethics/projects/botpress/botpress/packages/functionals/botpress-scheduler\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap c911b424ebed5cf863c0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 2\n// module chunks = 0","import _ from 'lodash'\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nconst Validate = require('validate-arguments')\n\nimport util from './util.js'\n\nmodule.exports = bp => {\n  return {\n    bootstrap: () => {\n      return bp.db.get().then(initialize)\n    },\n    create: (id, options) => {\n      return bp.db.get().then(knex => create(knex, id, options))\n    },\n    update: (id, options) => {\n      return bp.db.get().then(knex => update(knex, id, options))\n    },\n    updateTask: (taskId, status, logs, returned) => {\n      return bp.db.get().then(knex => updateTask(knex, taskId, status, logs, returned))\n    },\n    delete: id => {\n      return bp.db.get().then(knex => remove(knex, id))\n    },\n    deleteDone: () => {\n      return bp.db.get().then(knex => deleteDone(knex))\n    },\n    listUpcoming: () => {\n      return bp.db.get().then(knex => listUpcoming(knex))\n    },\n    listPrevious: () => {\n      return bp.db.get().then(knex => listPrevious(knex))\n    },\n    listExpired: () => {\n      return bp.db.get().then(knex => listExpired(knex))\n    },\n    scheduleNext: (id, time) => {\n      return bp.db.get().then(knex => scheduleNext(knex, id, time))\n    },\n    reviveAllExecuting: () => {\n      return bp.db.get().then(knex => reviveAllExecuting(knex))\n    }\n  }\n}\n\nfunction initialize(knex) {\n  return helpers(knex)\n    .createTableIfNotExists('scheduler_schedules', function(table) {\n      table.string('id').primary()\n      table.boolean('enabled')\n      table.string('schedule_type')\n      table.string('schedule')\n      table.string('schedule_human')\n      table.timestamp('created_on')\n      table.string('action')\n    })\n    .then(function() {\n      return helpers(knex).createTableIfNotExists('scheduler_tasks', function(table) {\n        table.increments('id')\n        table\n          .string('scheduleId')\n          .references('scheduler_schedules.id')\n          .onDelete('CASCADE')\n        table.timestamp('scheduledOn')\n        table.string('status')\n        table.string('logs')\n        table.timestamp('finishedOn')\n        table.string('returned')\n        table.unique(['scheduleId', 'scheduledOn'])\n      })\n    })\n}\n\nfunction create(knex, id, options) {\n  id = id || String(Math.random() * 100000000000000000000) // TODO: avoid possible duplicates\n  options = validateCreateOptions(options)\n\n  options.schedule_human = util.getHumanExpression(options.schedule_type, options.schedule)\n\n  const firstOccurence = util.getNextOccurence(options.schedule_type, options.schedule).toDate()\n\n  return knex('scheduler_schedules')\n    .insert({\n      id,\n      created_on: helpers(knex).date.now(),\n      ...options\n    })\n    .then(() => {\n      if (options.enabled) {\n        return scheduleNext(knex, id, firstOccurence)\n      }\n    })\n    .then(() => Promise.resolve(id))\n}\n\nfunction update(knex, id, options) {\n  options = validateCreateOptions(options)\n\n  return knex('scheduler_schedules')\n    .where({ id })\n    .update({ ...options })\n    .then()\n}\n\nfunction updateTask(knex, taskId, status, logs, returned) {\n  const options = { status, logs, returned }\n\n  if (_.includes(['done', 'error', 'skipped'], status)) {\n    options.finishedOn = helpers(knex).date.now()\n  }\n\n  return knex('scheduler_tasks')\n    .where({ id: taskId })\n    .update(options)\n    .then()\n}\n\nfunction reviveAllExecuting(knex) {\n  return knex('scheduler_tasks')\n    .where({ status: 'executing' })\n    .update({ status: 'pending' })\n    .then()\n}\n\nfunction remove(knex, id) {\n  return knex('scheduler_schedules')\n    .where({ id })\n    .del()\n    .then(() => deleteScheduled(knex, id))\n}\n\nfunction listUpcoming(knex) {\n  return knex('scheduler_tasks')\n    .where({ status: 'pending' })\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n    .then()\n}\n\nfunction listPrevious(knex) {\n  const dt = helpers(knex).date\n\n  return knex('scheduler_tasks')\n    .whereRaw(dt.isBefore('scheduledOn', dt.now()))\n    .andWhere('status', '!=', 'pending')\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n    .then()\n}\n\nfunction listExpired(knex) {\n  const dt = helpers(knex).date\n\n  return knex('scheduler_tasks')\n    .whereRaw(dt.isBefore('scheduledOn', dt.now()))\n    .andWhere('status', '=', 'pending')\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n    .select(['scheduler_tasks.id as taskId', '*'])\n    .then()\n}\n\nfunction deleteScheduled(knex, id) {\n  return knex('scheduler_tasks')\n    .where({ scheduleId: id })\n    .del()\n    .then()\n}\n\nfunction scheduleNext(knex, id, time) {\n  // Round the time to the nearest 2 seconds\n  const coeff = 1000 * 2\n  const rounded = new Date(Math.round(time.getTime() / coeff) * coeff)\n\n  const ts = helpers(knex).date.format(rounded)\n\n  return knex('scheduler_tasks')\n    .insert({\n      scheduleId: id,\n      scheduledOn: ts,\n      status: 'pending'\n    })\n    .then()\n}\n\nfunction deleteDone(knex) {\n  return knex('scheduler_tasks')\n    .whereNotNull('finishedOn')\n    .del()\n    .then()\n}\n\nfunction validateCreateOptions(options) {\n  const args = Validate.named(options, {\n    enabled: 'boolean',\n    schedule_type: 'string',\n    schedule: 'string',\n    action: 'string'\n  })\n\n  if (!args.isValid()) {\n    throw args.errorString()\n  }\n\n  util.validateExpression(options.schedule_type, options.schedule)\n\n  return _.pick(options, ['enabled', 'schedule_type', 'schedule', 'action'])\n}\n\nfunction validateModifyOptions(options) {\n  const args = Validate.named(options, {\n    enabled: 'boolean',\n    action: 'string'\n  })\n\n  if (!args.isValid()) {\n    throw args.errorString()\n  }\n\n  return _.pick(options, ['enabled', 'action'])\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","import moment from 'moment'\nimport later from 'later'\nimport _ from 'lodash'\n\nconst cronstrue = require('cronstrue')\n\nconst getNextOccurence = (type, exp) => {\n  switch (type.toLowerCase()) {\n    case 'cron':\n      cronstrue.toString(exp) // Validation\n      later.date.localTime()\n      const sched1 = later.parse.cron(exp)\n      const next1 = later.schedule(sched1).next(2, new Date())[0]\n      return moment(new Date(next1))\n    case 'natural':\n      later.date.localTime()\n      const sched2 = later.parse.text(exp)\n      const next2 = later.schedule(sched2).next(2, new Date())[1]\n      return moment(new Date(next2))\n    case 'once':\n      return moment(new Date(exp))\n  }\n}\n\nconst validateExpression = (type, exp) => {\n  if (!_.includes(['cron', 'natural', 'once'], type.toLowerCase())) {\n    throw new Error('Invalid expression type: ' + type)\n  }\n\n  getNextOccurence(type, exp)\n}\n\nconst getHumanExpression = (type, exp) => {\n  switch (type.toLowerCase()) {\n    case 'cron':\n      return cronstrue.toString(exp)\n    case 'once':\n      return 'Once, ' + moment(new Date(exp)).fromNow()\n    case 'natural':\n      return exp\n    default:\n      throw new Error('Unknown type: ' + type)\n  }\n}\n\nmodule.exports = { getNextOccurence, validateExpression, getHumanExpression }\n\n\n\n// WEBPACK FOOTER //\n// ./src/util.js","import checkVersion from 'botpress-version-manager'\n\nimport moment from 'moment'\nimport _ from 'lodash'\nimport Promise from 'bluebird'\n\nimport db from './db'\nimport daemon from './daemon'\n\nmodule.exports = {\n  config: {},\n\n  init: async function(bp) {\n    checkVersion(bp, bp.botpressPath)\n\n    await db(bp).bootstrap()\n    const d = daemon(bp)\n    await d.revive()\n    d.start()\n  },\n\n  ready: function(bp) {\n    const router = bp.getRouter('botpress-scheduler')\n\n    const catchError = res => err => {\n      const message = typeof err === 'string' ? err : err.message\n      res.status(500).send({ message })\n    }\n\n    router.get('/schedules/upcoming', (req, res) => {\n      db(bp)\n        .listUpcoming()\n        .then(schedules => {\n          res.send(\n            _.sortBy(schedules, 'scheduledOn').map(s => {\n              s.scheduleOn = moment(s.scheduledOn).format()\n              s.enabled = !!s.enabled\n              return s\n            })\n          )\n        })\n        .catch(catchError(res))\n    })\n\n    router.get('/schedules/past', (req, res) => {\n      db(bp)\n        .listPrevious()\n        .then(schedules => {\n          res.send(\n            _.sortBy(schedules, s => -s.scheduledOn).map(s => {\n              s.scheduleOn = moment(s.scheduledOn).format()\n              s.enabled = !!s.enabled\n              return s\n            })\n          )\n        })\n        .catch(catchError(res))\n    })\n\n    router.put('/schedules', (req, res) => {\n      db(bp)\n        .create(req.body.id, req.body)\n        .then(schedules => {\n          res.send(schedules)\n          bp.events.emit('scheduler.update')\n        })\n        .catch(catchError(res))\n    })\n\n    router.post('/schedules', (req, res) => {\n      db(bp)\n        .update(req.body.id, req.body)\n        .then(() => {\n          res.sendStatus(200)\n          bp.events.emit('scheduler.update')\n        })\n        .catch(catchError(res))\n    })\n\n    router.delete('/schedules', (req, res) => {\n      db(bp)\n        .delete(req.query.id)\n        .then(() => {\n          res.sendStatus(200)\n          bp.events.emit('scheduler.update')\n        })\n        .catch(catchError(res))\n    })\n\n    router.delete('/done', (req, res) => {\n      db(bp)\n        .deleteDone()\n        .then(() => {\n          res.sendStatus(200)\n          bp.events.emit('scheduler.update')\n        })\n        .catch(catchError(res))\n    })\n\n    bp.scheduler = {\n      /**\n       * Adds schedule record and returns promise with id of the record inserted\n       * @param  {string} params.schedule dateTime action will be executed\n       * @param  {string} params.action string that will be executed\n       * @param  {string} [params.id] the unique id of the schedule (if not provided will be generated automatically)\n       * @param  {boolean} [params.enabled=true] optional flag specifying whether this task is enabled\n       * @param  {string} [scheduleType='once'] type of the scheduler: 'once', 'cron' or 'natural'\n       */\n      add: ({ id, schedule, action, enabled = true, scheduleType = 'once' }) =>\n        db(bp)\n          .create(id, { schedule, action, enabled, schedule_type: scheduleType })\n          .then(() => bp.events.emit('scheduler.update')),\n      /**\n       * Removes schedule record and returns promise with boolean showing whether delete was successful\n       * @param  {string} id the id of the schedule to remove\n       */\n      remove: id =>\n        db(bp)\n          .delete(id)\n          .then(() => bp.events.emit('scheduler.update'))\n    }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"later\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"later\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"cronstrue\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cronstrue\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"validate-arguments\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"validate-arguments\"\n// module id = 11\n// module chunks = 0","import Promise from 'bluebird'\n\nimport db from './db'\nimport util from './util'\nlet timerInterval = null\nlet lock = false\nlet daemon = null\n\nconst createDaemon = bp => {\n  const reschedule = task => {\n    if (task.schedule_type.toLowerCase() === 'once') {\n      return Promise.resolve(null)\n    }\n\n    const nextOccurence = util.getNextOccurence(task.schedule_type, task.schedule).toDate()\n\n    return db(bp).scheduleNext(task.id, nextOccurence)\n  }\n\n  const runSingleTask = async expired => {\n    await db(bp).updateTask(expired.taskId, 'executing', null, null)\n\n    let result = null\n\n    if (!expired.enabled) {\n      bp.logger.debug('[scheduler] Skipped task ' + expired.taskId + '. Reason=disabled')\n      await db(bp).updateTask(expired.taskId, 'skipped', null, null)\n      return\n    }\n\n    const AsyncFunction = eval('Object.getPrototypeOf(async function() {}).constructor') // eslint-disable-line no-eval\n    const fn = new AsyncFunction('bp', 'task', expired.action)\n\n    bp.events.emit('scheduler.update')\n    bp.events.emit('scheduler.started', expired)\n\n    const fromDate = new Date()\n    result = await fn(bp, expired)\n    const untilDate = new Date()\n\n    const returned = (result && result.toString && result.toString()) || result\n\n    const logsQuery = {\n      from: fromDate,\n      until: untilDate,\n      limit: 1000,\n      start: 0,\n      order: 'desc',\n      fields: ['message']\n    }\n\n    const logs = await Promise.fromCallback(callback => bp.logger.query(logsQuery, callback))\n\n    const flattenLogs = ((logs && logs.file && logs.file.map(x => x.message)) || []).join('\\n')\n\n    await db(bp).updateTask(expired.taskId, 'done', flattenLogs, returned)\n\n    bp.events.emit('scheduler.update')\n    bp.events.emit('scheduler.finished', expired)\n  }\n\n  const _run = async () => {\n    const rescheduled = {}\n    const list = await db(bp).listExpired()\n\n    return Promise.mapSeries(list, expired => {\n      return runSingleTask(expired)\n        .catch(err => {\n          bp.logger.error('[scheduler]', err.message, err.stack)\n          bp.notifications.send({\n            message:\n              'An error occured while running task: ' + expired.taskId + '. Please check the logs for more info.',\n            level: 'error'\n          })\n          return db(bp).updateTask(expired.taskId, 'error', null, null)\n        })\n        .finally(async () => {\n          if (!rescheduled[expired.taskId]) {\n            await reschedule(expired)\n            rescheduled[expired.taskId] = true\n          }\n        })\n    })\n  }\n\n  const run = () => {\n    if (lock === true) {\n      return\n    }\n\n    lock = true\n    return _run().finally(() => {\n      lock = false\n    })\n  }\n\n  const revive = () => db(bp).reviveAllExecuting()\n\n  const start = () => {\n    clearInterval(timerInterval)\n    timerInterval = setInterval(run, 5000)\n  }\n\n  const stop = () => clearInterval(timerInterval)\n\n  return { start, stop, revive }\n}\n\nmodule.exports = bp => {\n  if (!daemon) {\n    daemon = createDaemon(bp)\n  }\n\n  return daemon\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/daemon.js"],"sourceRoot":""}